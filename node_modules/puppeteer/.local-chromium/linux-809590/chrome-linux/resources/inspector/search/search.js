import{Revealer as e,UIString as t,Settings as s,Progress as i}from"../common/common.js";import{Linkifier as n}from"../components/components.js";import{TextRange as h}from"../text_utils/text_utils.js";import{Widget as r,TreeOutline as a,ARIAUtils as c,UIUtils as o,HistoryInput as l,Toolbar as _,ProgressIndicator as u,EmptyWidget as d,KeyboardShortcut as g}from"../ui/ui.js";class p{constructor(e,t,s){this._query=e,this._ignoreCase=t,this._isRegex=s,this._parse()}static fromPlainObject(e){return new p(e.query,e.ignoreCase,e.isRegex)}query(){return this._query}ignoreCase(){return this._ignoreCase}isRegex(){return this._isRegex}toPlainObject(){return{query:this.query(),ignoreCase:this.ignoreCase(),isRegex:this.isRegex()}}_parse(){const e=/(\s*(?!-?f(ile)?:)[^\\ ]|\\.)+/,t=e.source+"(\\s+"+e.source+")*",s=["(\\s*"+m.source+"\\s*)","("+/"([^\\"]|\\.)+"/.source+")","("+t+")"].join("|"),i=new RegExp(s,"g"),n=this._query.match(i)||[];this._fileQueries=[],this._queries=[];for(let e=0;e<n.length;++e){const t=n[e];if(!t)continue;const s=this._parseFileQuery(t);if(s)this._fileQueries.push(s),this._fileRegexQueries=this._fileRegexQueries||[],this._fileRegexQueries.push({regex:new RegExp(s.text,this.ignoreCase?"i":""),isNegative:s.isNegative});else if(this._isRegex)this._queries.push(t);else if(t.startsWith('"')){if(!t.endsWith('"'))continue;this._queries.push(this._parseQuotedQuery(t))}else this._queries.push(this._parseUnquotedQuery(t))}}filePathMatchesFileQuery(e){if(!this._fileRegexQueries)return!0;for(let t=0;t<this._fileRegexQueries.length;++t)if(!!e.match(this._fileRegexQueries[t].regex)===this._fileRegexQueries[t].isNegative)return!1;return!0}queries(){return this._queries}_parseUnquotedQuery(e){return e.replace(/\\(.)/g,"$1")}_parseQuotedQuery(e){return e.substring(1,e.length-1).replace(/\\(.)/g,"$1")}_parseFileQuery(e){const t=e.match(m);if(!t)return null;const s=!!t[1];e=t[3];let i="";for(let t=0;t<e.length;++t){const s=e[t];if("*"===s)i+=".*";else if("\\"===s){++t;" "===e[t]&&(i+=" ")}else-1!==String.regexSpecialCharacters().indexOf(e.charAt(t))&&(i+="\\"),i+=e.charAt(t)}return new S(i,s)}}const m=/(-)?f(ile)?:((?:[^\\ ]|\\.)+)/;class S{constructor(e,t){this.text=e,this.isNegative=t}}var C=Object.freeze({__proto__:null,SearchConfig:p,FilePatternRegex:m,QueryTerm:S,SearchResult:class{label(){}description(){}matchesCount(){}matchLabel(e){}matchLineContent(e){}matchRevealable(e){}},SearchScope:class{performSearch(e,t,s,i){}performIndexing(e){}stopSearch(){}},RegexQuery:void 0});class f extends r.VBox{constructor(e){super(!0),this._searchConfig=e,this._searchResults=[],this._treeOutline=new a.TreeOutlineInShadow,this._treeOutline.hideOverflow(),this._treeOutline.registerRequiredCSS("search/searchResultsPane.css"),this.contentElement.appendChild(this._treeOutline.element),this._matchesExpandedCount=0}addSearchResult(e){this._searchResults.push(e),this._addTreeElement(e)}_addTreeElement(e){const t=new R(this._searchConfig,e);this._treeOutline.appendChild(t),this._treeOutline.selectedTreeElement||t.select(!0,!0),this._matchesExpandedCount<x&&t.expand(),this._matchesExpandedCount+=e.matchesCount()}}const x=20;class R extends a.TreeElement{constructor(e,t){super("",!0),this._searchConfig=e,this._searchResult=t,this._initialized=!1,this.toggleOnClick=!0}onexpand(){this._initialized||(this._updateMatchesUI(),this._initialized=!0)}_updateMatchesUI(){this.removeChildren();const e=Math.min(this._searchResult.matchesCount(),20);e<this._searchResult.matchesCount()?(this._appendSearchMatches(0,e-1),this._appendShowMoreMatchesElement(e-1)):this._appendSearchMatches(0,e)}onattach(){this._updateSearchMatches()}_updateSearchMatches(){this.listItemElement.classList.add("search-result");const e=s(this._searchResult.label(),"search-result-file-name");e.appendChild(s("—","search-result-dash")),e.appendChild(s(this._searchResult.description(),"search-result-qualifier")),this.tooltip=this._searchResult.description(),this.listItemElement.appendChild(e);const t=createElement("span");function s(e,t){const s=createElement("span");return s.className=t,s.textContent=e,s}t.className="search-result-matches-count",t.textContent=""+this._searchResult.matchesCount(),c.setAccessibleName(t,ls`Matches Count ${this._searchResult.matchesCount()}`),this.listItemElement.appendChild(t),this.expanded&&this._updateMatchesUI()}_appendSearchMatches(t,s){const i=this._searchResult,h=this._searchConfig.queries(),r=[];for(let e=0;e<h.length;++e)r.push(createSearchRegex(h[e],!this._searchConfig.ignoreCase(),this._searchConfig.isRegex()));for(let h=t;h<s;++h){const t=i.matchLineContent(h).trim();let s=[];for(let e=0;e<r.length;++e)s=s.concat(this._regexMatchRanges(t,r[e]));const o=n.Linkifier.linkifyRevealable(i.matchRevealable(h),"");o.classList.add("search-match-link");const l=createElement("span");l.classList.add("search-match-line-number");const _=i.matchLabel(h);l.textContent=_,"number"!=typeof _||isNaN(_)?c.setAccessibleName(l,ls`${_}`):c.setAccessibleName(l,ls`Line ${_}`),o.appendChild(l);const u=this._createContentSpan(t,s);o.appendChild(u);const d=new a.TreeElement;this.appendChild(d),d.listItemElement.className="search-match",d.listItemElement.appendChild(o),d.listItemElement.addEventListener("keydown",t=>{isEnterKey(t)&&(t.consume(!0),e.reveal(i.matchRevealable(h)))}),d.tooltip=t}}_appendShowMoreMatchesElement(e){const s=this._searchResult.matchesCount()-e,i=t.UIString("Show %d more",s),n=new a.TreeElement(i);this.appendChild(n),n.listItemElement.classList.add("show-more-matches"),n.onselect=this._showMoreMatchesElementSelected.bind(this,n,e)}_createContentSpan(e,t){let s=0;t.length>0&&t[0].offset>20&&(s=15),e=e.substring(s,1e3+s),s&&(t=t.map(e=>new h.SourceRange(e.offset-s+1,e.length)),e="…"+e);const i=createElement("span");return i.className="search-match-content",i.textContent=e,c.setAccessibleName(i,e+" line"),o.highlightRangesWithStyleClass(i,t,"highlighted-match"),i}_regexMatchRanges(e,t){let s;t.lastIndex=0;const i=[];for(;t.lastIndex<e.length&&(s=t.exec(e));)i.push(new h.SourceRange(s.index,s[0].length));return i}_showMoreMatchesElementSelected(e,t){return this.removeChild(e),this._appendSearchMatches(t,this._searchResult.matchesCount()),!1}}var I=Object.freeze({__proto__:null,SearchResultsPane:f,matchesExpandedByDefault:x,matchesShownAtOnce:20,SearchResultsTreeElement:R});class E extends r.VBox{constructor(e){super(!0),this.setMinimumSize(0,40),this.registerRequiredCSS("search/searchView.css"),this._focusOnShow=!1,this._isIndexing=!1,this._searchId=1,this._searchMatchesCount=0,this._searchResultsCount=0,this._nonEmptySearchResultsCount=0,this._searchingView=null,this._notFoundView=null,this._searchConfig=null,this._pendingSearchConfig=null,this._searchResultsPane=null,this._progressIndicator=null,this._visiblePane=null,this.contentElement.classList.add("search-view"),this._searchPanelElement=this.contentElement.createChild("div","search-drawer-header"),this._searchPanelElement.addEventListener("keydown",this._onKeyDown.bind(this),!1),this._searchResultsElement=this.contentElement.createChild("div"),this._searchResultsElement.className="search-results";const i=createElement("div");i.style.flex="auto",i.style.justifyContent="start",i.style.maxWidth="300px",this._search=l.HistoryInput.create(),i.appendChild(this._search),this._search.placeholder=t.UIString("Search"),this._search.setAttribute("type","text"),this._search.setAttribute("results","0"),this._search.setAttribute("size",42),c.setAccessibleName(this._search,ls`Search Query`);const n=new _.ToolbarItem(i),h=new _.Toolbar("search-toolbar",this._searchPanelElement);this._matchCaseButton=E._appendToolbarToggle(h,"Aa",t.UIString("Match Case")),this._regexButton=E._appendToolbarToggle(h,".*",t.UIString("Use Regular Expression")),h.appendToolbarItem(n);const r=new _.ToolbarButton(t.UIString("Refresh"),"largeicon-refresh"),a=new _.ToolbarButton(t.UIString("Clear"),"largeicon-clear");h.appendToolbarItem(r),h.appendToolbarItem(a),r.addEventListener(_.ToolbarButton.Events.Click,this._onAction.bind(this)),a.addEventListener(_.ToolbarButton.Events.Click,()=>{this._resetSearch(),this._onSearchInputClear()});const o=this.contentElement.createChild("div","search-toolbar-summary");this._searchMessageElement=o.createChild("div","search-message"),this._searchProgressPlaceholderElement=o.createChild("div","flex-centered"),this._searchResultsMessageElement=o.createChild("div","search-message"),this._advancedSearchConfig=s.Settings.instance().createLocalSetting(e+"SearchConfig",new p("",!0,!1).toPlainObject()),this._load(),this._searchScope=null}static _appendToolbarToggle(e,t,s){const i=new _.ToolbarToggle(s);return i.setText(t),i.addEventListener(_.ToolbarButton.Events.Click,()=>i.setToggled(!i.toggled())),e.appendToolbarItem(i),i}_buildSearchConfig(){return new p(this._search.value,!this._matchCaseButton.toggled(),this._regexButton.toggled())}async toggle(e,t){e&&(this._search.value=e),this.isShowing()?this.focus():this._focusOnShow=!0,this._initScope(),t?this._onAction():this._startIndexing()}createScope(){throw new Error("Not implemented")}_initScope(){this._searchScope=this.createScope()}wasShown(){this._focusOnShow&&(this.focus(),this._focusOnShow=!1)}_onIndexingFinished(){const e=!this._progressIndicator.isCanceled();if(this._progressIndicator.done(),this._progressIndicator=null,this._isIndexing=!1,this._indexingFinished(e),e||(this._pendingSearchConfig=null),!this._pendingSearchConfig)return;const t=this._pendingSearchConfig;this._pendingSearchConfig=null,this._innerStartSearch(t)}_startIndexing(){this._isIndexing=!0,this._progressIndicator&&this._progressIndicator.done(),this._progressIndicator=new u.ProgressIndicator,this._searchMessageElement.textContent=t.UIString("Indexing…"),this._progressIndicator.show(this._searchProgressPlaceholderElement),this._searchScope.performIndexing(new i.ProgressProxy(this._progressIndicator,this._onIndexingFinished.bind(this)))}_onSearchInputClear(){this._search.value="",this.focus()}_onSearchResult(e,t){e===this._searchId&&this._progressIndicator&&(this._progressIndicator&&this._progressIndicator.isCanceled()?this._onIndexingFinished():(this._addSearchResult(t),t.matchesCount()&&(this._searchResultsPane||(this._searchResultsPane=new f(this._searchConfig),this._showPane(this._searchResultsPane)),this._searchResultsPane.addSearchResult(t))))}_onSearchFinished(e,t){e===this._searchId&&this._progressIndicator&&(this._searchResultsPane||this._nothingFound(),this._searchFinished(t),this._searchConfig=null,c.alert(this._searchMessageElement.textContent+" "+this._searchResultsMessageElement.textContent,this._searchMessageElement))}async _startSearch(e){this._resetSearch(),++this._searchId,this._initScope(),this._isIndexing||this._startIndexing(),this._pendingSearchConfig=e}_innerStartSearch(e){this._searchConfig=e,this._progressIndicator&&this._progressIndicator.done(),this._progressIndicator=new u.ProgressIndicator,this._searchStarted(this._progressIndicator),this._searchScope.performSearch(e,this._progressIndicator,this._onSearchResult.bind(this,this._searchId),this._onSearchFinished.bind(this,this._searchId))}_resetSearch(){this._stopSearch(),this._showPane(null),this._searchResultsPane=null}_stopSearch(){this._progressIndicator&&!this._isIndexing&&this._progressIndicator.cancel(),this._searchScope&&this._searchScope.stopSearch(),this._searchConfig=null}_searchStarted(e){this._resetCounters(),this._searchingView||(this._searchingView=new d.EmptyWidget(t.UIString("Searching…"))),this._showPane(this._searchingView),this._searchMessageElement.textContent=t.UIString("Searching…"),e.show(this._searchProgressPlaceholderElement),this._updateSearchResultsMessage()}_indexingFinished(e){this._searchMessageElement.textContent=e?"":t.UIString("Indexing interrupted.")}_updateSearchResultsMessage(){this._searchMatchesCount&&this._searchResultsCount?1===this._searchMatchesCount&&1===this._nonEmptySearchResultsCount?this._searchResultsMessageElement.textContent=t.UIString("Found 1 matching line in 1 file."):this._searchMatchesCount>1&&1===this._nonEmptySearchResultsCount?this._searchResultsMessageElement.textContent=t.UIString("Found %d matching lines in 1 file.",this._searchMatchesCount):this._searchResultsMessageElement.textContent=t.UIString("Found %d matching lines in %d files.",this._searchMatchesCount,this._nonEmptySearchResultsCount):this._searchResultsMessageElement.textContent=""}_showPane(e){this._visiblePane&&this._visiblePane.detach(),e&&e.show(this._searchResultsElement),this._visiblePane=e}_resetCounters(){this._searchMatchesCount=0,this._searchResultsCount=0,this._nonEmptySearchResultsCount=0}_nothingFound(){this._notFoundView||(this._notFoundView=new d.EmptyWidget(t.UIString("No matches found."))),this._showPane(this._notFoundView),this._searchResultsMessageElement.textContent=t.UIString("No matches found.")}_addSearchResult(e){const t=e.matchesCount();this._searchMatchesCount+=t,this._searchResultsCount++,t&&this._nonEmptySearchResultsCount++,this._updateSearchResultsMessage()}_searchFinished(e){this._searchMessageElement.textContent=e?t.UIString("Search finished."):t.UIString("Search interrupted.")}focus(){this._search.focus(),this._search.select()}willHide(){this._stopSearch()}_onKeyDown(e){switch(e.keyCode){case g.Keys.Enter.code:this._onAction()}}_save(){this._advancedSearchConfig.set(this._buildSearchConfig().toPlainObject())}_load(){const e=p.fromPlainObject(this._advancedSearchConfig.get());this._search.value=e.query(),this._matchCaseButton.setToggled(!e.ignoreCase()),this._regexButton.setToggled(e.isRegex())}_onAction(){c.alert(" ",this._searchMessageElement);const e=this._buildSearchConfig();e.query()&&e.query().length&&(this._save(),this._startSearch(e))}}var w=Object.freeze({__proto__:null,SearchView:E});export{C as SearchConfig,I as SearchResultsPane,w as SearchView};
