import{ResourceType as e,ParsedURL as t,UIString as n,Settings as o,Revealer as i}from"../common/common.js";import{StringUtilities as a}from"../platform/platform.js";import{ResourceTreeModel as r,SDKModel as s,DebuggerModel as c,NetworkRequest as l}from"../sdk/sdk.js";import{Utils as d,UIUtils as u,ARIAUtils as h,SettingsUI as m,ContextMenu as p,DockController as g,RemoteDebuggingTerminatedScreen as k,Dialog as L,GlassPane as b,TargetCrashedScreen as f}from"../ui/ui.js";import{LiveLocation as _,DebuggerWorkspaceBinding as C,CSSWorkspaceBinding as S,ResourceUtils as v,BlackboxManager as x}from"../bindings/bindings.js";import{InspectorFrontendHost as y}from"../host/host.js";import{TextUtils as I}from"../text_utils/text_utils.js";import{Workspace as T}from"../workspace/workspace.js";var w=Object.freeze({__proto__:null,PrecomputedFeatures:void 0,ImagePreview:class{static build(t,n,o,i={precomputedFeatures:void 0,imageAltText:void 0}){const{precomputedFeatures:s,imageAltText:c}=i,l=t.model(r.ResourceTreeModel);if(!l)return Promise.resolve(null);let u,h=l.resourceForURL(n),m=n;if(!k(h)&&s&&s.currentSrc&&(m=s.currentSrc,h=l.resourceForURL(m)),!k(h))return Promise.resolve(null);const p=new Promise(e=>{u=e}),g=document.createElement("img");return g.addEventListener("load",(function(){const e=document.createElement("table");d.appendStyle(e,"components/imagePreview.css"),e.className="image-preview-container";const t=g.naturalWidth,i=g.naturalHeight,r=s?s.renderedWidth:t,c=s?s.renderedHeight:i;let l;o&&(l=c!==i||r!==t?ls`${r} × ${c} pixels (intrinsic: ${t} × ${i} pixels)`:ls`${r} × ${c} pixels`);e.createChild("tr").createChild("td","image-container").appendChild(g),l&&(e.createChild("tr").createChild("td").createChild("span","description").textContent=l);m!==n&&(e.createChild("tr").createChild("td").createChild("span","description").textContent=a.sprintf("currentSrc: %s",m.trimMiddle(100)));u(e)}),!1),g.addEventListener("error",()=>u(null),!1),c&&(g.alt=c),h.populateImageSource(g),p;function k(t){return!!t&&t.resourceType()===e.resourceTypes.Image}}static async loadDimensionsForNode(e){if(!e.nodeName()||"img"!==e.nodeName().toLowerCase())return;const t=await e.resolveToObject("");if(!t)return;const n=t.callFunctionJSON((function(){return{renderedWidth:this.width,renderedHeight:this.height,currentSrc:this.currentSrc}}),void 0);return t.release(),n}static defaultAltTextForImageURL(e){const n=new t.ParsedURL(e),o=n.isValid?n.displayName:ls`unknown source`;return ls`Image from ${o}`}}});class N{constructor(e,t,n=(()=>{})){this._maxLength=e||u.MaxLengthForDisplayedURLs,this._anchorsByTarget=new Map,this._locationPoolByTarget=new Map,this._onLiveLocationUpdate=n,this._useLinkDecorator=!!t,U.add(this),s.TargetManager.instance().observeTargets(this)}static setLinkDecorator(e){console.assert(!D,"Cannot re-register link decorator."),D=e,e.addEventListener(A.Events.LinkIconChanged,(function(e){const t=e.data[R]||[];for(const e of t)N._updateLinkDecorations(e)}));for(const e of U)e._updateAllAnchorDecorations()}_updateAllAnchorDecorations(){for(const e of this._anchorsByTarget.values())for(const t of e)N._updateLinkDecorations(t)}static _bindUILocation(e,t){if(N._linkInfo(e).uiLocation=t,!t)return;const n=t.uiSourceCode;let o=n[R];o||(o=new Set,n[R]=o),o.add(e)}static _unbindUILocation(e){const t=N._linkInfo(e);if(!t.uiLocation)return;const n=t.uiLocation.uiSourceCode;t.uiLocation=null;const o=n[R];o&&o.delete(e)}targetAdded(e){this._anchorsByTarget.set(e,[]),this._locationPoolByTarget.set(e,new _.LiveLocationPool)}targetRemoved(e){const t=this._locationPoolByTarget.get(e);this._locationPoolByTarget.delete(e),t.disposeAll();const n=this._anchorsByTarget.get(e);this._anchorsByTarget.delete(e);for(const e of n){const t=N._linkInfo(e);t.liveLocation=null,N._unbindUILocation(e),t.fallback&&(e.href=t.fallback.href,e.title=t.fallback.title,e.className=t.fallback.className,e.textContent=t.fallback.textContent,e[B]=t.fallback[B])}}maybeLinkifyScriptLocation(e,t,n,o,i){const a={className:"",columnNumber:0,...i},{columnNumber:r,className:s}=a;let l=null;if(n&&(l=N.linkifyURL(n,{lineNumber:o,maxLength:this._maxLength,...i})),!e||e.isDisposed())return l;const d=e.model(c.DebuggerModel);if(!d)return l;let u;if(t&&(u=d.createRawLocationByScriptId(t,o,r)),u||(u=d.createRawLocationByURL(n,o,r)),!u)return l;const h=N._createLink("​",s,i),m=N._linkInfo(h);m.enableDecorator=this._useLinkDecorator,m.fallback=l;const p=this._locationPoolByTarget.get(u.debuggerModel.target());C.DebuggerWorkspaceBinding.instance().createLiveLocation(u,this._updateAnchor.bind(this,h),p).then(e=>{m.liveLocation=e,this._onLiveLocationUpdate()});return this._anchorsByTarget.get(u.debuggerModel.target()).push(h),h}linkifyScriptLocation(e,t,n,o,i){return this.maybeLinkifyScriptLocation(e,t,n,o,i)||N.linkifyURL(n,{lineNumber:o,maxLength:this._maxLength,...i})}linkifyRawLocation(e,t,n){return this.linkifyScriptLocation(e.debuggerModel.target(),e.scriptId,t,e.lineNumber,{columnNumber:e.columnNumber,className:n})}maybeLinkifyConsoleCallFrame(e,t,n){return this.maybeLinkifyScriptLocation(e,t.scriptId,t.url,t.lineNumber,{columnNumber:t.columnNumber,...n})}linkifyStackTraceTopFrame(e,t,n){console.assert(t.callFrames&&t.callFrames.length);const o=t.callFrames[0],i=N.linkifyURL(o.url,{className:n,lineNumber:o.lineNumber,columnNumber:o.columnNumber,maxLength:this._maxLength});if(e.isDisposed())return i;const a=e.model(c.DebuggerModel).createRawLocationsByStackTrace(t);if(0===a.length)return i;const r=N._createLink("​",n||""),s=N._linkInfo(r);s.enableDecorator=this._useLinkDecorator,s.fallback=i;const l=this._locationPoolByTarget.get(e);C.DebuggerWorkspaceBinding.instance().createStackTraceTopFrameLiveLocation(a,this._updateAnchor.bind(this,r),l).then(e=>{s.liveLocation=e,this._onLiveLocationUpdate()});return this._anchorsByTarget.get(e).push(r),r}linkifyCSSLocation(e,t){const n=N._createLink("​",t||""),o=N._linkInfo(n);o.enableDecorator=this._useLinkDecorator;const i=this._locationPoolByTarget.get(e.cssModel().target());S.CSSWorkspaceBinding.instance().createLiveLocation(e,this._updateAnchor.bind(this,n),i).then(e=>{o.liveLocation=e,this._onLiveLocationUpdate()});return this._anchorsByTarget.get(e.cssModel().target()).push(n),n}reset(){for(const e of[...this._anchorsByTarget.keys()])this.targetRemoved(e),this.targetAdded(e)}dispose(){for(const e of[...this._anchorsByTarget.keys()])this.targetRemoved(e);s.TargetManager.instance().unobserveTargets(this),U.delete(this)}async _updateAnchor(e,t){N._unbindUILocation(e);const n=await t.uiLocation();if(!n)return;N._bindUILocation(e,n);const o=n.linkText(!0);N._setTrimmedText(e,o,this._maxLength);let i=n.uiSourceCode.url();"application/wasm"===n.uiSourceCode.mimeType()?i+=":0x"+n.columnNumber.toString(16):"number"==typeof n.lineNumber&&(i+=":"+(n.lineNumber+1)),e.title=i,e.classList.toggle("webkit-html-blackbox-link",await t.isBlackboxed()),N._updateLinkDecorations(e)}setLiveLocationUpdateCallback(e){this._onLiveLocationUpdate=e}static _updateLinkDecorations(e){const t=N._linkInfo(e);if(!t||!t.enableDecorator)return;if(!D||!t.uiLocation)return;t.icon&&t.icon.parentElement&&e.removeChild(t.icon);const n=D.linkIcon(t.uiLocation.uiSourceCode);n&&(n.style.setProperty("margin-right","2px"),e.insertBefore(n,e.firstChild)),t.icon=n}static linkifyURL(e,t){const o=(t=t||{}).text,i=t.className||"",a=t.lineNumber,r=t.columnNumber,s=t.preventClick,c=t.maxLength||u.MaxLengthForDisplayedURLs,l=t.bypassURLTrimming;if(!e||e.trim().toLowerCase().startsWith("javascript:")){const t=document.createElement("span");return i&&(t.className=i),t.textContent=o||e||n.UIString("(unknown)"),t}let d=o||v.displayNameForURL(e);"number"!=typeof a||o||(d+=":"+(a+1));const h={maxLength:c,title:d!==e?e:"",href:e,preventClick:s,tabStop:t.tabStop,bypassURLTrimming:l},m=N._createLink(d,i,h),p=N._linkInfo(m);return"number"==typeof a&&(p.lineNumber=a),"number"==typeof r&&(p.columnNumber=r),m}static linkifyRevealable(e,t,n){const o=N._createLink(t,"",{maxLength:u.MaxLengthForDisplayedURLs,href:n});return N._linkInfo(o).revealable=e,o}static _createLink(e,t,n){n=n||{};const{maxLength:o,title:i,href:a,preventClick:r,tabStop:s,bypassURLTrimming:c}=n,l=document.createElement("span");return t&&(l.className=t),l.classList.add("devtools-link"),i&&(l.title=i),a&&(l.href=a),c?(l.classList.add("devtools-link-styled-trim"),N._appendTextWithoutHashes(l,e)):N._setTrimmedText(l,e,o),l[B]={icon:null,enableDecorator:!1,uiLocation:null,liveLocation:null,url:a||null,lineNumber:null,columnNumber:null,revealable:null,fallback:null},r?l.classList.add("devtools-link-prevent-click"):(l.addEventListener("click",e=>{N._handleClick(e)&&e.consume(!0)},!1),l.addEventListener("keydown",e=>{isEnterKey(e)&&N._handleClick(e)&&e.consume(!0)},!1)),h.markAsLink(l),l.tabIndex=s?0:-1,l}static _setTrimmedText(e,t,n){if(e.removeChildren(),n&&t.length>n){const o=function(e,t){let n=Math.floor(t/2),o=e.length-Math.ceil(t/2)+1;e.codePointAt(o-1)>=65536&&(o++,n++);n>0&&e.codePointAt(n-1)>=65536&&n--;return[e.substring(0,n),e.substring(n,o),e.substring(o)]}(t,n);N._appendTextWithoutHashes(e,o[0]),N._appendHiddenText(e,o[1]),N._appendTextWithoutHashes(e,o[2])}else N._appendTextWithoutHashes(e,t)}static _appendTextWithoutHashes(e,t){const n=I.Utils.splitStringByRegexes(t,[/[a-f0-9]{20,}/g]);for(const t of n)-1===t.regexIndex?e.createTextChild(t.value):(e.createTextChild(t.value.substring(0,7)),N._appendHiddenText(e,t.value.substring(7)))}static _appendHiddenText(e,t){e.createChild("span","devtools-link-ellipsis").createTextChild("…")[F]=t}static untruncatedNodeText(e){return e[F]||e.textContent}static _linkInfo(e){return e&&e[B]||null}static _handleClick(e){const t=e.currentTarget;return!u.isBeingEdited(e.target)&&!t.hasSelection()&&N.invokeFirstAction(t)}static invokeFirstAction(e){const t=N._linkActions(e);return!!t.length&&(t[0].handler.call(null),!0)}static _linkHandlerSetting(){return N._linkHandlerSettingInstance||(N._linkHandlerSettingInstance=o.Settings.instance().createSetting("openLinkHandler",ls`auto`)),N._linkHandlerSettingInstance}static registerLinkHandler(e,t){H.set(e,t),self.runtime.sharedInstance(M)._update()}static unregisterLinkHandler(e){H.delete(e),self.runtime.sharedInstance(M)._update()}static uiLocation(e){const t=N._linkInfo(e);return t?t.uiLocation:null}static _linkActions(e){const o=N._linkInfo(e),a=[];if(!o)return a;let r="",s=null;if(o.uiLocation)s=o.uiLocation,r=s.uiSourceCode.contentURL();else if(o.url){r=o.url;const e=T.WorkspaceImpl.instance().uiSourceCodeForURL(r)||T.WorkspaceImpl.instance().uiSourceCodeForURL(t.ParsedURL.urlWithoutHash(r));s=e?e.uiLocation(o.lineNumber||0,o.columnNumber||0):null}const c=r?v.resourceForURL(r):null,l=s?s.uiSourceCode:c,d=o.revealable||s||c;if(d){const e=i.revealDestination(d);a.push({section:"reveal",title:e?ls`Reveal in ${e}`:ls`Reveal`,handler:()=>i.reveal(d)})}if(l){const e=s?s.lineNumber:o.lineNumber||0;for(const t of H.keys()){const o=H.get(t),i={section:"reveal",title:n.UIString("Open using %s",t),handler:o.bind(null,l,e)};t===N._linkHandlerSetting().get()?a.unshift(i):a.push(i)}}return(c||o.url)&&(a.push({section:"reveal",title:u.openLinkExternallyLabel(),handler:()=>y.InspectorFrontendHostInstance.openInNewTab(r)}),a.push({section:"clipboard",title:u.copyLinkAddressLabel(),handler:()=>y.InspectorFrontendHostInstance.copyText(r)})),a}}const U=new Set;let D=null;const R=Symbol("Linkifier.anchors"),B=Symbol("Linkifier.info"),F=Symbol("Linkifier.untruncatedNodeText"),H=new Map;class A{linkIcon(e){}}A.Events={LinkIconChanged:Symbol("LinkIconChanged")};class M{constructor(){this._element=document.createElement("select"),this._element.classList.add("chrome-select"),this._element.addEventListener("change",this._onChange.bind(this),!1),this._update()}_update(){this._element.removeChildren();const e=[...H.keys()];e.unshift(n.UIString("auto"));for(const t of e){const e=createElement("option");e.textContent=t,e.selected=t===N._linkHandlerSetting().get(),this._element.appendChild(e)}this._element.disabled=e.length<=1}_onChange(e){const t=e.target.value;N._linkHandlerSetting().set(t)}settingElement(){return m.createCustomSetting(n.UIString("Link handling:"),this._element)}}var E=Object.freeze({__proto__:null,Linkifier:N,LinkDecorator:A,LinkContextMenuProvider:class{appendApplicableItems(e,t,n){let o=n;for(;o&&!o[B];)o=o.parentNodeOrShadowHost();const i=o,a=N._linkActions(i);for(const e of a)t.section(e.section).appendItem(e.title,e.handler)}},LinkHandlerSettingUI:M,ContentProviderContextMenuProvider:class{appendApplicableItems(e,t,o){const i=o;if(i.contentURL()){t.revealSection().appendItem(u.openLinkExternallyLabel(),()=>y.InspectorFrontendHostInstance.openInNewTab(i.contentURL()));for(const e of H.keys()){const o=H.get(e);t.revealSection().appendItem(n.UIString("Open using %s",e),o.bind(null,i,0))}i instanceof l.NetworkRequest||t.clipboardSection().appendItem(u.copyLinkAddressLabel(),()=>y.InspectorFrontendHostInstance.copyText(i.contentURL()))}}},_LinkInfo:void 0,LinkifyURLOptions:void 0,LinkifyOptions:void 0,_CreateLinkOptions:void 0,LinkHandler:void 0});var P=Object.freeze({__proto__:null,buildStackTracePreviewContents:function(e,t,n={stackTrace:void 0,contentUpdated:void 0,tabStops:void 0}){const{stackTrace:o,contentUpdated:i,tabStops:a}=n,r=document.createElement("span");r.classList.add("monospace"),r.style.display="inline-block";const s=d.createShadowRootWithCoreStyles(r,"components/jsUtils.css").createChild("table","stack-preview-container");let c=0,l=0;const h=[];function m(n){let o=0;for(const i of n.callFrames){l++;let r=l>30&&n.callFrames.length>31;const c=document.createElement("tr");c.createChild("td").textContent="\n",c.createChild("td","function-name").textContent=u.beautifyFunctionName(i.functionName);const d=t.maybeLinkifyConsoleCallFrame(e,i,{tabStop:!!a,className:void 0,columnNumber:void 0});if(d){d.addEventListener("contextmenu",g.bind(null,d));const e=N.uiLocation(d);e&&x.BlackboxManager.instance().isBlackboxedUISourceCode(e.uiSourceCode)&&(r=!0),c.createChild("td").textContent=" @ ",c.createChild("td").appendChild(d),h.push(d)}r&&(c.classList.add("blackboxed"),++o),s.appendChild(c)}return c+=o,n.callFrames.length===o}function g(e,t){const n=new p.ContextMenu(t);t.consume(!0);const o=N.uiLocation(e);o&&x.BlackboxManager.instance().canBlackboxUISourceCode(o.uiSourceCode)&&(x.BlackboxManager.instance().isBlackboxedUISourceCode(o.uiSourceCode)?n.debugSection().appendItem(ls`Stop blackboxing`,()=>x.BlackboxManager.instance().unblackboxUISourceCode(o.uiSourceCode)):n.debugSection().appendItem(ls`Blackbox script`,()=>x.BlackboxManager.instance().blackboxUISourceCode(o.uiSourceCode))),n.appendApplicableItems(t),n.show()}if(!o)return{element:r,links:h};m(o);let k=o.parent;for(;k;){if(!k.callFrames.length){k=k.parent;continue}const e=s.createChild("tr");e.createChild("td").textContent="\n",e.createChild("td","stack-preview-async-description").textContent=u.asyncStackTraceLabel(k.description),e.createChild("td"),e.createChild("td"),m(k)&&e.classList.add("blackboxed"),k=k.parent}if(c){const e=s.createChild("tr","show-blackboxed-link");e.createChild("td").textContent="\n";const t=e.createChild("td");t.colSpan=4;const n=t.createChild("span","link");n.textContent=1===c?ls`Show 1 more frame`:ls`Show ${c} more frames`,n.addEventListener("click",()=>{s.classList.add("show-blackboxed"),i&&i()},!1)}return{element:r,links:h}},Options:void 0});var W=Object.freeze({__proto__:null,reload:function(){g.DockController.instance().canDock()&&g.DockController.instance().dockSide()===g.State.Undocked&&y.InspectorFrontendHostInstance.setIsDocked(!0,(function(){})),y.InspectorFrontendHostInstance.reattach(()=>window.location.reload())}});class j extends s.SDKModel{constructor(e){super(e),e.registerInspectorDispatcher(this),e.inspectorAgent().enable(),this._hideCrashedDialog=null,j._disconnectedScreenWithReasonWasShown=!1}detached(e){j._disconnectedScreenWithReasonWasShown=!0,k.RemoteDebuggingTerminatedScreen.show(e)}static webSocketConnectionLost(){k.RemoteDebuggingTerminatedScreen.show(ls`WebSocket disconnected`)}targetCrashed(){if(this.target().parentTarget())return;const e=new L.Dialog;e.setSizeBehavior(b.SizeBehavior.MeasureContent),e.addCloseButton(),e.setDimmed(!0),this._hideCrashedDialog=e.hide.bind(e),new f.TargetCrashedScreen(()=>{this._hideCrashedDialog=null}).show(e.contentElement),e.show()}targetReloadedAfterCrash(){this.target().runtimeAgent().runIfWaitingForDebugger(),this._hideCrashedDialog&&(this._hideCrashedDialog.call(null),this._hideCrashedDialog=null)}}s.SDKModel.register(j,s.Capability.Inspector,!0);var O=Object.freeze({__proto__:null,TargetDetachedDialog:j});export{w as ImagePreview,P as JSPresentationUtils,E as Linkifier,W as Reload,O as TargetDetachedDialog};
