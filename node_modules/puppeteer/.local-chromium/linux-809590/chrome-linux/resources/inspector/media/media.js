import{DataGrid as e,SortableDataGrid as t}from"../data_grid/data_grid.js";import{Widget as s,Utils as i,Toolbar as a,ListModel as r,SoftDropDown as n,TabbedPane as o,TreeOutline as l,Icon as h,ContextMenu as d,Panel as _}from"../ui/ui.js";import{SDKModel as c}from"../sdk/sdk.js";import{Color as m,Settings as u,ObjectWrapper as p,UIString as g}from"../common/common.js";import{Platform as v}from"../host/host.js";import{FlameChart as y}from"../perf_ui/perf_ui.js";import{ThemeSupport as E}from"../theme_support/theme_support.js";const b={Timestamp:"displayTimestamp",Event:"event",Value:"value"};class T extends e.DataGridNode{constructor(e){super(e,!1),this._expandableElement=null}createCell(e){const t=this.createTD(e),s=this.data[e];if(e===b.Value){const e=t.createChild("div","event-display-table-contents-json-wrapper");this._expandableElement=new SourceFrame.JSONView(new SourceFrame.ParsedJSON(s,"",""),!0),this._expandableElement.markAsRoot(),this._expandableElement.show(e)}else t.classList.add("event-display-table-basic-text-table-entry"),t.createTextChild(s);return t}}class w extends s.VBox{constructor(){super(),this.registerRequiredCSS("media/eventDisplayTable.css"),this.contentElement.classList.add("event-display-table-contents-table-container"),this._dataGrid=this._createDataGrid([{id:b.Timestamp,title:ls`Timestamp`,weight:1,sortingFunction:t.SortableDataGrid.NumericComparator.bind(null,b.Timestamp)},{id:b.Event,title:ls`Event Name`,weight:2},{id:b.Value,title:ls`Value`,weight:7}]),this._firstEventTime=0,this._dataGrid.setStriped(!0),this._dataGrid.asWidget().show(this.contentElement)}_createDataGrid(t){const s=[];for(const e of t)s.push(w._convertToGridDescriptor(e));const i=new e.DataGridImpl({displayName:ls`Event Display`,columns:s});return i.asWidget().contentElement.classList.add("no-border-top-datagrid"),i}onEvent(e){0===this._firstEventTime&&(this._firstEventTime=e.timestamp);const t=(e=this._subtractFirstEventTime(e)).value;try{const s=JSON.parse(t);e.event=s.event,delete s.event,e.value=s;const i=new T(e),a=this._dataGrid.scrollContainer,r=a.scrollTop===a.scrollHeight-a.offsetHeight;this._dataGrid.rootNode().appendChild(i),r&&(a.scrollTop=a.scrollHeight)}catch(e){}}_subtractFirstEventTime(e){return e.displayTimestamp=(e.timestamp-this._firstEventTime).toFixed(3),e}static _convertToGridDescriptor(t){return{id:t.id,title:t.title,sortable:t.sortable,weight:t.weight||0,sort:e.Order.Ascending}}}var f=Object.freeze({__proto__:null,EventDisplayColumnConfig:void 0,MediaEventColumnKeys:b,EventNode:T,PlayerEventsView:w});const P={PlayerPropertiesChanged:Symbol("PlayerPropertiesChanged"),PlayerEventsAdded:Symbol("PlayerEventsAdded"),PlayerMessagesLogged:Symbol("PlayerMessagesLogged"),PlayerErrorsRaised:Symbol("PlayerErrorsRaised"),PlayersCreated:Symbol("PlayersCreated")};class k extends c.SDKModel{constructor(e){super(e),this._enabled=!1,this._agent=e.mediaAgent(),e.registerMediaDispatcher(this)}resumeModel(){return this._enabled?this._agent.enable():Promise.resolve()}ensureEnabled(){this._agent.enable(),this._enabled=!0}playerPropertiesChanged(e,t){this.dispatchEventToListeners(P.PlayerPropertiesChanged,{playerId:e,properties:t})}playerEventsAdded(e,t){this.dispatchEventToListeners(P.PlayerEventsAdded,{playerId:e,events:t})}playerMessagesLogged(e,t){this.dispatchEventToListeners(P.PlayerMessagesLogged,{playerId:e,messages:t})}playerErrorsRaised(e,t){this.dispatchEventToListeners(P.PlayerErrorsRaised,{playerId:e,errors:t})}playersCreated(e){this.dispatchEventToListeners(P.PlayersCreated,e)}}c.SDKModel.register(k,c.Capability.DOM,!1);var S=Object.freeze({__proto__:null,PlayerEvent:void 0,ProtocolTriggers:P,MediaModel:k});function D(e,t){const s=Math.pow(10,3-t),i=Math.pow(10,Math.max(0,t));return Math.round(e/s)/i+" s"}class M{constructor(e,t,s,i){this._min=e,this._max=t,this._low=this._min,this._high=this._max,this._maxRange=s,this._minRange=i}get low(){return this._low}get high(){return this._high}get min(){return this._min}get max(){return this._max}get range(){return this._high-this._low}_reassertBounds(){let e=!0;for(;e;){if(e=!1,this.range<this._minRange){e=!0;const t=(this._minRange-this.range)/2;this._high+=t,this._low-=t}this._low<this._min&&(e=!0,this._low=this._min),this._high>this._max&&(e=!0,this._high=this._max)}}zoomOut(e,t){const s=this._high-this._low,i=s*Math.pow(1.1,e)-s,a=i*t,r=i-a;this._low-=a,this._high+=r,this._reassertBounds()}zoomIn(e,t){const s=this._high-this._low;if(this.range<=this._minRange)return;const i=s-s/Math.pow(1.1,e),a=i*t,r=i-a;this._low+=a,this._high-=r,this._reassertBounds()}addMax(e){const t=this._high-this._low,s=this._high===this._max,i=this._low===this._min||t>=this._maxRange;this._max+=e,s&&i&&(this._high=this._max),this._reassertBounds()}pushMaxAtLeastTo(e){return this._max<e&&(this.addMax(e-this._max),!0)}}var x=Object.freeze({__proto__:null,FormatMillisecondsToSeconds:D,Bounds:M});const C="11px "+v.fontFamily(),L=E.instance().patchColorText("#444",E.ColorUsage.Foreground),I={height:20,padding:2,collapsible:!1,font:C,color:L,backgroundColor:"rgba(100 0 0 / 10%)",nestingLevel:0,itemsHeight:20,shareHeaderLine:!1,useFirstLineForOverview:!1,useDecoratorsForOverview:!1},V=["#ffba08","#faa307","#f48c06","#e85d04","#dc2f02","#d00000","#9d0208"],F=["#7400b8","#6930c3","#5e60ce","#5390d9","#4ea8de","#48bfe3","#56cfe1","#64dfdf"];function R(e){return m.Color.parse(e).hsla()[2]<.5?"#eee":"#444"}class B{constructor(e,t,s={}){this._timelineData=e,this._setLive=t.setLive,this._setComplete=t.setComplete,this._updateMaxTime=t.updateMaxTime,this._selfIndex=this._timelineData.entryLevels.length,this._live=!1;const i=void 0===s.duration?0:s.duration;this._timelineData.entryLevels.push(s.level||0),this._timelineData.entryStartTimes.push(s.startTime||0),this._timelineData.entryTotalTimes.push(i),-1===i&&(this.endTime=-1),this._title=s.name||"",this._color=s.color||V[0],this._fontColor=R(this._color),this._hoverData=s.hoverData||{}}decorate(e){e.createChild("span").textContent="Name: "+this._title,e.createChild("br");const t=D(this.startTime,2);if(this._live)e.createChild("span").textContent=`Duration: ${t} - LIVE!`;else if(isNaN(this.duration))e.createChild("span").textContent="Time: "+t;else{const s=D(this.duration+this.startTime,2);e.createChild("span").textContent=`Duration: ${t} - ${s}`}}set endTime(e){if(-1===e)this._timelineData.entryTotalTimes[this._selfIndex]=this._setLive(this._selfIndex),this._live=!0;else{this._live=!1;const t=e-this._timelineData.entryStartTimes[this._selfIndex];this._timelineData.entryTotalTimes[this._selfIndex]=t,this._setComplete(this._selfIndex),this._updateMaxTime(e)}}get id(){return this._selfIndex}set level(e){this._timelineData.entryLevels[this._selfIndex]=e}set title(e){this._title=e}get title(){return this._title}set color(e){this._color=e,this._fontColor=R(this._color)}get color(){return this._color}get fontColor(){return this._fontColor}get startTime(){return this._timelineData.entryStartTimes[this._selfIndex]}get duration(){return this._timelineData.entryTotalTimes[this._selfIndex]}get live(){return this._live}}class N extends s.VBox{constructor(){super(),this._intervalTimer=null,this._lastTimestamp=0,this._canTick=!0,this._ticking=!1,this._isShown=!1,this._bounds=new M(0,1e3,3e4,1e3),this._dataProvider=new O(this._bounds,this._updateMaxTime.bind(this)),this._delegate=new A,this._chartGroupExpansionSetting=u.Settings.instance().createSetting("mediaFlameChartGroupExpansion",{}),this._chart=new y.FlameChart(this._dataProvider,this._delegate,this._chartGroupExpansionSetting),this._chart.disableRangeSelection(),this._chart.bindCanvasEvent("wheel",this._onScroll.bind(this)),this._chart.show(this.contentElement)}addMarker(e){e.duration=NaN,this.startEvent(e)}startEvent(e){void 0===e.duration&&(e.duration=-1);const t=e.startTime||0,s=this._dataProvider.startEvent(e);return this._updateMaxTime(t),s}addGroup(e,t){this._dataProvider.addGroup(e,t)}_updateMaxTime(e){this._bounds.pushMaxAtLeastTo(e)&&this._updateRender()}_onScroll(e){const t=Math.round(e.deltaY/50),s=e.offsetX/e.srcElement.clientWidth;t>0?this._bounds.zoomOut(t,s):this._bounds.zoomIn(-t,s),this._updateRender()}willHide(){this._isShown=!1,this._ticking&&this._stop()}wasShown(){this._isShown=!0,this._canTick&&!this._ticking&&this._start()}set canTick(e){this._canTick=e,this._ticking&&!e&&this._stop(),!this._ticking&&this._isShown&&e&&this._start()}_start(){0===this._lastTimestamp&&(this._lastTimestamp=Date.now()),null!==this._intervalTimer||this._stoppedPermanently||(this._intervalTimer=setInterval(this._updateRender.bind(this),16),this._ticking=!0)}_stop(e=!1){clearInterval(this._intervalTimer),this._intervalTimer=null,e&&(this._stoppedPermanently=!0),this._ticking=!1}_updateRender(){if(this._ticking){const e=Date.now(),t=e-this._lastTimestamp;this._lastTimestamp=e,this._bounds.addMax(t)}this._dataProvider.updateMaxTime(this._bounds),this._chart.setWindowTimes(this._bounds.low,this._bounds.high,!0),this._chart.scheduleUpdate()}}class A{constructor(){}windowChanged(e,t,s){}updateRangeSelection(e,t){}updateSelectedGroup(e,t){}}class O{constructor(e,t){this._updateMaxTimeHandle=t,this._bounds=e,this._liveEvents=new Set,this._eventMap=new Map,this._timelineData=new y.TimelineData([],[],[],[]),this._maxLevel=0}addGroup(e,t){this._timelineData.groups.push({name:e,startLevel:this._maxLevel,expanded:!0,selectable:!1,style:I}),this._maxLevel+=t}startEvent(e){if(e.level=e.level||0,e.level>this._maxLevel)throw`level ${e.level} is above the maximum allowed of ${this._maxLevel}`;const t=new B(this._timelineData,{setLive:this._setLive.bind(this),setComplete:this._setComplete.bind(this),updateMaxTime:this._updateMaxTimeHandle},e);return this._eventMap.set(t.id,t),t}_setLive(e){return this._liveEvents.add(e),this._bounds.max}_setComplete(e){this._liveEvents.delete(e)}updateMaxTime(e){this._bounds=e;for(const e of this._liveEvents.entries())this._eventMap.get(e[0]).endTime=-1}maxStackDepth(){return this._maxLevel+1}timelineData(){return this._timelineData}minimumBoundary(){return this._bounds.low}totalTime(){return this._bounds.high}entryColor(e){return this._eventMap.get(e).color}textColor(e){return this._eventMap.get(e).fontColor}entryTitle(e){return this._eventMap.get(e).title}entryFont(e){return C}decorateEntry(e,t,s,i,a,r,n,o,l){return!1}forceDecoration(e){return!1}prepareHighlightedEntryInfo(e){const t=createElement("div");return this._eventMap.get(e).decorate(t),t}formatValue(e,t){return e+=Math.round(this._bounds.low),this._bounds.range<2800?D(e,2):this._bounds.range<3e4?D(e,1):D(e,0)}canJumpToEntry(e){return!1}navStartTimes(){return new Map}}var U=Object.freeze({__proto__:null,HotColorScheme:V,ColdColorScheme:F,Event:B,TickingFlameChart:N});class G extends N{constructor(){super(),this._normalizedTimestamp=-1.5,this.addGroup("Playback Status",2),this.addGroup("Buffering Status",2),this._playbackStatusLastEvent=null,this._audioBufferingStateEvent=null,this._videoBufferingStateEvent=null}_ensureNoPreviousPlaybackEvent(e){null!==this._playbackStatusLastEvent&&(this._playbackStatusLastEvent.endTime=e,this._playbackStatusLastEvent=null)}_onPlaybackEvent(e,t){switch(e.event){case"kPlay":this.canTick=!0,this._ensureNoPreviousPlaybackEvent(t),this._playbackStatusLastEvent=this.startEvent({level:0,startTime:t,name:"Play"});break;case"kPause":this._ensureNoPreviousPlaybackEvent(t),this._playbackStatusLastEvent=this.startEvent({level:0,startTime:t,name:"Pause",color:V[1]});break;case"kWebMediaPlayerDestroyed":this.canTick=!1,this._ensureNoPreviousPlaybackEvent(t),this.addMarker({level:1,startTime:t,name:"Destroyed",color:V[4]});break;case"kSuspended":this.canTick=!1,this._ensureNoPreviousPlaybackEvent(t),this._playbackStatusLastEvent=this.startEvent({level:1,startTime:t,name:"Suspended",color:V[3]});break;case"kEnded":this._ensureNoPreviousPlaybackEvent(t),this._playbackStatusLastEvent=this.startEvent({level:1,startTime:t,name:"Ended",color:V[2]});break;default:throw"_onPlaybackEvent cant handle "+e.event}}_bufferedEnough(e){return"BUFFERING_HAVE_ENOUGH"===e.state}_onBufferingStatus(e,t){let s=null,i=null;switch(e.event){case"kBufferingStateChanged":s=e.value.audio_buffering_state,i=e.value.video_buffering_state,s&&(null!==this._audioBufferingStateEvent&&(this._audioBufferingStateEvent.endTime=t,this._audioBufferingStateEvent=null),this._bufferedEnough(s)||(this._audioBufferingStateEvent=this.startEvent({level:3,startTime:t,name:"Audio Buffering",color:F[1]}))),i&&(null!==this._videoBufferingStateEvent&&(this._videoBufferingStateEvent.endTime=t,this._videoBufferingStateEvent=null),this._bufferedEnough(i)||(this._videoBufferingStateEvent=this.startEvent({level:2,startTime:t,name:"Video Buffering",color:F[0]})));break;default:throw"_onPlaybackEvent cant handle "+e.event}}onEvent(e){-1.5===this._normalizedTimestamp&&(this._normalizedTimestamp=e.timestamp);const t=1e3*(e.timestamp-this._normalizedTimestamp);switch(e.event){case"kPlay":case"kPause":case"kWebMediaPlayerDestroyed":case"kSuspended":case"kEnded":return this._onPlaybackEvent(e,t);case"kBufferingStateChanged":return this._onBufferingStatus(e,t)}}}const H=1,z=2,j=4,$=8,W=7,J=15;class K extends p.ObjectWrapper{constructor(e,t){super(),this._items=e,this._view=t,this._itemMap=new Map,this._hiddenLevels=[],this._bitFieldValue=W,this._savedBitFieldValue=W,this._defaultTitle=ls`Default`,this._customTitle=ls`Custom`,this._allTitle=ls`All`}defaultTitle(){return this._defaultTitle}setDefault(e){e.selectItem(this._items.at(0))}populate(){this._items.insert(this._items.length,{title:this._defaultTitle,overwrite:!0,stringValue:"",value:W}),this._items.insert(this._items.length,{title:this._allTitle,overwrite:!0,stringValue:"",value:J}),this._items.insert(this._items.length,{title:ls`Error`,overwrite:!1,stringValue:"error",value:H}),this._items.insert(this._items.length,{title:ls`Warning`,overwrite:!1,stringValue:"warning",value:z}),this._items.insert(this._items.length,{title:ls`Info`,overwrite:!1,stringValue:"info",value:j}),this._items.insert(this._items.length,{title:ls`Debug`,overwrite:!1,stringValue:"debug",value:$})}_updateCheckMarks(){this._hiddenLevels=[];for(const[e,t]of this._itemMap)t.overwrite||(t.element.firstChild&&t.element.firstChild.remove(),e&this._bitFieldValue?t.element.createChild("div").createTextChild("✓"):this._hiddenLevels.push(t.stringValue))}titleFor(e){if(e.overwrite?this._bitFieldValue=e.value:this._bitFieldValue^=e.value,this._bitFieldValue===W)return this._defaultTitle;if(this._bitFieldValue===J)return this._allTitle;const t=this._itemMap.get(this._bitFieldValue);return t?t.title:this._customTitle}createElementForItem(e){const t=document.createElementWithClass("div"),s=i.createShadowRootWithCoreStyles(t,"media/playerMessagesView.css").createChild("div","media-messages-level-dropdown-element"),a=s.createChild("div","media-messages-level-dropdown-checkbox");return s.createChild("span","media-messages-level-dropdown-text").createTextChild(e.title),e.element=a,this._itemMap.set(e.value,e),this._updateCheckMarks(),this._view.regenerateMessageDisplayCss(this._hiddenLevels),t}isItemSelectable(e){return!0}itemSelected(e){this._updateCheckMarks(),this._view.regenerateMessageDisplayCss(this._hiddenLevels)}highlightedItemChanged(e,t,s,i){}}class q extends s.VBox{constructor(){super(),this.registerRequiredCSS("media/playerMessagesView.css"),this._headerPanel=this.contentElement.createChild("div","media-messages-header"),this._bodyPanel=this.contentElement.createChild("div","media-messages-body"),this._buildToolbar()}_buildToolbar(){const e=new a.Toolbar("media-messages-toolbar",this._headerPanel);e.appendText(ls`Log Level:`),e.appendToolbarItem(this._createDropdown()),e.appendSeparator(),e.appendToolbarItem(this._createFilterInput())}_createDropdown(){const e=new r.ListModel;this._messageLevelSelector=new K(e,this);const t=new n.SoftDropDown(e,this._messageLevelSelector);t.setRowHeight(18),this._messageLevelSelector.populate(),this._messageLevelSelector.setDefault(t);const s=new a.ToolbarItem(t.element);return s.element.classList.add("toolbar-has-dropdown"),s.setEnabled(!0),s.setTitle(this._messageLevelSelector.defaultTitle()),s}_createFilterInput(){const e=new a.ToolbarInput(ls`filter log messages`);return e.addEventListener(a.ToolbarInput.Event.TextChanged,this._filterByString,this),e}regenerateMessageDisplayCss(e){const t=this._bodyPanel.getElementsByClassName("media-messages-message-container");for(const s of t)this._matchesHiddenLevels(s,e)?s.classList.add("media-messages-message-unselected"):s.classList.remove("media-messages-message-unselected")}_matchesHiddenLevels(e,t){for(const s of t)if(e.classList.contains("media-message-"+s))return!0;return!1}_filterByString(e){const t=e.data,s=this._bodyPanel.getElementsByClassName("media-messages-message-container");for(const e of s)""===t||e.textContent.includes(t)?e.classList.remove("media-messages-message-filtered"):e.classList.add("media-messages-message-filtered")}addMessage(e){this._bodyPanel.createChild("div","media-messages-message-container media-message-"+e.level).createTextChild(e.message)}}const Y={kResolution:"kResolution",kTotalBytes:"kTotalBytes",kBitrate:"kBitrate",kMaxDuration:"kMaxDuration",kStartTime:"kStartTime",kIsVideoEncrypted:"kIsVideoEncrypted",kIsStreaming:"kIsStreaming",kFrameUrl:"kFrameUrl",kFrameTitle:"kFrameTitle",kIsSingleOrigin:"kIsSingleOrigin",kIsRangeHeaderSupported:"kIsRangeHeaderSupported",kVideoDecoderName:"kVideoDecoderName",kAudioDecoderName:"kAudioDecoderName",kIsPlatformVideoDecoder:"kIsPlatformVideoDecoder",kIsPlatformAudioDecoder:"kIsPlatformAudioDecoder",kIsVideoDecryptingDemuxerStream:"kIsVideoDecryptingDemuxerStream",kIsAudioDecryptingDemuxerStream:"kIsAudioDecryptingDemuxerStream",kAudioTracks:"kAudioTracks",kTextTracks:"kTextTracks",kVideoTracks:"kVideoTracks",kFramerate:"kFramerate",kVideoPlaybackRoughness:"kVideoPlaybackRoughness"};class X extends s.VBox{constructor(e){super(),this.contentElement.classList.add("media-property-renderer"),this._title=this.contentElement.createChild("span","media-property-renderer-title"),this._contents=this.contentElement.createChild("span","media-property-renderer-contents"),this._title.createTextChild(e),this._title=e,this._value=null,this._pseudo_color_protection_element=null,this.contentElement.classList.add("media-property-renderer-hidden")}updateData(e,t){if(""===t||null===t)return this._updateData(e,null);try{t=JSON.parse(t)}catch(e){}return this._updateData(e,t)}_updateData(e,t){if(null===t)this.changeContents(null);else{if(this._value===t)return;this._value=t,this.changeContents(t)}}changeContents(e){if(null===e)this.contentElement.classList.add("media-property-renderer-hidden"),null===this._pseudo_color_protection_element&&(this._pseudo_color_protection_element=document.createElement("div"),this._pseudo_color_protection_element.classList.add("media-property-renderer"),this._pseudo_color_protection_element.classList.add("media-property-renderer-hidden"),this.contentElement.parentNode.insertBefore(this._pseudo_color_protection_element,this.contentElement));else{null!==this._pseudo_color_protection_element&&(this._pseudo_color_protection_element.remove(),this._pseudo_color_protection_element=null),this.contentElement.classList.remove("media-property-renderer-hidden"),this._contents.removeChildren();const t=createElement("span");t.textContent=e,this._contents.appendChild(t)}}}class Q extends X{constructor(e,t){super(g.UIString(e)),this._formatfunction=t}_updateData(e,t){null===t?this.changeContents(null):this.changeContents(this._formatfunction(t))}}class Z extends X{constructor(e,t){super(g.UIString(e)),this.changeContents(t)}}class ee extends s.VBox{constructor(e){super(),this.contentElement.classList.add("media-attributes-view");for(const t of e)t.show(this.contentElement)}}class te{constructor(e,t){this._type=t,this._view=e,this._previousTabs=[]}updateData(e,t){const s=this._view.GetTabs(this._type),i=JSON.parse(t);let a=1;for(const e of i)this.addNewTab(s,e,a),a++}addNewTab(e,t,s){const i=[];for(const[e,s]of Object.entries(t))i.push(new Z(e,s));const a=new ee(i);e.addNewTab(s,a)}}class se extends te{constructor(e){super(e,"video")}}class ie extends te{constructor(e){super(e,"text")}}class ae extends te{constructor(e){super(e,"audio")}}const re={Video:g.UIString("Video"),Audio:g.UIString("Audio")};class ne extends o.TabbedPane{constructor(e,t=ls`Track`){super(),this._decoderName=e,this._trackName=t}addNewTab(e,t){const s=g.UIString("track");this.appendTab("Track"+e,`${this._trackName} #${e}`,t,`${this._decoderName} ${s} #${e}`)}}class oe extends ne{constructor(e,t){super(e);const s=`${e} ${g.UIString("Decoder")}`,i=`${s} ${g.UIString("Properties")}`;this.appendTab("DecoderProperties",s,t,i)}}class le extends s.VBox{constructor(){super(),this.contentElement.classList.add("media-properties-frame"),this.registerRequiredCSS("media/playerPropertiesView.css"),this.populateAttributesAndElements(),this._videoProperties=new ee(this._mediaElements),this._videoDecoderProperties=new ee(this._videoDecoderElements),this._audioDecoderProperties=new ee(this._audioDecoderElements),this._videoProperties.show(this.contentElement),this._videoDecoderTabs=new oe(re.Video,this._videoDecoderProperties),this._videoDecoderTabs.show(this.contentElement),this._audioDecoderTabs=new oe(re.Audio,this._audioDecoderProperties),this._audioDecoderTabs.show(this.contentElement),this._textTrackTabs=null}_lazyCreateTrackTabs(){return null===this._textTrackTabs&&(this._textTrackTabs=new ne(ls`Text Track`),this._textTrackTabs.show(this.contentElement)),this._textTrackTabs}GetTabs(e){if("audio"===e)return this._audioDecoderTabs;if("video"===e)return this._videoDecoderTabs;if("text"===e)return this._lazyCreateTrackTabs();throw new Error("Unreachable")}onProperty(e){const t=this._attributeMap.get(e.name);if(!t)throw new Error(`PlayerProperty ${e.name} not supported.`);t.updateData(e.name,e.value)}formatKbps(e){if(""===e)return"0 kbps";return Math.floor(e/1e3)+" kbps"}formatTime(e){if(""===e)return"0:00";const t=new Date(null);return t.setSeconds(e),t.toISOString().substr(11,8)}formatFileSize(e){if(""===e)return"0 bytes";const t=Math.floor(Math.log(e)/Math.log(1024)),s=["bytes","kB","MB","GB","TB"][t];return`${(e/Math.pow(1e3,t)).toFixed(2)} ${s}`}populateAttributesAndElements(){this._mediaElements=[],this._videoDecoderElements=[],this._audioDecoderElements=[],this._textTrackElements=[],this._attributeMap=new Map;const e=new X(ls`Resolution`);this._mediaElements.push(e),this._attributeMap.set(Y.kResolution,e);const t=new Q(ls`File Size`,this.formatFileSize);this._mediaElements.push(t),this._attributeMap.set(Y.kTotalBytes,t);const s=new Q(ls`Bitrate`,this.formatKbps);this._mediaElements.push(s),this._attributeMap.set(Y.kBitrate,s);const i=new Q(ls`Duration`,this.formatTime);this._mediaElements.push(i),this._attributeMap.set(Y.kMaxDuration,i);const a=new X(ls`Start Time`);this._mediaElements.push(a),this._attributeMap.set(Y.kStartTime,a);const r=new X(ls`Streaming`);this._mediaElements.push(r),this._attributeMap.set(Y.kIsStreaming,r);const n=new X(ls`Playback Frame URL`);this._mediaElements.push(n),this._attributeMap.set(Y.kFrameUrl,n);const o=new X(ls`Playback Frame Title`);this._mediaElements.push(o),this._attributeMap.set(Y.kFrameTitle,o);const l=new X(ls`Is Single Origin Playback`);this._mediaElements.push(l),this._attributeMap.set(Y.kIsSingleOrigin,l);const h=new X(ls`Range Header Support`);this._mediaElements.push(h),this._attributeMap.set(Y.kIsRangeHeaderSupported,h);const d=new X(ls`Frame Rate`);this._mediaElements.push(d),this._attributeMap.set(Y.kFramerate,d);const _=new X(ls`Video Playback Roughness`);this._mediaElements.push(_),this._attributeMap.set(Y.kVideoPlaybackRoughness,_);const c=new Z(ls`Decoder Name`,ls`No Decoder`);this._videoDecoderElements.push(c),this._attributeMap.set(Y.kVideoDecoderName,c);const m=new X(ls`Hardware Decoder`);this._videoDecoderElements.push(m),this._attributeMap.set(Y.kIsPlatformVideoDecoder,m);const u=new X(ls`Decrypting Demuxer`);this._videoDecoderElements.push(u),this._attributeMap.set(Y.kIsVideoDecryptingDemuxerStream,u);const p=new se(this);this._attributeMap.set(Y.kVideoTracks,p);const g=new Z(ls`Decoder Name`,ls`No Decoder`);this._audioDecoderElements.push(g),this._attributeMap.set(Y.kAudioDecoderName,g);const v=new X(ls`Hardware Decoder`);this._audioDecoderElements.push(v),this._attributeMap.set(Y.kIsPlatformAudioDecoder,v);const y=new X(ls`Decrypting Demuxer`);this._audioDecoderElements.push(y),this._attributeMap.set(Y.kIsAudioDecryptingDemuxerStream,y);const E=new ae(this);this._attributeMap.set(Y.kAudioTracks,E);const b=new ie(this);this._attributeMap.set(Y.kTextTracks,b)}}var he=Object.freeze({__proto__:null,PlayerPropertyKeys:Y,PropertyRenderer:X,FormattedPropertyRenderer:Q,DefaultPropertyRenderer:Z,DimensionPropertyRenderer:class extends X{constructor(e){super(g.UIString(e)),this._width=0,this._height=0}_updateData(e,t){let s=!1;"width"===e&&t!==this._width&&(this._width=t,s=!0),"height"===e&&t!==this._height&&(this._height=t,s=!0),0===this._width||0===this._height?this.changeContents(null):s&&this.changeContents(`${this._width}×${this._height}`)}},AttributesView:ee,TrackManager:te,VideoTrackManager:se,TextTrackManager:ie,AudioTrackManager:ae,PlayerPropertiesView:le});const de={Events:"events",Properties:"properties",Messages:"messages",Timeline:"timeline"};class _e extends o.TabbedPane{constructor(){super(),this._eventView=new w,this._propertyView=new le,this._messageView=new q,this._timelineView=new G,this.appendTab(de.Properties,g.UIString("Properties"),this._propertyView,g.UIString("Player properties")),this.appendTab(de.Events,g.UIString("Events"),this._eventView,g.UIString("Player events")),this.appendTab(de.Messages,g.UIString("Messages"),this._messageView,g.UIString("Player messages")),this.appendTab(de.Timeline,g.UIString("Timeline"),this._timelineView,g.UIString("Player timeline"))}onProperty(e){this._propertyView.onProperty(e)}onError(e){}onMessage(e){this._messageView.addMessage(e)}onEvent(e){this._eventView.onEvent(e),this._timelineView.onEvent(e)}}var ce=Object.freeze({__proto__:null,PlayerDetailViewTabs:de,PlayerDetailView:_e});class me extends l.TreeElement{constructor(e,t,s){super(e.playerTitle,!1),this.titleFromUrl=!0,this._playerStatus=e,this._displayContainer=t,this.setLeadingIcons([h.Icon.create("smallicon-videoplayer-playing","media-player")]),this.listItemElement.classList.add("player-entry-tree-element"),this.listItemElement.addEventListener("contextmenu",this._rightClickContextMenu.bind(this,s),!1)}onselect(e){return this._displayContainer.renderMainPanel(this._playerStatus.playerID),!0}_rightClickContextMenu(e,t){const s=new d.ContextMenu(t);return s.headerSection().appendItem(ls`Hide player`,this._hidePlayer.bind(this,e)),s.headerSection().appendItem(ls`Hide all others`,this._hideOthers.bind(this,e)),s.headerSection().appendItem(ls`Save player info`,this._savePlayer.bind(this,e)),s.show(),!0}_hidePlayer(e){this._displayContainer.markPlayerForDeletion(e)}_savePlayer(e){this._displayContainer.exportPlayerData(e)}_hideOthers(e){this._displayContainer.markOtherPlayersForDeletion(e)}}class ue extends s.VBox{constructor(e){super(!0),this._playerStatuses=new Map,this._mainContainer=e,this._sidebarTree=new l.TreeOutlineInShadow,this.contentElement.appendChild(this._sidebarTree.element),this._sidebarTree.registerRequiredCSS("media/playerListView.css"),this._playerList=this._addListSection(Common.UIString("Players")),this._playerList.listItemElement.classList.add("player-entry-header")}deletePlayer(e){this._playerList.removeChild(this._playerStatuses.get(e)),this._playerStatuses.delete(e)}_addListSection(e){const t=new l.TreeElement(e,!0);return t.listItemElement.classList.add("storage-group-list-item"),t.setCollapsible(!1),t.selectable=!1,this._sidebarTree.appendChild(t),t}addMediaElementItem(e){const t=new me({playerTitle:e,playerID:e,exists:!0,playing:!1,titleEdited:!1},this._mainContainer,e);this._playerStatuses.set(e,t),this._playerList.appendChild(t)}setMediaElementPlayerTitle(e,t,s){if(this._playerStatuses.has(e)){const i=this._playerStatuses.get(e);s&&!i.titleFromUrl||(i.title=t,i.titleFromUrl=s)}}setMediaElementPlayerIcon(e,t){if(this._playerStatuses.has(e)){this._playerStatuses.get(e).setLeadingIcons([h.Icon.create("smallicon-videoplayer-"+t,"media-player")])}}onProperty(e,t){if(t.name===Y.kFrameTitle&&t.value&&this.setMediaElementPlayerTitle(e,t.value,!1),t.name===Y.kFrameUrl){const s=t.value.substring(t.value.lastIndexOf("/")+1);this.setMediaElementPlayerTitle(e,s,!0)}}onError(e,t){}onMessage(e,t){}onEvent(e,t){"PLAY"===t.value?this.setMediaElementPlayerIcon(e,"playing"):"PAUSE"===t.value?this.setMediaElementPlayerIcon(e,"paused"):"WEBMEDIAPLAYER_DESTROYED"===t.value&&this.setMediaElementPlayerIcon(e,"destroyed")}}var pe=Object.freeze({__proto__:null,PlayerStatus:void 0,PlayerStatusMapElement:void 0,PlayerEntryTreeElement:me,PlayerListView:ue});class ge{constructor(){this._properties={},this._messages=[],this._events=[],this._errors=[]}onProperty(e){this._properties[e.name]=e.value}onError(e){this._errors.push(e)}onMessage(e){this._messages.push(e)}onEvent(e){this._events.push(e)}export(){return{properties:this._properties,messages:this._messages,events:this._events,errors:this._errors}}}class ve{constructor(){this._playerDataCollection=new Map}addPlayer(e){this._playerDataCollection.set(e,new ge)}onProperty(e,t){this._playerDataCollection.get(e).onProperty(t)}onError(e,t){this._playerDataCollection.get(e).onError(t)}onMessage(e,t){this._playerDataCollection.get(e).onMessage(t)}onEvent(e,t){this._playerDataCollection.get(e).onEvent(t)}exportPlayerData(e){return this._playerDataCollection.get(e).export()}deletePlayer(e){this._playerDataCollection.delete(e)}}class ye extends _.PanelWithSidebar{constructor(){super("Media"),this.registerRequiredCSS("media/mediaView.css"),this._detailPanels=new Map,this._deletedPlayers=new Set,this._downloadStore=new ve,this._sidebar=new ue(this),this._sidebar.show(this.panelSidebarElement()),c.TargetManager.instance().observeModels(k,this)}renderMainPanel(e){this._detailPanels.has(e)&&(this.splitWidget().mainWidget().detachChildWidgets(),this._detailPanels.get(e).show(this.mainElement()))}wasShown(){super.wasShown();for(const e of c.TargetManager.instance().models(k))this._addEventListeners(e)}willHide(){for(const e of c.TargetManager.instance().models(k))this._removeEventListeners(e)}modelAdded(e){this.isShowing()&&this._addEventListeners(e)}modelRemoved(e){this._removeEventListeners(e)}_addEventListeners(e){e.ensureEnabled(),e.addEventListener(P.PlayerPropertiesChanged,this._propertiesChanged,this),e.addEventListener(P.PlayerEventsAdded,this._eventsAdded,this),e.addEventListener(P.PlayerMessagesLogged,this._messagesLogged,this),e.addEventListener(P.PlayerErrorsRaised,this._errorsRaised,this),e.addEventListener(P.PlayersCreated,this._playersCreated,this)}_removeEventListeners(e){e.removeEventListener(P.PlayerPropertiesChanged,this._propertiesChanged,this),e.removeEventListener(P.PlayerEventsAdded,this._eventsAdded,this),e.removeEventListener(P.PlayerMessagesLogged,this._messagesLogged,this),e.removeEventListener(P.PlayerErrorsRaised,this._errorsRaised,this),e.removeEventListener(P.PlayersCreated,this._playersCreated,this)}_onPlayerCreated(e){this._sidebar.addMediaElementItem(e),this._detailPanels.set(e,new _e),this._downloadStore.addPlayer(e)}_propertiesChanged(e){for(const t of e.data.properties)this.onProperty(e.data.playerId,t)}_eventsAdded(e){for(const t of e.data.events)this.onEvent(e.data.playerId,t)}_messagesLogged(e){for(const t of e.data.messages)this.onMessage(e.data.playerId,t)}_errorsRaised(e){for(const t of e.data.errors)this.onError(e.data.playerId,t)}_shouldPropagate(e){return!this._deletedPlayers.has(e)&&this._detailPanels.has(e)}onProperty(e,t){this._shouldPropagate(e)&&(this._sidebar.onProperty(e,t),this._downloadStore.onProperty(e,t),this._detailPanels.get(e).onProperty(t))}onError(e,t){this._shouldPropagate(e)&&(this._sidebar.onError(e,t),this._downloadStore.onError(e,t),this._detailPanels.get(e).onError(t))}onMessage(e,t){this._shouldPropagate(e)&&(this._sidebar.onMessage(e,t),this._downloadStore.onMessage(e,t),this._detailPanels.get(e).onMessage(t))}onEvent(e,t){this._shouldPropagate(e)&&(this._sidebar.onEvent(e,t),this._downloadStore.onEvent(e,t),this._detailPanels.get(e).onEvent(t))}_playersCreated(e){const t=e.data;for(const e of t)this._onPlayerCreated(e)}markPlayerForDeletion(e){this._deletedPlayers.add(e),this._detailPanels.delete(e),this._sidebar.deletePlayer(e),this._downloadStore.deletePlayer(e)}markOtherPlayersForDeletion(e){for(const t of this._detailPanels.keys())t!==e&&this.markPlayerForDeletion(t)}exportPlayerData(e){const t=this._downloadStore.exportPlayerData(e),s="data:application/octet-stream,"+encodeURIComponent(JSON.stringify(t,null,2)),i=document.createElement("a");i.href=s,i.download=e+".json",i.click()}}var Ee=Object.freeze({__proto__:null,TriggerHandler:class{onProperty(e){}onError(e){}onMessage(e){}onEvent(e){}},TriggerDispatcher:class{onProperty(e,t){}onError(e,t){}onMessage(e,t){}onEvent(e,t){}},MainView:ye});export{Ee as MainView,S as MediaModel,ce as PlayerDetailView,f as PlayerEventsView,pe as PlayerListView,he as PlayerPropertiesView,U as TickingFlameChart,x as TickingFlameChartHelpers};
