import{SDKModel as e,DOMModel as t,OverlayModel as i,ResourceTreeModel as s,NetworkManager as n,EmulationModel as o,ScreenCaptureModel as a}from"../sdk/sdk.js";import{UIString as h,Settings as r,Color as l,ResourceType as d}from"../common/common.js";import{Widget as c,ARIAUtils as _,KeyboardShortcut as g,UIUtils as u,Toolbar as m,RootView as v,SplitWidget as p,InspectorView as E}from"../ui/ui.js";import{InspectorFrontendHost as f}from"../host/host.js";class y extends e.SDKModel{constructor(e){super(e),this._inputAgent=e.inputAgent(),this._activeTouchOffsetTop=null,this._activeTouchParams=null}emitKeyEvent(e){let t;switch(e.type){case"keydown":t=Protocol.Input.DispatchKeyEventRequestType.KeyDown;break;case"keyup":t=Protocol.Input.DispatchKeyEventRequestType.KeyUp;break;case"keypress":t=Protocol.Input.DispatchKeyEventRequestType.Char;break;default:return}const i="keypress"===e.type?String.fromCharCode(e.charCode):void 0;this._inputAgent.invoke_dispatchKeyEvent({type:t,modifiers:this._modifiersForEvent(e),text:i,unmodifiedText:i?i.toLowerCase():void 0,keyIdentifier:e.keyIdentifier,code:e.code,key:e.key,windowsVirtualKeyCode:e.keyCode,nativeVirtualKeyCode:e.keyCode,autoRepeat:!1,isKeypad:!1,isSystemKey:!1})}emitTouchFromMouseEvent(e,t,i){const s={0:"none",1:"left",2:"middle",3:"right"},n={mousedown:"mousePressed",mouseup:"mouseReleased",mousemove:"mouseMoved",mousewheel:"mouseWheel"};if(!(e.type in n)||!(e.which in s))return;if("mousewheel"!==e.type&&"none"===s[e.which])return;"mousedown"!==e.type&&null!==this._activeTouchOffsetTop||(this._activeTouchOffsetTop=t);const o=Math.round(e.offsetX/i);let a=Math.round(e.offsetY/i);a=Math.round(a-this._activeTouchOffsetTop);const h={type:n[e.type],x:o,y:a,modifiers:this._modifiersForEvent(e),button:s[e.which],clickCount:0};"mousewheel"===e.type?(h.deltaX=e.wheelDeltaX/i,h.deltaY=e.wheelDeltaY/i):this._activeTouchParams=h,"mouseup"===e.type&&(this._activeTouchOffsetTop=null),this._inputAgent.invoke_emulateTouchFromMouseEvent(h)}cancelTouch(){if(null!==this._activeTouchParams){const e=this._activeTouchParams;this._activeTouchParams=null,e.type="mouseReleased",this._inputAgent.invoke_emulateTouchFromMouseEvent(e)}}_modifiersForEvent(e){return(e.altKey?1:0)|(e.ctrlKey?2:0)|(e.metaKey?4:0)|(e.shiftKey?8:0)}}e.SDKModel.register(y,e.Capability.Input,!1);var C=Object.freeze({__proto__:null,InputModel:y});class w extends c.VBox{constructor(e){super(),this._screenCaptureModel=e,this._domModel=e.target().model(t.DOMModel),this._overlayModel=e.target().model(i.OverlayModel),this._resourceTreeModel=e.target().model(s.ResourceTreeModel),this._networkManager=e.target().model(n.NetworkManager),this._inputModel=e.target().model(y),this.setMinimumSize(150,150),this.registerRequiredCSS("screencast/screencastView.css")}initialize(){this.element.classList.add("screencast"),this._createNavigationBar(),this._viewportElement=this.element.createChild("div","screencast-viewport hidden"),this._canvasContainerElement=this._viewportElement.createChild("div","screencast-canvas-container"),this._glassPaneElement=this._canvasContainerElement.createChild("div","screencast-glasspane fill hidden"),this._canvasElement=this._canvasContainerElement.createChild("canvas"),_.setAccessibleName(this._canvasElement,ls`Screencast view of debug target`),this._canvasElement.tabIndex=0,this._canvasElement.addEventListener("mousedown",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("mouseup",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("mousemove",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("mousewheel",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("click",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),this._canvasElement.addEventListener("keydown",this._handleKeyEvent.bind(this),!1),this._canvasElement.addEventListener("keyup",this._handleKeyEvent.bind(this),!1),this._canvasElement.addEventListener("keypress",this._handleKeyEvent.bind(this),!1),this._canvasElement.addEventListener("blur",this._handleBlurEvent.bind(this),!1),this._titleElement=this._canvasContainerElement.createChild("div","screencast-element-title monospace hidden"),this._tagNameElement=this._titleElement.createChild("span","screencast-tag-name"),this._nodeIdElement=this._titleElement.createChild("span","screencast-node-id"),this._classNameElement=this._titleElement.createChild("span","screencast-class-name"),this._titleElement.createTextChild(" "),this._nodeWidthElement=this._titleElement.createChild("span"),this._titleElement.createChild("span","screencast-px").textContent="px",this._titleElement.createTextChild(" × "),this._nodeHeightElement=this._titleElement.createChild("span"),this._titleElement.createChild("span","screencast-px").textContent="px",this._titleElement.style.top="0",this._titleElement.style.left="0",this._imageElement=new Image,this._isCasting=!1,this._context=this._canvasElement.getContext("2d"),this._checkerboardPattern=this._createCheckerboardPattern(this._context),this._shortcuts={},this._shortcuts[g.KeyboardShortcut.makeKey("l",g.Modifiers.Ctrl)]=this._focusNavigationBar.bind(this),e.TargetManager.instance().addEventListener(e.Events.SuspendStateChanged,this._onSuspendStateChange,this),this._updateGlasspane()}wasShown(){this._startCasting()}willHide(){this._stopCasting()}_startCasting(){if(e.TargetManager.instance().allTargetsSuspended())return;if(this._isCasting)return;this._isCasting=!0;const t=this._viewportDimensions();if(t.width<0||t.height<0)this._isCasting=!1;else{t.width*=window.devicePixelRatio,t.height*=window.devicePixelRatio,this._screenCaptureModel.startScreencast(Protocol.Page.StartScreencastRequestFormat.Jpeg,80,Math.floor(Math.min(2048,t.width)),Math.floor(Math.min(2048,t.height)),void 0,this._screencastFrame.bind(this),this._screencastVisibilityChanged.bind(this));for(const t of e.TargetManager.instance().models(o.EmulationModel))t.overrideEmulateTouch(!0);this._overlayModel&&this._overlayModel.setHighlighter(this)}}_stopCasting(){if(this._isCasting){this._isCasting=!1,this._screenCaptureModel.stopScreencast();for(const t of e.TargetManager.instance().models(o.EmulationModel))t.overrideEmulateTouch(!1);this._overlayModel&&this._overlayModel.setHighlighter(null)}}_screencastFrame(e,t){this._imageElement.onload=()=>{this._pageScaleFactor=t.pageScaleFactor,this._screenOffsetTop=t.offsetTop,this._scrollOffsetX=t.scrollOffsetX,this._scrollOffsetY=t.scrollOffsetY;const e=t.deviceHeight/t.deviceWidth,i=this._viewportDimensions();this._imageZoom=Math.min(i.width/this._imageElement.naturalWidth,i.height/(this._imageElement.naturalWidth*e)),this._viewportElement.classList.remove("hidden");const s=x;this._imageZoom<1.01/window.devicePixelRatio&&(this._imageZoom=1/window.devicePixelRatio),this._screenZoom=this._imageElement.naturalWidth*this._imageZoom/t.deviceWidth,this._viewportElement.style.width=t.deviceWidth*this._screenZoom+s+"px",this._viewportElement.style.height=t.deviceHeight*this._screenZoom+s+"px",this.highlightInOverlay({node:this._highlightNode},this._highlightConfig)},this._imageElement.src="data:image/jpg;base64,"+e}_isGlassPaneActive(){return!this._glassPaneElement.classList.contains("hidden")}_screencastVisibilityChanged(e){this._targetInactive=!e,this._updateGlasspane()}_onSuspendStateChange(t){e.TargetManager.instance().allTargetsSuspended()?this._stopCasting():this._startCasting(),this._updateGlasspane()}_updateGlasspane(){this._targetInactive?(this._glassPaneElement.textContent=h.UIString("The tab is inactive"),this._glassPaneElement.classList.remove("hidden")):e.TargetManager.instance().allTargetsSuspended()?(this._glassPaneElement.textContent=h.UIString("Profiling in progress"),this._glassPaneElement.classList.remove("hidden")):this._glassPaneElement.classList.add("hidden")}async _handleMouseEvent(e){if(this._isGlassPaneActive())return void e.consume();if(!this._pageScaleFactor||!this._domModel)return;if(!this._inspectModeConfig||"mousewheel"===e.type)return this._inputModel&&this._inputModel.emitTouchFromMouseEvent(e,this._screenOffsetTop,this._screenZoom),e.preventDefault(),void("mousedown"===e.type&&this._canvasElement.focus());const t=this._convertIntoScreenSpace(e),i=await this._domModel.nodeForLocation(Math.floor(t.x/this._pageScaleFactor+this._scrollOffsetX),Math.floor(t.y/this._pageScaleFactor+this._scrollOffsetY),r.Settings.instance().moduleSetting("showUAShadowDOM").get());i&&("mousemove"===e.type?(this.highlightInOverlay({node:i},this._inspectModeConfig),this._domModel.overlayModel().nodeHighlightRequested(i.id)):"click"===e.type&&this._domModel.overlayModel().inspectNodeRequested(i.backendNodeId()))}_handleKeyEvent(e){if(this._isGlassPaneActive())return void e.consume();const t=g.KeyboardShortcut.makeKeyFromEvent(e),i=this._shortcuts[t];i&&i(e)?e.consume():(this._inputModel&&this._inputModel.emitKeyEvent(e),e.consume(),this._canvasElement.focus())}_handleContextMenuEvent(e){e.consume(!0)}_handleBlurEvent(e){this._inputModel&&this._inputModel.cancelTouch()}_convertIntoScreenSpace(e){const t={};return t.x=Math.round(e.offsetX/this._screenZoom),t.y=Math.round(e.offsetY/this._screenZoom-this._screenOffsetTop),t}onResize(){this._deferredCasting&&(clearTimeout(this._deferredCasting),delete this._deferredCasting),this._stopCasting(),this._deferredCasting=setTimeout(this._startCasting.bind(this),100)}highlightInOverlay(e,t){this._highlightInOverlay(e,t)}async _highlightInOverlay(e,i){const{node:s,deferredNode:n,object:o}=e;let a=s;if(!a&&n&&(a=await n.resolvePromise()),!a&&o){const e=o.runtimeModel().target().model(t.DOMModel);e&&(a=await e.pushObjectAsNodeToFrontend(o))}if(this._highlightNode=a,this._highlightConfig=i,!a)return this._model=null,this._config=null,this._node=null,this._titleElement.classList.add("hidden"),void this._repaint();this._node=a,a.boxModel().then(e=>{e&&this._pageScaleFactor?(this._model=this._scaleModel(e),this._config=i,this._repaint()):this._repaint()})}_scaleModel(e){function t(e){for(let t=0;t<e.length;t+=2)e[t]=e[t]*this._pageScaleFactor*this._screenZoom,e[t+1]=(e[t+1]*this._pageScaleFactor+this._screenOffsetTop)*this._screenZoom}return t.call(this,e.content),t.call(this,e.padding),t.call(this,e.border),t.call(this,e.margin),e}_repaint(){const e=this._model,t=this._config,i=this._canvasElement.getBoundingClientRect().width,s=this._canvasElement.getBoundingClientRect().height;if(this._canvasElement.width=window.devicePixelRatio*i,this._canvasElement.height=window.devicePixelRatio*s,this._context.save(),this._context.scale(window.devicePixelRatio,window.devicePixelRatio),this._context.save(),this._context.fillStyle=this._checkerboardPattern,this._context.fillRect(0,0,i,this._screenOffsetTop*this._screenZoom),this._context.fillRect(0,this._screenOffsetTop*this._screenZoom+this._imageElement.naturalHeight*this._imageZoom,i,s),this._context.restore(),e&&t){this._context.save();const i="rgba(0, 0, 0, 0)",s=[];e.content&&t.contentColor!==i&&s.push({quad:e.content,color:t.contentColor}),e.padding&&t.paddingColor!==i&&s.push({quad:e.padding,color:t.paddingColor}),e.border&&t.borderColor!==i&&s.push({quad:e.border,color:t.borderColor}),e.margin&&t.marginColor!==i&&s.push({quad:e.margin,color:t.marginColor});for(let e=s.length-1;e>0;--e)this._drawOutlinedQuadWithClip(s[e].quad,s[e-1].quad,s[e].color);s.length>0&&this._drawOutlinedQuad(s[0].quad,s[0].color),this._context.restore(),this._drawElementTitle(),this._context.globalCompositeOperation="destination-over"}this._context.drawImage(this._imageElement,0,this._screenOffsetTop*this._screenZoom,this._imageElement.naturalWidth*this._imageZoom,this._imageElement.naturalHeight*this._imageZoom),this._context.restore()}_cssColor(e){return e?l.Color.fromRGBA([e.r,e.g,e.b,e.a]).asString(l.Format.RGBA)||"":"transparent"}_quadToPath(e){return this._context.beginPath(),this._context.moveTo(e[0],e[1]),this._context.lineTo(e[2],e[3]),this._context.lineTo(e[4],e[5]),this._context.lineTo(e[6],e[7]),this._context.closePath(),this._context}_drawOutlinedQuad(e,t){this._context.save(),this._context.lineWidth=2,this._quadToPath(e).clip(),this._context.fillStyle=this._cssColor(t),this._context.fill(),this._context.restore()}_drawOutlinedQuadWithClip(e,t,i){this._context.fillStyle=this._cssColor(i),this._context.save(),this._context.lineWidth=0,this._quadToPath(e).fill(),this._context.globalCompositeOperation="destination-out",this._context.fillStyle="red",this._quadToPath(t).fill(),this._context.restore()}_drawElementTitle(){if(!this._node)return;const e=this._canvasElement.getBoundingClientRect().width,t=this._canvasElement.getBoundingClientRect().height,i=this._node.localName()||this._node.nodeName().toLowerCase();this._tagNameElement.textContent=i,this._nodeIdElement.textContent=this._node.getAttribute("id")?"#"+this._node.getAttribute("id"):"",this._nodeIdElement.textContent=this._node.getAttribute("id")?"#"+this._node.getAttribute("id"):"";let s=this._node.getAttribute("class");s&&s.length>50&&(s=s.substring(0,50)+"…"),this._classNameElement.textContent=s||"",this._nodeWidthElement.textContent=this._model.width,this._nodeHeightElement.textContent=this._model.height,this._titleElement.classList.remove("hidden");const n=this._titleElement.offsetWidth+6,o=this._titleElement.offsetHeight+4,a=this._model.margin[1],h=this._model.margin[7];let r,l=!1,d=!1,c=Math.max(2,this._model.margin[0]);c+n>e&&(c=e-n-2),a>t?(r=t-o-7,d=!0):h<0?(r=7,l=!0):h+o+7<t?(r=h+7-4,l=!0):a-o-7>0?(r=a-o-7+3,d=!0):r=7,this._context.save(),this._context.translate(.5,.5),this._context.beginPath(),this._context.moveTo(c,r),l&&(this._context.lineTo(c+14,r),this._context.lineTo(c+21,r-7),this._context.lineTo(c+28,r)),this._context.lineTo(c+n,r),this._context.lineTo(c+n,r+o),d&&(this._context.lineTo(c+28,r+o),this._context.lineTo(c+21,r+o+7),this._context.lineTo(c+14,r+o)),this._context.lineTo(c,r+o),this._context.closePath(),this._context.fillStyle="rgb(255, 255, 194)",this._context.fill(),this._context.strokeStyle="rgb(128, 128, 128)",this._context.stroke(),this._context.restore(),this._titleElement.style.top=r+3+"px",this._titleElement.style.left=c+3+"px"}_viewportDimensions(){const e=x;return{width:this.element.offsetWidth-e-30,height:this.element.offsetHeight-e-30-b}}setInspectMode(e,t){return this._inspectModeConfig=e!==Protocol.Overlay.InspectMode.None?t:null,Promise.resolve()}highlightFrame(e){}_createCheckerboardPattern(e){const t=createElement("canvas");t.width=64,t.height=64;const i=t.getContext("2d");return i.fillStyle="rgb(195, 195, 195)",i.fillRect(0,0,64,64),i.fillStyle="rgb(225, 225, 225)",i.fillRect(0,0,32,32),i.fillRect(32,32,32,32),e.createPattern(t,"repeat")}_createNavigationBar(){this._navigationBar=this.element.createChild("div","screencast-navigation"),this._navigationBack=this._navigationBar.createChild("button","back"),this._navigationBack.disabled=!0,_.setAccessibleName(this._navigationBack,ls`back`),this._navigationForward=this._navigationBar.createChild("button","forward"),this._navigationForward.disabled=!0,_.setAccessibleName(this._navigationForward,ls`forward`),this._navigationReload=this._navigationBar.createChild("button","reload"),_.setAccessibleName(this._navigationReload,ls`reload`),this._navigationUrl=u.createInput(),_.setAccessibleName(this._navigationUrl,ls`Address bar`),this._navigationBar.appendChild(this._navigationUrl),this._navigationUrl.type="text",this._navigationProgressBar=new S(this._resourceTreeModel,this._networkManager,this._navigationBar.createChild("div","progress")),this._resourceTreeModel&&(this._navigationBack.addEventListener("click",this._navigateToHistoryEntry.bind(this,-1),!1),this._navigationForward.addEventListener("click",this._navigateToHistoryEntry.bind(this,1),!1),this._navigationReload.addEventListener("click",this._navigateReload.bind(this),!1),this._navigationUrl.addEventListener("keyup",this._navigationUrlKeyUp.bind(this),!0),this._requestNavigationHistory(),this._resourceTreeModel.addEventListener(s.Events.MainFrameNavigated,this._requestNavigationHistoryEvent,this),this._resourceTreeModel.addEventListener(s.Events.CachedResourcesLoaded,this._requestNavigationHistoryEvent,this))}_navigateToHistoryEntry(e){const t=this._historyIndex+e;t<0||t>=this._historyEntries.length||(this._resourceTreeModel.navigateToHistoryEntry(this._historyEntries[t]),this._requestNavigationHistory())}_navigateReload(){this._resourceTreeModel.reloadPage()}_navigationUrlKeyUp(e){if("Enter"!==e.key)return;let t=this._navigationUrl.value;t&&(t.match(T)||(t="http://"+t),this._resourceTreeModel.navigate(encodeURI(decodeURI(t))),this._canvasElement.focus())}_requestNavigationHistoryEvent(e){this._requestNavigationHistory()}async _requestNavigationHistory(){const e=await this._resourceTreeModel.navigationHistory();if(!e)return;this._historyIndex=e.currentIndex,this._historyEntries=e.entries,this._navigationBack.disabled=0===this._historyIndex,this._navigationForward.disabled=this._historyIndex===this._historyEntries.length-1;let t=this._historyEntries[this._historyIndex].url;const i=t.match(M);i&&(t=i[1]),f.InspectorFrontendHostInstance.inspectedURLChanged(t),this._navigationUrl.value=decodeURI(t)}_focusNavigationBar(){return this._navigationUrl.focus(),this._navigationUrl.select(),!0}}const x=44,b=29,M=/^http:\/\/(.+)/,T=/^(https?|about|chrome):/;class S{constructor(e,t,i){this._element=i,e&&(e.addEventListener(s.Events.MainFrameNavigated,this._onMainFrameNavigated,this),e.addEventListener(s.Events.Load,this._onLoad,this)),t&&(t.addEventListener(n.Events.RequestStarted,this._onRequestStarted,this),t.addEventListener(n.Events.RequestFinished,this._onRequestFinished,this))}_onMainFrameNavigated(){this._requestIds={},this._startedRequests=0,this._finishedRequests=0,this._maxDisplayedProgress=0,this._updateProgress(.1)}_onLoad(){delete this._requestIds,this._updateProgress(1),setTimeout(function(){this._navigationProgressVisible()||this._displayProgress(0)}.bind(this),500)}_navigationProgressVisible(){return!!this._requestIds}_onRequestStarted(e){if(!this._navigationProgressVisible())return;const t=e.data.request;t.resourceType()!==d.resourceTypes.WebSocket&&(this._requestIds[t.requestId()]=t,++this._startedRequests)}_onRequestFinished(e){if(!this._navigationProgressVisible())return;e.data.requestId()in this._requestIds&&(++this._finishedRequests,setTimeout(function(){this._updateProgress(this._finishedRequests/this._startedRequests*.9)}.bind(this),500))}_updateProgress(e){this._navigationProgressVisible()&&(this._maxDisplayedProgress>=e||(this._maxDisplayedProgress=e,this._displayProgress(e)))}_displayProgress(e){this._element.style.width=100*e+"%"}}var P=Object.freeze({__proto__:null,ScreencastView:w,_bordersSize:x,_navBarHeight:b,_HttpRegex:M,_SchemeRegex:T,ProgressTracker:S});let R;class k{constructor(){this._enabledSetting=r.Settings.instance().createSetting("screencastEnabled",!0),this._toggleButton=new m.ToolbarToggle(h.UIString("Toggle screencast"),"largeicon-phone"),this._toggleButton.setToggled(this._enabledSetting.get()),this._toggleButton.setEnabled(!1),this._toggleButton.addEventListener(m.ToolbarButton.Events.Click,this._toggleButtonClicked,this),e.TargetManager.instance().observeModels(a.ScreenCaptureModel,this)}static _instance(){return R||(R=new k),R}presentUI(e){const t=new v.RootView;this._rootSplitWidget=new p.SplitWidget(!1,!0,"InspectorView.screencastSplitViewState",300,300),this._rootSplitWidget.setVertical(!0),this._rootSplitWidget.setSecondIsSidebar(!0),this._rootSplitWidget.show(t.element),this._rootSplitWidget.hideMain(),this._rootSplitWidget.setSidebarWidget(E.InspectorView.instance()),E.InspectorView.instance().setOwnerSplit(this._rootSplitWidget),t.attachToDocument(e),t.focus()}modelAdded(e){this._screenCaptureModel||(this._screenCaptureModel=e,this._toggleButton.setEnabled(!0),this._screencastView=new w(e),this._rootSplitWidget.setMainWidget(this._screencastView),this._screencastView.initialize(),this._onScreencastEnabledChanged())}modelRemoved(e){this._screenCaptureModel===e&&(delete this._screenCaptureModel,this._toggleButton.setEnabled(!1),this._screencastView.detach(),delete this._screencastView,this._onScreencastEnabledChanged())}_toggleButtonClicked(){const e=!this._toggleButton.toggled();this._enabledSetting.set(e),this._onScreencastEnabledChanged()}_onScreencastEnabledChanged(){if(!this._rootSplitWidget)return;const e=this._enabledSetting.get()&&this._screencastView;this._toggleButton.setToggled(e),e?this._rootSplitWidget.showBoth():this._rootSplitWidget.hideMain()}}var I=Object.freeze({__proto__:null,ScreencastApp:k,ToolbarButtonProvider:class{item(){return k._instance()._toggleButton}},ScreencastAppProvider:class{createApp(){return k._instance()}}});export{C as InputModel,I as ScreencastApp,P as ScreencastView};
