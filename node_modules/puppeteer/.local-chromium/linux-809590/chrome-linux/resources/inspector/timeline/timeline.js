import{OverlayModel as e,TracingModel as t,TracingManager as i,SDKModel as n,CPUProfilerModel as s,RuntimeModel as a,PaintProfiler as r,DOMModel as o,ResourceTreeModel as l,NetworkManager as h,DebuggerModel as d,FilmStripModel as c}from"../sdk/sdk.js";import{UIString as m,Console as u,Settings as p,ParsedURL as _,ObjectWrapper as g,Color as f,EventTarget as v,Linkifier as T}from"../common/common.js";import{TimelineOverviewPane as w,FlameChart as S,NetworkPriorities as y,LineLevelProfile as C,PieChart as b,FilmStripView as k,TimelineGrid as E}from"../perf_ui/perf_ui.js";import{NumberUtilities as M,DateUtilities as R,SetUtilities as P,StringUtilities as x}from"../platform/platform.js";import{TimelineJSProfile as L,TimelineModel as I,TimelineModelFilter as F,TimelineProfileTree as D,TimelineIRModel as U,TimelineFrameModel as N}from"../timeline_model/timeline_model.js";import{UIUtils as B,Widget as W,SplitWidget as V,Toolbar as A,ARIAUtils as G,Geometry as H,TabbedPane as O,Fragment as z,Utils as j,ActionRegistry as q,GlassPane as $,ListModel as J,ListControl as X,Icon as K,Action as Y,Panel as Q,DropTarget as Z,SearchableView as ee,Context as te,ContextMenu as ie,ViewManager as ne,XLink as se,ShortcutRegistry as ae,TreeOutline as re}from"../ui/ui.js";import{TempFile as oe,FileUtils as le,BlackboxManager as he,ResourceUtils as de,DebuggerWorkspaceBinding as ce}from"../bindings/bindings.js";import{Linkifier as me,ImagePreview as ue,JSPresentationUtils as pe}from"../components/components.js";import{ExtensionServer as _e}from"../extensions/extensions.js";import{ResourceLoader as ge,Platform as fe,userMetrics as ve,UserMetrics as Te}from"../host/host.js";import{ThrottlingManager as we}from"../mobile_throttling/mobile_throttling.js";import{InspectorBackend as Se}from"../protocol_client/protocol_client.js";import{TextUtils as ye}from"../text_utils/text_utils.js";import{CoverageModel as Ce}from"../coverage/coverage.js";import{SortableDataGrid as be,DataGrid as ke,ViewportDataGrid as Ee}from"../data_grid/data_grid.js";import{LayerViewHost as Me,LayerTreeOutline as Re,Layers3DView as Pe,LayerDetailsView as xe,PaintProfilerView as Le,TransformController as Ie}from"../layer_viewer/layer_viewer.js";import{ThemeSupport as Fe}from"../theme_support/theme_support.js";class De{constructor([e,t,i,n]){this.x=e,this.y=t,this.width=i,this.height=n,this.color={r:238,g:111,b:99,a:.4},this.outlineColor={r:238,g:111,b:99,a:.7}}}var Ue=Object.freeze({__proto__:null,CLSRect:De,Linkifier:class{linkify(t,i){const n=document.createElement("span"),s=t,{x:a,y:r,width:o,height:l}=s;return n.textContent=`Location: [${a},${r}], Size: [${o}x${l}]`,n.addEventListener("mouseover",()=>e.OverlayModel.highlightRect(s)),n.addEventListener("mouseleave",()=>e.OverlayModel.clearHighlight()),n}}});class Ne{constructor(e){this._client=e,this._backingStorage=new oe.TempFileBackingStorage,this._tracingModel=new t.TracingModel(this._backingStorage),this._canceledCallback=null,this._state=We.Initial,this._buffer="",this._firstRawChunk=!0,this._firstChunk=!0,this._loadedBytes=0,this._totalSize,this._jsonTokenizer=new ye.BalancedJSONTokenizer(this._writeBalancedJSON.bind(this),!0)}static loadFromFile(e,t){const i=new Ne(t),n=new le.ChunkedFileReader(e,Be);return i._canceledCallback=n.cancel.bind(n),i._totalSize=e.size,n.read(i).then(e=>{e||i._reportErrorAndCancelLoading(n.error().message)}),i}static loadFromEvents(e,t){const i=new Ne(t);return setTimeout(async()=>{t.loadingStarted();for(let n=0;n<e.length;n+=5e3){const s=e.slice(n,n+5e3);i._tracingModel.addEvents(s),t.loadingProgress((n+s.length)/e.length),await new Promise(e=>setTimeout(e))}i.close()}),i}static loadFromURL(e,t){const i=new Ne(t);return ge.loadAsStream(e,null,i),i}cancel(){this._tracingModel=null,this._backingStorage.reset(),this._client.loadingComplete(null),this._client=null,this._canceledCallback&&this._canceledCallback()}write(e){if(!this._client)return Promise.resolve();if(this._loadedBytes+=e.length,this._firstRawChunk?this._client.loadingStarted():this._client.loadingProgress(this._totalSize?this._loadedBytes/this._totalSize:void 0),this._firstRawChunk=!1,this._state===We.Initial)if(e.startsWith('{"nodes":['))this._state=We.LoadingCPUProfileFormat;else if("{"===e[0])this._state=We.LookingForEvents;else{if("["!==e[0])return this._reportErrorAndCancelLoading(m.UIString("Malformed timeline data: Unknown JSON format")),Promise.resolve();this._state=We.ReadingEvents}if(this._state===We.LoadingCPUProfileFormat)return this._buffer+=e,Promise.resolve();if(this._state===We.LookingForEvents){const t='"traceEvents":',i=this._buffer.length-t.length;this._buffer+=e;const n=this._buffer.indexOf(t,i);if(-1===n)return Promise.resolve();e=this._buffer.slice(n+t.length),this._state=We.ReadingEvents}return this._state!==We.ReadingEvents||this._jsonTokenizer.write(e)||(this._state=We.SkippingTail,this._firstChunk&&this._reportErrorAndCancelLoading(m.UIString("Malformed timeline input, wrong JSON brackets balance"))),Promise.resolve()}_writeBalancedJSON(e){let t,i=e+"]";if(!this._firstChunk){const e=i.indexOf(",");-1!==e&&(i=i.slice(e+1)),i="["+i}try{t=JSON.parse(i)}catch(e){return void this._reportErrorAndCancelLoading(m.UIString("Malformed timeline data: %s",e.toString()))}if(this._firstChunk&&(this._firstChunk=!1,this._looksLikeAppVersion(t[0])))this._reportErrorAndCancelLoading(m.UIString("Legacy Timeline format is not supported."));else try{this._tracingModel.addEvents(t)}catch(e){this._reportErrorAndCancelLoading(m.UIString("Malformed timeline data: %s",e.toString()))}}_reportErrorAndCancelLoading(e){e&&u.Console.instance().error(e),this.cancel()}_looksLikeAppVersion(e){return"string"==typeof e&&-1!==e.indexOf("Chrome")}async close(){this._client&&(this._client.processingStarted(),setTimeout(()=>this._finalizeTrace(),0))}_finalizeTrace(){this._state===We.LoadingCPUProfileFormat&&(this._parseCPUProfileFormat(this._buffer),this._buffer=""),this._tracingModel.tracingComplete(),this._client.loadingComplete(this._tracingModel)}_parseCPUProfileFormat(e){let t;try{const i=JSON.parse(e);t=L.TimelineJSProfileProcessor.buildTraceProfileFromCpuProfile(i,1,!0)}catch(e){return void this._reportErrorAndCancelLoading(m.UIString("Malformed CPU profile format"))}this._tracingModel.addEvents(t)}}const Be=5e6;const We={Initial:Symbol("Initial"),LookingForEvents:Symbol("LookingForEvents"),ReadingEvents:Symbol("ReadingEvents"),SkippingTail:Symbol("SkippingTail"),LoadingCPUProfileFormat:Symbol("LoadingCPUProfileFormat")};var Ve=Object.freeze({__proto__:null,TimelineLoader:Ne,TransferChunkLengthBytes:Be,Client:class{loadingStarted(){}loadingProgress(e){}processingStarted(){}loadingComplete(e){}},State:We});class Ae{constructor(e,t){this._provider=e,this._performanceModel=t,this._completionCallback,this._completionPromise=new Promise(e=>{this._completionCallback=e}),this._timeOffset=0}loadingStarted(){}processingStarted(){}loadingProgress(e){}loadingComplete(e){e&&(this._performanceModel.addExtensionEvents(this._provider.longDisplayName(),e,this._timeOffset),this._completionCallback())}complete(e,t){e?(this._timeOffset=t,Ne.loadFromURL(e,this)):this._completionCallback()}start(){this._provider.start(this)}stop(){return this._provider.stop(),this._completionPromise}}var Ge=Object.freeze({__proto__:null,ExtensionTracingSession:Ae});class He{constructor(e,a){this._target=e,this._tracingManager=e.model(i.TracingManager),this._performanceModel=new ui,this._performanceModel.setMainTarget(e),this._client=a;const r=new oe.TempFileBackingStorage;this._tracingModel=new t.TracingModel(r),this._extensionSessions=[],n.TargetManager.instance().observeModels(s.CPUProfilerModel,this)}dispose(){n.TargetManager.instance().unobserveModels(s.CPUProfilerModel,this)}mainTarget(){return this._target}async startRecording(e,t){function i(e){return"disabled-by-default-"+e}this._extensionTraceProviders=_e.ExtensionServer.instance().traceProviders().slice();const s=["-*","devtools.timeline",i("devtools.timeline"),i("devtools.timeline.frame"),"v8.execute",I.TimelineModelImpl.Category.Console,I.TimelineModelImpl.Category.UserTiming,I.TimelineModelImpl.Category.Loading];s.push(I.TimelineModelImpl.Category.LatencyInfo),Root.Runtime.experiments.isEnabled("timelineFlowEvents")&&s.push("devtools.timeline.async"),Root.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats")&&e.enableJSSampling&&s.push(i("v8.runtime_stats_sampling")),!Root.Runtime.queryParam("timelineTracingJSProfileDisabled")&&e.enableJSSampling&&s.push(i("v8.cpu_profiler")),s.push(i("devtools.timeline.stack")),Root.Runtime.experiments.isEnabled("timelineInvalidationTracking")&&s.push(i("devtools.timeline.invalidationTracking")),e.capturePictures&&s.push(i("devtools.timeline.layers"),i("devtools.timeline.picture"),i("blink.graphics_context_annotations")),e.captureFilmStrip&&s.push(i("devtools.screenshot")),this._extensionSessions=t.map(e=>new Ae(e,this._performanceModel)),this._extensionSessions.forEach(e=>e.start()),this._performanceModel.setRecordStartTime(Date.now());const a=await this._startRecordingWithCategories(s.join(","),e.enableJSSampling);return a[Se.ProtocolError]&&(await this._waitForTracingToStop(!1),await n.TargetManager.instance().resumeAllTargets()),a}async stopRecording(){return this._tracingManager&&this._tracingManager.stop(),this._client.loadingStarted(),await this._waitForTracingToStop(!0),this._allSourcesFinished(),this._performanceModel}_waitForTracingToStop(e){const t=[];this._tracingManager&&e&&t.push(new Promise(e=>{this._tracingCompleteCallback=e})),t.push(this._stopProfilingOnAllModels());const i=this._extensionSessions.map(e=>e.stop());return i.length&&t.push(Promise.race([Promise.all(i),new Promise(e=>setTimeout(e,5e3))])),Promise.all(t)}modelAdded(e){this._profiling&&e.startRecording()}modelRemoved(e){}_startProfilingOnAllModels(){this._profiling=!0;const e=n.TargetManager.instance().models(s.CPUProfilerModel);return Promise.all(e.map(e=>e.startRecording()))}_addCpuProfile(e,t){t?(this._cpuProfiles||(this._cpuProfiles=new Map),this._cpuProfiles.set(e,t)):u.Console.instance().warn(m.UIString("CPU profile for a target is not available."))}_stopProfilingOnAllModels(){const e=this._profiling?n.TargetManager.instance().models(s.CPUProfilerModel):[];this._profiling=!1;const t=[];for(const i of e){const e=i.target().id(),n=i.stopRecording().then(this._addCpuProfile.bind(this,e));t.push(n)}return Promise.all(t)}async _startRecordingWithCategories(e,t){if(await n.TargetManager.instance().suspendAllTargets("performance-timeline"),t&&Root.Runtime.queryParam("timelineTracingJSProfileDisabled")&&await this._startProfilingOnAllModels(),this._tracingManager)return this._tracingManager.start(this,e,"")}traceEventsCollected(e){this._tracingModel.addEvents(e)}tracingComplete(){this._tracingCompleteCallback(),this._tracingCompleteCallback=null}_allSourcesFinished(){this._client.processingStarted(),setTimeout(()=>this._finalizeTrace(),0)}async _finalizeTrace(){this._injectCpuProfileEvents(),await n.TargetManager.instance().resumeAllTargets(),this._tracingModel.tracingComplete(),this._client.loadingComplete(this._tracingModel)}_injectCpuProfileEvent(e,i,n){if(!n)return;const s={cat:t.DevToolsMetadataEventCategory,ph:t.Phase.Instant,ts:1e3*this._tracingModel.maximumRecordTime(),pid:e,tid:i,name:I.RecordType.CpuProfile,args:{data:{cpuProfile:n}}};this._tracingModel.addEvents([s])}_buildTargetToProcessIdMap(){const e=I.TimelineModelImpl.DevToolsMetadataEvent,t=this._tracingModel.devToolsMetadataEvents(),i=t.find(t=>t.name===e.TracingStartedInBrowser);if(!i)return null;const s=new Platform.Multimap,a=new Map,r=i.args.data.frames;for(const e of r)a.set(e.frame,e.processId);for(const i of t){const t=i.args.data;switch(i.name){case e.FrameCommittedInBrowser:t.processId?a.set(t.frame,t.processId):s.set(t.processPseudoId,t.frame);break;case e.ProcessReadyInBrowser:for(const e of s.get(t.processPseudoId)||[])a.set(e,t.processId)}}const o=r.find(e=>!e.parent).processId,l=this._tracingModel.processById(o);return l&&a.set(n.TargetManager.instance().mainTarget().id(),l.id()),a}_injectCpuProfileEvents(){if(!this._cpuProfiles)return;const e=I.TimelineModelImpl.DevToolsMetadataEvent,t=this._tracingModel.devToolsMetadataEvents(),i=this._buildTargetToProcessIdMap();if(i)for(const[e,t]of this._cpuProfiles){const n=i.get(e);if(!n)continue;const s=this._tracingModel.processById(n),a=s&&s.threadByName(I.TimelineModelImpl.RendererMainThreadName);a&&this._injectCpuProfileEvent(n,a.id(),t)}else{const i=t.filter(t=>t.name===e.TracingStartedInPage).peekLast();if(i){const e=i.thread.process().id(),t=this._cpuProfiles.get(this._tracingManager.target().id());this._injectCpuProfileEvent(e,i.thread.id(),t)}else{let e=0;for(const t of this._cpuProfiles){const i=n.TargetManager.instance().targetById(t[0]),s=i&&i.name();this._tracingModel.addEvents(L.TimelineJSProfileProcessor.buildTraceProfileFromCpuProfile(t[1],++e,1===e,s))}}}const s=t.filter(t=>t.name===e.TracingSessionIdForWorker);for(const e of s){const t=e.args.data.workerId,i=this._cpuProfiles.get(t);this._injectCpuProfileEvent(e.thread.process().id(),e.args.data.workerThreadId,i)}this._cpuProfiles=null}tracingBufferUsage(e){this._client.recordingProgress(e)}eventsRetrievalProgress(e){this._client.loadingProgress(e)}}var Oe=Object.freeze({__proto__:null,TimelineController:He,Client:class{recordingProgress(e){}},RecordingOptions:void 0});class ze extends w.TimelineOverviewBase{constructor(e,t){super(),this.element.id="timeline-overview-"+e,this.element.classList.add("overview-strip"),this._model=null,t&&(this.element.createChild("div","timeline-overview-strip-title").textContent=t)}setModel(e){this._model=e}_renderBar(e,t,i,n,s){const a=e,r=t-e,o=this.context();o.fillStyle=s,o.fillRect(a,i,r,n)}}class je extends ze{constructor(){super("input",null)}update(){if(super.update(),!this._model)return;const e=this.height(),t=ii.eventDispatchDesciptors(),i=new Map;let n=-1;for(const e of t){for(const t of e.eventTypes)i.set(t,e);n=Math.max(n,e.priority)}const s=2*window.devicePixelRatio,a=this._model.timelineModel().minimumRecordTime(),r=this._model.timelineModel().maximumRecordTime()-a,o=this.width(),l=o/r;for(let t=0;t<=n;++t)for(const n of this._model.timelineModel().tracks())for(let r=0;r<n.events.length;++r){const h=n.events[r];if(h.name!==I.RecordType.EventDispatch)continue;const d=i.get(h.args.data.type);if(!d||d.priority!==t)continue;const c=M.clamp(Math.floor((h.startTime-a)*l),0,o),m=M.clamp(Math.ceil((h.endTime-a)*l),0,o),u=Math.max(m-c,s);this._renderBar(c,c+u,0,e,d.color)}}}class qe extends ze{constructor(){super("network",m.UIString("NET"))}update(){if(super.update(),!this._model)return;const e=this._model.timelineModel(),t=this.height()/2,i=e.minimumRecordTime(),n=e.maximumRecordTime()-i,s=this.width(),a=s/n,r=new Path2D,o=new Path2D,l=Protocol.Network.ResourcePriority,h=new Set([l.VeryHigh,l.High,l.Medium]);for(const n of e.networkRequests()){const e=h.has(n.priority)?r:o,l=Math.max(Math.floor((n.startTime-i)*a),0),d=Math.min(Math.ceil((n.endTime-i)*a+1),s);e.rect(l,0,d-l,t-1)}const d=this.context();d.save(),d.fillStyle="hsl(214, 60%, 60%)",d.fill(r),d.translate(0,t),d.fillStyle="hsl(214, 80%, 80%)",d.fill(o),d.restore()}}class $e extends ze{constructor(){super("cpu-activity",m.UIString("CPU")),this._backgroundCanvas=this.element.createChild("canvas","fill background")}resetCanvas(){super.resetCanvas(),this._backgroundCanvas.width=this.element.clientWidth*window.devicePixelRatio,this._backgroundCanvas.height=this.element.clientHeight*window.devicePixelRatio}update(){if(super.update(),!this._model)return;const e=this._model.timelineModel(),t=4*window.devicePixelRatio,i=this.width(),n=this.height(),s=n,a=e.minimumRecordTime(),r=e.maximumRecordTime()-a,o=t/(i/r),l=ii.categories(),h=ii.getTimelineMainEventCategories(),d=h.indexOf("other");console.assert(0===h.indexOf("idle"));for(let e=1;e<h.length;++e)l[h[e]]._overviewIndex=e;const c=this._backgroundCanvas.getContext("2d");for(const t of e.tracks())t.type===I.TrackType.MainThread&&t.forMainFrame?m(this.context(),t.events):m(c,t.events);function m(e,c){const m=new Qe(a,o,(function(e){let i=s;for(let s=1;s<h.length;++s){const a=(e[s]||0)/o*n;i-=a,_[s].bezierCurveTo(u,g[s],u,i,u+t/2,i),g[s]=i}u+=t}));let u=0;const p=[],_=[],g=[];for(let e=0;e<h.length;++e)_[e]=new Path2D,_[e].moveTo(0,n),g[e]=n;I.TimelineModelImpl.forEachEvent(c,(function(e){const t=p.length?p.peekLast():0;m.appendInterval(e.startTime,t),p.push(ii.eventStyle(e).category._overviewIndex||d)}),(function(e){m.appendInterval(e.endTime,p.pop())})),m.appendInterval(a+r+o,0);for(let t=h.length-1;t>0;--t)_[t].lineTo(i,n),e.fillStyle=l[h[t]].color,e.fill(_[t])}!function(e){const t=4*window.devicePixelRatio;e.save(),e.lineWidth=t/Math.sqrt(8);for(let s=.5;s<i+n;s+=t)e.moveTo(s,0),e.lineTo(s-n,n);e.globalCompositeOperation="destination-out",e.stroke(),e.restore()}(c)}}class Je extends ze{constructor(){super("responsiveness",null)}update(){if(super.update(),!this._model)return;const e=this.height(),t=this._model.timelineModel().minimumRecordTime(),i=this._model.timelineModel().maximumRecordTime()-t,n=this.width()/i,s=this._model.frames(),a=this.context(),r=new Path2D,o=new Path2D;for(let e=0;e<s.length;++e){const t=s[e];t.hasWarnings()&&l(t.startTime,t.duration)}for(const e of this._model.timelineModel().tracks()){const t=e.events;for(let e=0;e<t.length;++e)I.TimelineData.forEvent(t[e]).warning&&l(t[e].startTime,t[e].duration)}function l(i,s){const a=Math.round(n*(i-t)),l=Math.round(n*s);r.rect(a,0,l,e),o.moveTo(a+l,0),o.lineTo(a+l,e)}a.fillStyle="hsl(0, 80%, 90%)",a.strokeStyle="red",a.lineWidth=2*window.devicePixelRatio,a.fill(r),a.stroke(o)}}class Xe extends ze{constructor(){super("filmstrip",null),this.reset()}update(){super.update();const e=this._model?this._model.filmStripModel().frames():[];if(!e.length)return;const t=Symbol("drawGeneration");this._drawGeneration=t,this._imageByFrame(e[0]).then(e=>{if(this._drawGeneration!==t)return;if(!e||!e.naturalWidth||!e.naturalHeight)return;const i=this.height()-2*Xe.Padding,n=Math.ceil(i*e.naturalWidth/e.naturalHeight),s=Math.min(200/e.naturalWidth,1);this._emptyImage=new Image(e.naturalWidth*s,e.naturalHeight*s),this._drawFrames(n,i)})}_imageByFrame(e){let t=this._frameToImagePromise.get(e);return t||(t=e.imageDataPromise().then(e=>B.loadImageFromData(e)),this._frameToImagePromise.set(e,t)),t}_drawFrames(e,t){if(!e||!this._model)return;const i=this._model.filmStripModel();if(!i.frames().length)return;const n=Xe.Padding,s=this.width(),a=i.zeroTime(),r=i.spanTime()/s,o=this.context(),l=this._drawGeneration;o.beginPath();for(let l=n;l<s;l+=e+2*n){const n=a+(l+e/2)*r,s=i.frameByTimestamp(n);s&&(o.rect(l-.5,.5,e+1,t+1),this._imageByFrame(s).then(h.bind(this,l)))}function h(i,n){this._drawGeneration===l&&n&&o.drawImage(n,i,1,e,t)}o.strokeStyle="#ddd",o.stroke()}overviewInfoPromise(e){if(!this._model||!this._model.filmStripModel().frames().length)return Promise.resolve(null);const t=this.calculator().positionToTime(e),i=this._model.filmStripModel().frameByTimestamp(t);if(i===this._lastFrame)return Promise.resolve(this._lastElement);return(i?this._imageByFrame(i):Promise.resolve(this._emptyImage)).then(function(e){const t=document.createElement("div");t.classList.add("frame"),e&&t.createChild("div","thumbnail").appendChild(e);return this._lastFrame=i,this._lastElement=t,t}.bind(this))}reset(){this._lastFrame=void 0,this._lastElement=null,this._frameToImagePromise=new Map,this._imageWidth=0}}Xe.Padding=2;class Ke extends ze{constructor(){super("framerate",m.UIString("FPS"))}update(){if(super.update(),!this._model)return;const e=this._model.frames();if(!e.length)return;const t=this.height(),i=1*window.devicePixelRatio,n=t-2*i,s=this._model.timelineModel().minimumRecordTime(),a=this._model.timelineModel().maximumRecordTime()-s,r=this.width()/a,o=t-i,l=this.context(),h=o+10*window.devicePixelRatio;let d=0,c=h;const m=window.devicePixelRatio,u=1&m?.5:0,p=1.5*window.devicePixelRatio;l.beginPath(),l.moveTo(0,c);for(let t=0;t<e.length;++t){const i=e[t];d=Math.round((i.startTime-s)*r)+u,l.lineTo(d,c),l.lineTo(d,c+p),c=i.idle?h:Math.round(o-n*Math.min(1e3/60/i.duration,1))-u,l.lineTo(d,c+p),l.lineTo(d,c)}const _=e.peekLast();d=Math.round((_.startTime+_.duration-s)*r)+u,l.lineTo(d,c),l.lineTo(d,h),l.fillStyle="hsl(110, 50%, 88%)",l.strokeStyle="hsl(110, 50%, 60%)",l.lineWidth=m,l.fill(),l.stroke()}}class Ye extends ze{constructor(){super("memory",m.UIString("HEAP")),this._heapSizeLabel=this.element.createChild("div","memory-graph-label")}resetHeapSizeLabels(){this._heapSizeLabel.textContent=""}update(){super.update();const e=window.devicePixelRatio;if(!this._model)return void this.resetHeapSizeLabels();const t=this._model.timelineModel().tracks().filter(e=>e.type===I.TrackType.MainThread&&e.forMainFrame).map(e=>e.events),i=3*e;let n=0,s=1e11;const a=this._model.timelineModel().minimumRecordTime(),r=this._model.timelineModel().maximumRecordTime();function o(e){return e.name===I.RecordType.UpdateCounters}for(let e=0;e<t.length;e++)t[e]=t[e].filter(o);function l(e){const t=e.args.data;t&&t.jsHeapSizeUsed&&(n=Math.max(n,t.jsHeapSizeUsed),s=Math.min(s,t.jsHeapSizeUsed))}for(let e=0;e<t.length;e++)t[e].forEach(l);s=Math.min(s,n);const h=this.width(),d=this.height()-i,c=h/(r-a),u=(d-1)/Math.max(n-s,1),p=new Array(h);function _(e){const t=e.args.data;if(!t||!t.jsHeapSizeUsed)return;const i=Math.round((e.startTime-a)*c),n=Math.round((t.jsHeapSizeUsed-s)*u);p[i]=Math.max(p[i]||0,n)}for(let e=0;e<t.length;e++)t[e].forEach(_);const g=this.context(),f=d+i+1;g.translate(.5,.5),g.beginPath(),g.moveTo(-1,f);let v=0,T=!0,w=0;for(let e=0;e<p.length;e++){if(void 0===p[e])continue;T&&(T=!1,v=p[e],g.lineTo(-1,d-v));const t=p[e];Math.abs(t-v)>2&&Math.abs(e-w)>1&&g.lineTo(e,d-v),v=t,g.lineTo(e,d-v),w=e}g.lineTo(h+1,d-v),g.lineTo(h+1,f),g.closePath(),g.fillStyle="hsla(220, 90%, 70%, 0.2)",g.fill(),g.lineWidth=1,g.strokeStyle="hsl(220, 90%, 70%)",g.stroke(),this._heapSizeLabel.textContent=m.UIString("%s – %s",M.bytesToString(s),M.bytesToString(n))}}class Qe{constructor(e,t,i){this._lastTime=e,this._quantDuration=t,this._callback=i,this._counters=[],this._remainder=t}appendInterval(e,t){let i=e-this._lastTime;if(i<=this._remainder)return this._counters[t]=(this._counters[t]||0)+i,this._remainder-=i,void(this._lastTime=e);for(this._counters[t]=(this._counters[t]||0)+this._remainder,this._callback(this._counters),i-=this._remainder;i>=this._quantDuration;){const e=[];e[t]=this._quantDuration,this._callback(e),i-=this._quantDuration}this._counters=[],this._counters[t]=i,this._lastTime=e,this._remainder=this._quantDuration-i}}class Ze extends ze{constructor(){super("coverage",m.UIString("COVERAGE")),this._heapSizeLabel=this.element.createChild("div","timeline-overview-coverage-label")}resetHeapSizeLabels(){this._heapSizeLabel.textContent=""}setModel(e){super.setModel(e),this._model&&(this._coverageModel=e.mainTarget().model(Ce.CoverageModel))}update(){super.update();const e=window.devicePixelRatio;if(!this._coverageModel)return;let t=0,i=0;const n=new Map,s=new Map;for(const e of this._coverageModel.entries())for(const a of e.entries()){t+=a.size();for(const[e,t]of a.usedByTimestamp())i+=t,s.has(e)||s.set(e,new Set),s.get(e).add(a),n.has(e)?n.set(e,n.get(e)+t):n.set(e,t)}const a=new Set,r=new Map;let o=0,l=0;const h=Array.from(s.entries()).sort((e,t)=>e[0]-t[0]);for(const[e,t]of h){for(const e of t.values())a.has(e)||(a.add(e),o+=e.size());l+=n.get(e),r.set(e,l/o)}const d=t?Math.round(100*i/t):0,c=3*e,m=this._model.timelineModel().minimumRecordTime()/1e3,u=this._model.timelineModel().maximumRecordTime()/1e3,p=this.width(),_=this.height()-c,g=p/(u-m),f=_-1;let v=0;const T=this.context(),w=_+c+1;T.translate(.5,.5),T.beginPath(),T.moveTo(-1,w),T.lineTo(-1,_-v);let S=null;for(const e of this._coverageModel.coverageUpdateTimes()){const t=r.get(e)||S;if(S=t,!t)continue;if(e>u)break;const i=(e-m)*g;v=t*f,T.lineTo(i,_-v)}const y="hsl(220, 90%, 70%)";T.lineTo(p+1,_-v),T.lineTo(p+1,w),T.closePath(),T.fillStyle="hsla(220, 90%, 70%, 0.2)",T.fill(),T.lineWidth=1,T.strokeStyle=y,T.stroke(),S=null;for(const e of this._coverageModel.coverageUpdateTimes()){const t=r.get(e)||S;if(S=t,!t)continue;T.beginPath();const i=(e-m)*g,n=_-t*f;T.arc(i,n,2,0,2*Math.PI,!1),T.closePath(),T.stroke(),T.fillStyle=r.has(e)?y:"hsl(0, 100%, 100%)",T.fill()}this._heapSizeLabel.textContent=d+"% used"}}var et=Object.freeze({__proto__:null,TimelineEventOverview:ze,TimelineEventOverviewInput:je,TimelineEventOverviewNetwork:qe,TimelineEventOverviewCPUActivity:$e,TimelineEventOverviewResponsiveness:Je,TimelineFilmStripOverview:Xe,TimelineEventOverviewFrames:Ke,TimelineEventOverviewMemory:Ye,Quantizer:Qe,TimelineEventOverviewCoverage:Ze});class tt extends F.TimelineModelFilter{constructor(){super(),this._minimumRecordDuration=0}setMinimumRecordDuration(e){this._minimumRecordDuration=e}accept(e){return(e.endTime?e.endTime-e.startTime:0)>=this._minimumRecordDuration}}class it extends F.TimelineModelFilter{constructor(){super()}accept(e){return!ii.eventStyle(e).category.hidden}}class nt extends F.TimelineModelFilter{constructor(e){super(),this._regExp,this.setRegExp(e||null)}setRegExp(e){this._regExp=e}regExp(){return this._regExp}accept(e){return!this._regExp||ii.testContentMatching(e,this._regExp)}}var st=Object.freeze({__proto__:null,IsLong:tt,Category:it,TimelineRegExp:nt});class at extends W.VBox{constructor(){super(),this._model=null,this._track=null,this._tree=null,this.element.classList.add("timeline-tree-view")}static eventNameForSorting(e){if(e.name===I.RecordType.JSFrame){const t=e.args.data;return t.functionName+"@"+(t.scriptId||t.url||"")}return e.name+":@"+D.eventURL(e)}setSearchableView(e){this._searchableView=e}setModel(e,t){this._model=e,this._track=t,this.refreshTree()}getToolbarInputAccessiblePlaceHolder(){return""}model(){return this._model}init(){this._linkifier=new me.Linkifier,this._taskFilter=new F.ExclusiveNameFilter([I.RecordType.Task]),this._textFilter=new nt,this._currentThreadSetting=p.Settings.instance().createSetting("timelineTreeCurrentThread",0),this._currentThreadSetting.addChangeListener(this.refreshTree,this);const e=[];this.populateColumns(e),this._splitWidget=new V.SplitWidget(!0,!0,"timelineTreeViewDetailsSplitWidget");const t=new W.VBox,i=new A.Toolbar("",t.element);this.populateToolbar(i),this._dataGrid=new be.SortableDataGrid({displayName:ls`Performance`,columns:e}),this._dataGrid.addEventListener(ke.Events.SortingChanged,this._sortingChanged,this),this._dataGrid.element.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this._dataGrid.setResizeMethod(ke.ResizeMethod.Last),this._dataGrid.setRowContextMenuCallback(this._onContextMenu.bind(this)),this._dataGrid.asWidget().show(t.element),this._dataGrid.addEventListener(ke.Events.SelectedNode,this._updateDetailsForSelection,this),this._detailsView=new W.VBox,this._detailsView.element.classList.add("timeline-details-view","timeline-details-view-body"),this._splitWidget.setMainWidget(t),this._splitWidget.setSidebarWidget(this._detailsView),this._splitWidget.hideSidebar(),this._splitWidget.show(this.element),this._splitWidget.addEventListener(V.Events.ShowModeChanged,this._onShowModeChanged,this),this._lastSelectedNode}lastSelectedNode(){return this._lastSelectedNode}updateContents(e){this.setRange(e.startTime(),e.endTime())}setRange(e,t){this._startTime=e,this._endTime=t,this.refreshTree()}filters(){return[this._taskFilter,this._textFilter,...this._model.filters()]}filtersWithoutTextFilter(){return[this._taskFilter,...this._model.filters()]}textFilter(){return this._textFilter}_exposePercentages(){return!1}populateToolbar(e){this._textFilterUI=new A.ToolbarInput(m.UIString("Filter"),this.getToolbarInputAccessiblePlaceHolder()),this._textFilterUI.addEventListener(A.ToolbarInput.Event.TextChanged,(function(){const e=this._textFilterUI.value();this._textFilter.setRegExp(e?createPlainTextSearchRegex(e,"i"):null),this.refreshTree()}),this),e.appendToolbarItem(this._textFilterUI)}_modelEvents(){return this._track?this._track.syncEvents():[]}_onHover(e){}_appendContextMenuItems(e,t){}_linkifyLocation(e){const t=this._model.timelineModel().targetByEvent(e);if(!t)return null;const i=D.eventStackFrame(e);return i?this._linkifier.maybeLinkifyConsoleCallFrame(t,i):null}selectProfileNode(e,t){const i=[];for(let t=e;t;t=t.parent)i.push(t);for(let e=i.length-1;e>0;--e){const t=this.dataGridNodeForTreeNode(i[e]);t&&t.dataGrid&&t.expand()}const n=this.dataGridNodeForTreeNode(e);n.dataGrid&&(n.reveal(),n.select(t))}refreshTree(){if(this._linkifier.reset(),this._dataGrid.rootNode().removeChildren(),!this._model)return void this._updateDetailsForSelection();this._root=this._buildTree();const e=this._root.children();let t=0,i=0;const n=this._root.totalTime-this._root.selfTime;for(const n of e.values())t=Math.max(t,n.selfTime),i=Math.max(i,n.totalTime);for(const s of e.values()){const e=new ot(s,n,t,i,this);this._dataGrid.insertChild(e)}this._sortingChanged(),this._updateDetailsForSelection(),this._searchableView&&this._searchableView.refreshSearch();const s=this._dataGrid.rootNode();s.children.length>0&&s.children[0].select(!0)}_buildTree(){throw new Error("Not Implemented")}buildTopDownTree(e,t){return new D.TopDownRootNode(this._modelEvents(),this.filters(),this._startTime,this._endTime,e,t)}populateColumns(e){e.push({id:"self",title:m.UIString("Self Time"),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"total",title:m.UIString("Total Time"),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"activity",title:m.UIString("Activity"),disclosure:!0,sortable:!0})}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;let t;switch(e){case"startTime":t=function(e,t){const i=t;return e._profileNode.event.startTime-i._profileNode.event.startTime};break;case"self":t=i.bind(null,"selfTime");break;case"total":t=i.bind(null,"totalTime");break;case"activity":t=function(e,t){const i=e,n=t,s=at.eventNameForSorting(i._profileNode.event),a=at.eventNameForSorting(n._profileNode.event);return s.localeCompare(a)};break;default:return void console.assert(!1,"Unknown sort field: "+e)}function i(e,t,i){const n=i;return t._profileNode[e]-n._profileNode[e]}this._dataGrid.sortNodes(t,!this._dataGrid.isSortOrderAscending())}_onShowModeChanged(){this._splitWidget.showMode()!==V.ShowMode.OnlyMain&&(this._lastSelectedNode=void 0,this._updateDetailsForSelection())}_updateDetailsForSelection(){const e=this._dataGrid.selectedNode?this._dataGrid.selectedNode._profileNode:null;if(e===this._lastSelectedNode)return;if(this._lastSelectedNode=e,this._splitWidget.showMode()===V.ShowMode.OnlyMain)return;if(this._detailsView.detachChildWidgets(),this._detailsView.element.removeChildren(),e&&this._showDetailsForNode(e))return;this._detailsView.element.createChild("div","full-widget-dimmed-banner").createTextChild(m.UIString("Select item for details."))}_showDetailsForNode(e){return!1}_onMouseMove(e){const t=e.target&&e.target instanceof Node?this._dataGrid.dataGridNodeFromNode(e.target):null,i=t&&t._profileNode;i!==this._lastHoveredProfileNode&&(this._lastHoveredProfileNode=i,this._onHover(i))}_onContextMenu(e,t){t._linkElement&&!e.containsTarget(t._linkElement)&&e.appendApplicableItems(t._linkElement);const i=t._profileNode;i&&this._appendContextMenuItems(e,i)}dataGridNodeForTreeNode(e){return e[ot._gridNodeSymbol]||null}searchCanceled(){this._searchResults=[],this._currentResult=0}performSearch(e,t,i){if(this._searchResults=[],this._currentResult=0,!this._root)return;const n=e.toSearchRegex();this._searchResults=this._root.searchTree(e=>ii.testContentMatching(e,n)),this._searchableView.updateSearchMatchesCount(this._searchResults.length)}jumpToNextSearchResult(){this._searchResults.length&&(this.selectProfileNode(this._searchResults[this._currentResult],!1),this._currentResult=M.mod(this._currentResult+1,this._searchResults.length))}jumpToPreviousSearchResult(){this._searchResults.length&&(this.selectProfileNode(this._searchResults[this._currentResult],!1),this._currentResult=M.mod(this._currentResult-1,this._searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}}class rt extends be.SortableDataGridNode{constructor(e,t,i,n,s){super(null,!1),this._populated=!1,this._profileNode=e,this._treeView=s,this._grandTotalTime=t,this._maxSelfTime=i,this._maxTotalTime=n,this._linkElement=null}createCell(e){return"activity"===e?this._createNameCell(e):this._createValueCell(e)||super.createCell(e)}_createNameCell(e){const t=this.createTD(e),i=t.createChild("div","name-container"),n=i.createChild("div","activity-icon-container"),s=n.createChild("div","activity-icon"),a=i.createChild("div","activity-name"),r=this._profileNode.event;if(this._profileNode.isGroupNode()){const e=this._treeView._displayInfoForGroupNode(this._profileNode);a.textContent=e.name,s.style.backgroundColor=e.color,e.icon&&n.insertBefore(e.icon,s)}else if(r){const e=r.args.data,t=e&&e.deoptReason;t&&(i.createChild("div","activity-warning").title=m.UIString("Not optimized: %s",t)),a.textContent=ii.eventTitle(r),this._linkElement=this._treeView._linkifyLocation(r),this._linkElement&&i.createChild("div","activity-link").appendChild(this._linkElement);const n=ii.eventStyle(r).category;G.setAccessibleName(s,n.title),s.style.backgroundColor=n.color}return t}_createValueCell(e){if("self"!==e&&"total"!==e&&"startTime"!==e)return null;let t,i,n=!1;switch(e){case"startTime":t=this._profileNode.event.startTime-this._treeView._model.timelineModel().minimumRecordTime();break;case"self":t=this._profileNode.selfTime,i=this._maxSelfTime,n=!0;break;case"total":t=this._profileNode.totalTime,i=this._maxTotalTime,n=!0;break;default:return null}const s=this.createTD(e);s.className="numeric-column";const a=s.createChild("div");return a.createChild("span").textContent=m.UIString("%.1f ms",t),n&&this._treeView._exposePercentages()&&(a.createChild("span","percent-column").textContent=m.UIString("%.1f %%",t/this._grandTotalTime*100)),i&&(a.classList.add("background-percent-bar"),s.createChild("div","background-bar-container").createChild("div","background-bar").style.width=(100*t/i).toFixed(1)+"%"),s}}class ot extends rt{constructor(e,t,i,n,s){super(e,t,i,n,s),this.setHasChildren(this._profileNode.hasChildren()),e[ot._gridNodeSymbol]=this}populate(){if(!this._populated&&(this._populated=!0,this._profileNode.children))for(const e of this._profileNode.children().values()){const t=new ot(e,this._grandTotalTime,this._maxSelfTime,this._maxTotalTime,this._treeView);this.insertChildOrdered(t)}}}ot._gridNodeSymbol=Symbol("treeGridNode");class lt extends at{constructor(){super(),this._groupBySetting=p.Settings.instance().createSetting("timelineTreeGroupBy",lt.GroupBy.None),this._groupBySetting.addChangeListener(this.refreshTree.bind(this)),this.init(),this._stackView=new ct(this),this._stackView.addEventListener(ct.Events.SelectionChanged,this._onStackViewSelectionChanged,this),this._productByURLCache=new Map,this._colorByURLCache=new Map}setModel(e,t){super.setModel(e,t)}updateContents(e){this._updateExtensionResolver(),super.updateContents(e);const t=this._dataGrid.rootNode();t.children.length&&t.children[0].select(!0)}_updateExtensionResolver(){this._executionContextNamesByOrigin=new Map;for(const e of n.TargetManager.instance().models(a.RuntimeModel))for(const t of e.executionContexts())this._executionContextNamesByOrigin.set(t.origin,t.name)}_beautifyDomainName(e){return lt._isExtensionInternalURL(e)?e=m.UIString("[Chrome extensions overhead]"):lt._isV8NativeURL(e)?e=m.UIString("[V8 Runtime]"):e.startsWith("chrome-extension")&&(e=this._executionContextNamesByOrigin.get(e)||e),e}_displayInfoForGroupNode(e){const t=ii.categories(),i=e.id?ii.eventColor(e.event):t.other.color,n=m.UIString("[unattributed]"),s="symbol"==typeof e.id?void 0:e.id;switch(this._groupBySetting.get()){case lt.GroupBy.Category:{const e=s?t[s]||t.other:n;return{name:e.title,color:e.color}}case lt.GroupBy.Domain:case lt.GroupBy.Subdomain:return{name:(s?this._beautifyDomainName(s):void 0)||n,color:i};case lt.GroupBy.EventName:return{name:e.event.name===I.RecordType.JSFrame?m.UIString("JavaScript"):ii.eventTitle(e.event),color:e.event.name===I.RecordType.JSFrame?ii.eventStyle(e.event).category.color:i};case lt.GroupBy.URL:break;case lt.GroupBy.Frame:{const e=s?this._model.timelineModel().pageFrameById(s):void 0;return{name:e?ii.displayNameForFrame(e,80):m.UIString("Page"),color:i}}default:console.assert(!1,"Unexpected grouping type")}return{name:s||n,color:i}}populateToolbar(e){super.populateToolbar(e);const t=lt.GroupBy,i=[{label:m.UIString("No Grouping"),value:t.None},{label:m.UIString("Group by Activity"),value:t.EventName},{label:m.UIString("Group by Category"),value:t.Category},{label:m.UIString("Group by Domain"),value:t.Domain},{label:m.UIString("Group by Frame"),value:t.Frame},{label:m.UIString("Group by Subdomain"),value:t.Subdomain},{label:m.UIString("Group by URL"),value:t.URL}];e.appendToolbarItem(new A.ToolbarSettingComboBox(i,this._groupBySetting,ls`Group by`)),e.appendSpacer(),e.appendToolbarItem(this._splitWidget.createShowHideSidebarButton(m.UIString("heaviest stack")))}_buildHeaviestStack(e){console.assert(!!e.parent,"Attempt to build stack for tree root");let t=[];for(let i=e;i&&i.parent;i=i.parent)t.push(i);t=t.reverse();for(let i=e;i&&i.children()&&i.children().size;){const e=Array.from(i.children().values());i=e.reduce((e,t)=>e.totalTime>t.totalTime?e:t),t.push(i)}return t}_exposePercentages(){return!0}_onStackViewSelectionChanged(){const e=this._stackView.selectedTreeNode();e&&this.selectProfileNode(e,!0)}_showDetailsForNode(e){const t=this._buildHeaviestStack(e);return this._stackView.setStack(t,e),this._stackView.show(this._detailsView.element),!0}_groupingFunction(e){const t=lt.GroupBy;switch(e){case t.None:return null;case t.EventName:return e=>ii.eventStyle(e).title;case t.Category:return e=>ii.eventStyle(e).category.name;case t.Subdomain:return this._domainByEvent.bind(this,!1);case t.Domain:return this._domainByEvent.bind(this,!0);case t.URL:return e=>D.eventURL(e)||"";case t.Frame:return e=>I.TimelineData.forEvent(e).frameId;default:return console.assert(!1,"Unexpected aggregation setting: "+e),null}}_domainByEvent(e,t){const i=D.eventURL(t);if(!i)return"";if(lt._isExtensionInternalURL(i))return lt._extensionInternalPrefix;if(lt._isV8NativeURL(i))return lt._v8NativePrefix;const n=_.ParsedURL.fromString(i);if(!n)return"";if("chrome-extension"===n.scheme)return n.scheme+"://"+n.host;if(!e)return n.host;if(/^[.0-9]+$/.test(n.host))return n.host;const s=/([^.]*\.)?[^.]*$/.exec(n.host);return s&&s[0]||""}_appendContextMenuItems(e,t){if(this._groupBySetting.get()!==lt.GroupBy.Frame)return;if(!t.isGroupNode())return;const i=this._model.timelineModel().pageFrameById(t.id);i&&i.ownerNode&&e.appendApplicableItems(i.ownerNode)}static _isExtensionInternalURL(e){return e.startsWith(lt._extensionInternalPrefix)}static _isV8NativeURL(e){return e.startsWith(lt._v8NativePrefix)}}lt._extensionInternalPrefix="extensions::",lt._v8NativePrefix="native ",lt.GroupBy={None:"None",EventName:"EventName",Category:"Category",Domain:"Domain",Subdomain:"Subdomain",URL:"URL",Frame:"Frame"};class ht extends lt{constructor(){super(),this._dataGrid.markColumnAsSortedBy("total",ke.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return ls`Filter call tree`}_buildTree(){const e=this._groupBySetting.get();return this.buildTopDownTree(!1,this._groupingFunction(e))}}class dt extends lt{constructor(){super(),this._dataGrid.markColumnAsSortedBy("self",ke.Order.Descending)}getToolbarInputAccessiblePlaceHolder(){return ls`Filter bottom-up`}_buildTree(){return new D.BottomUpRootNode(this._modelEvents(),this.textFilter(),this.filtersWithoutTextFilter(),this._startTime,this._endTime,this._groupingFunction(this._groupBySetting.get()))}}class ct extends W.VBox{constructor(e){super();this.element.createChild("div","timeline-stack-view-header").textContent=m.UIString("Heaviest stack"),this._treeView=e;const t=[{id:"total",title:m.UIString("Total Time"),fixedWidth:!0,width:"110px"},{id:"activity",title:m.UIString("Activity")}];this._dataGrid=new Ee.ViewportDataGrid({displayName:ls`Timeline Stack`,columns:t}),this._dataGrid.setResizeMethod(ke.ResizeMethod.Last),this._dataGrid.addEventListener(ke.Events.SelectedNode,this._onSelectionChanged,this),this._dataGrid.asWidget().show(this.element)}setStack(e,t){const i=this._dataGrid.rootNode();i.removeChildren();let n=null;const s=Math.max.apply(Math,e.map(e=>e.totalTime));for(const a of e){const e=new rt(a,s,s,s,this._treeView);i.appendChild(e),a===t&&(n=e)}n.revealAndSelect()}selectedTreeNode(){const e=this._dataGrid.selectedNode;return e&&e._profileNode}_onSelectionChanged(){this.dispatchEventToListeners(ct.Events.SelectionChanged)}}ct.Events={SelectionChanged:Symbol("SelectionChanged")};var mt=Object.freeze({__proto__:null,TimelineTreeView:at,GridNode:rt,TreeGridNode:ot,AggregatedTimelineTreeView:lt,CallTreeTimelineTreeView:ht,BottomUpTimelineTreeView:dt,TimelineStackView:ct});class ut extends at{constructor(e){super(),this._filtersControl=new pt,this._filtersControl.addEventListener(pt.Events.FilterChanged,this._onFilterChanged,this),this.init(),this._delegate=e,this._dataGrid.markColumnAsSortedBy("startTime",ke.Order.Ascending),this._splitWidget.showBoth()}filters(){return[...super.filters(),...this._filtersControl.filters()]}updateContents(e){if(super.updateContents(e),e.type()===Qt.Type.TraceEvent){const t=e.object();this._selectEvent(t,!0)}}getToolbarInputAccessiblePlaceHolder(){return ls`Filter event log`}_buildTree(){return this._currentTree=this.buildTopDownTree(!0,null),this._currentTree}_onFilterChanged(){const e=this.lastSelectedNode()&&this.lastSelectedNode().event;this.refreshTree(),e&&this._selectEvent(e,!1)}_findNodeWithEvent(e){const t=[this._currentTree.children().values()];for(;t.length;){const i=t.peekLast().next();if(i.done){t.pop();continue}const n=i.value;if(n.event===e)return n;t.push(n.children().values())}return null}_selectEvent(e,t){const i=this._findNodeWithEvent(e);i&&(this.selectProfileNode(i,!1),t&&this.dataGridNodeForTreeNode(i).expand())}populateColumns(e){e.push({id:"startTime",title:m.UIString("Start Time"),width:"80px",fixedWidth:!0,sortable:!0}),super.populateColumns(e),e.filter(e=>e.fixedWidth).forEach(e=>{e.width="80px"})}populateToolbar(e){super.populateToolbar(e),this._filtersControl.populateToolbar(e)}_showDetailsForNode(e){const t=e.event;return!!t&&(ii.buildTraceEventDetails(t,this.model().timelineModel(),this._linkifier,!1).then(e=>this._detailsView.element.appendChild(e)),!0)}_onHover(e){this._delegate.highlightEvent(e&&e.event)}}class pt extends g.ObjectWrapper{constructor(){super(),this._categoryFilter=new it,this._durationFilter=new tt,this._filters=[this._categoryFilter,this._durationFilter]}filters(){return this._filters}populateToolbar(e){const t=new A.ToolbarComboBox(function(){const e=t.selectedOption().value,i=parseInt(e,10);this._durationFilter.setMinimumRecordDuration(i),this._notifyFiltersChanged()}.bind(this),ls`Duration filter`);for(const e of pt._durationFilterPresetsMs)t.addOption(t.createOption(e?m.UIString("≥ %d ms",e):m.UIString("All"),String(e)));e.appendToolbarItem(t);const i={},n=ii.categories();for(const t in n){const a=n[t];if(!a.visible)continue;const r=new A.ToolbarCheckbox(a.title,void 0,s.bind(this,t));r.setChecked(!0),r.inputElement.style.backgroundColor=a.color,i[a.name]=r,e.appendToolbarItem(r)}function s(e){ii.categories()[e].hidden=!i[e].checked(),this._notifyFiltersChanged()}}_notifyFiltersChanged(){this.dispatchEventToListeners(pt.Events.FilterChanged)}}pt._durationFilterPresetsMs=[0,1,15],pt.Events={FilterChanged:Symbol("FilterChanged")};var _t=Object.freeze({__proto__:null,EventsTimelineTreeView:ut,Filters:pt});class gt extends V.SplitWidget{constructor(e,t){super(!0,!1,"timelineLayersView"),this._model=e,this._showPaintProfilerCallback=t,this.element.classList.add("timeline-layers-view"),this._rightSplitWidget=new V.SplitWidget(!0,!0,"timelineLayersViewDetails"),this._rightSplitWidget.element.classList.add("timeline-layers-view-properties"),this.setMainWidget(this._rightSplitWidget);const i=new W.VBox;this.setSidebarWidget(i),this._layerViewHost=new Me.LayerViewHost;const n=new Re.LayerTreeOutline(this._layerViewHost);i.element.appendChild(n.element),this._layers3DView=new Pe.Layers3DView(this._layerViewHost),this._layers3DView.addEventListener(Pe.Events.PaintProfilerRequested,this._onPaintProfilerRequested,this),this._rightSplitWidget.setMainWidget(this._layers3DView);const s=new xe.LayerDetailsView(this._layerViewHost);this._rightSplitWidget.setSidebarWidget(s),s.addEventListener(xe.Events.PaintProfilerRequested,this._onPaintProfilerRequested,this)}showLayerTree(e){this._frameLayerTree=e,this.isShowing()?this._update():this._updateWhenVisible=!0}wasShown(){this._updateWhenVisible&&(this._updateWhenVisible=!1,this._update())}_onPaintProfilerRequested(e){const t=e.data;this._layers3DView.snapshotForSelection(t).then(e=>{e&&this._showPaintProfilerCallback(e.snapshot)})}_update(){this._frameLayerTree.layerTreePromise().then(e=>this._layerViewHost.setLayerTree(e))}}var ft=Object.freeze({__proto__:null,TimelineLayersView:gt});class vt extends V.SplitWidget{constructor(e){super(!1,!1),this.element.classList.add("timeline-paint-profiler-view"),this.setSidebarSize(60),this.setResizable(!1),this._frameModel=e,this._logAndImageSplitWidget=new V.SplitWidget(!0,!1),this._logAndImageSplitWidget.element.classList.add("timeline-paint-profiler-log-split"),this.setMainWidget(this._logAndImageSplitWidget),this._imageView=new Tt,this._logAndImageSplitWidget.setMainWidget(this._imageView),this._paintProfilerView=new Le.PaintProfilerView(this._imageView.showImage.bind(this._imageView)),this._paintProfilerView.addEventListener(Le.Events.WindowChanged,this._onWindowChanged,this),this.setSidebarWidget(this._paintProfilerView),this._logTreeView=new Le.PaintProfilerCommandLogView,this._logAndImageSplitWidget.setSidebarWidget(this._logTreeView),this._needsUpdateWhenVisible=!1,this._pendingSnapshot=null,this._event=null,this._paintProfilerModel=null,this._lastLoadedSnapshot=null}wasShown(){this._needsUpdateWhenVisible&&(this._needsUpdateWhenVisible=!1,this._update())}setSnapshot(e){this._releaseSnapshot(),this._pendingSnapshot=e,this._event=null,this._updateWhenVisible()}setEvent(e,t){return this._releaseSnapshot(),this._paintProfilerModel=e,this._pendingSnapshot=null,this._event=t,this._updateWhenVisible(),this._event.name===I.RecordType.Paint?!!I.TimelineData.forEvent(t).picture:this._event.name===I.RecordType.RasterTask&&this._frameModel.hasRasterTile(this._event)}_updateWhenVisible(){this.isShowing()?this._update():this._needsUpdateWhenVisible=!0}_update(){let e;if(this._logTreeView.setCommandLog([]),this._paintProfilerView.setSnapshotAndLog(null,[],null),this._pendingSnapshot)e=Promise.resolve({rect:null,snapshot:this._pendingSnapshot});else if(this._event.name===I.RecordType.Paint){e=I.TimelineData.forEvent(this._event).picture.objectPromise().then(e=>this._paintProfilerModel.loadSnapshot(e.skp64)).then(e=>e&&{rect:null,snapshot:e})}else{if(this._event.name!==I.RecordType.RasterTask)return void console.assert(!1,"Unexpected event type or no snapshot");e=this._frameModel.rasterTilePromise(this._event)}function t(e,t,i){this._logTreeView.setCommandLog(i||[]),this._paintProfilerView.setSnapshotAndLog(e,i||[],t)}e.then(e=>{if(this._releaseSnapshot(),!e)return void this._imageView.showImage();const i=e.snapshot;this._lastLoadedSnapshot=i,this._imageView.setMask(e.rect),i.commandLog().then(n=>t.call(this,i,e.rect,n))})}_releaseSnapshot(){this._lastLoadedSnapshot&&(this._lastLoadedSnapshot.release(),this._lastLoadedSnapshot=null)}_onWindowChanged(){this._logTreeView.updateWindow(this._paintProfilerView.selectionWindow())}}class Tt extends W.Widget{constructor(){super(!0),this.registerRequiredCSS("timeline/timelinePaintProfiler.css"),this.contentElement.classList.add("fill","paint-profiler-image-view"),this._imageContainer=this.contentElement.createChild("div","paint-profiler-image-container"),this._imageElement=this._imageContainer.createChild("img"),this._maskElement=this._imageContainer.createChild("div"),this._imageElement.addEventListener("load",this._updateImagePosition.bind(this),!1),this._transformController=new Ie.TransformController(this.contentElement,!0),this._transformController.addEventListener(Ie.Events.TransformChanged,this._updateImagePosition,this)}onResize(){this._imageElement.src&&this._updateImagePosition()}_updateImagePosition(){const e=this._imageElement.naturalWidth,t=this._imageElement.naturalHeight,i=this.contentElement.clientWidth,n=this.contentElement.clientHeight,s=.1*i,a=.1*n,r=(i-s)/e,o=(n-a)/t,l=Math.min(r,o);if(this._maskRectangle){const i=this._maskElement.style;i.width=e+"px",i.height=t+"px",i.borderLeftWidth=this._maskRectangle.x+"px",i.borderTopWidth=this._maskRectangle.y+"px",i.borderRightWidth=e-this._maskRectangle.x-this._maskRectangle.width+"px",i.borderBottomWidth=t-this._maskRectangle.y-this._maskRectangle.height+"px"}this._transformController.setScaleConstraints(.5,10/l);let h=(new WebKitCSSMatrix).scale(this._transformController.scale(),this._transformController.scale()).translate(i/2,n/2).scale(l,l).translate(-e/2,-t/2);const d=H.boundsForTransformedPoints(h,[0,0,0,e,t,0]);this._transformController.clampOffsets(s-d.maxX,i-s-d.minX,a-d.maxY,n-a-d.minY),h=(new WebKitCSSMatrix).translate(this._transformController.offsetX(),this._transformController.offsetY()).multiply(h),this._imageContainer.style.webkitTransform=h.toString()}showImage(e){this._imageContainer.classList.toggle("hidden",!e),e&&(this._imageElement.src=e)}setMask(e){this._maskRectangle=e,this._maskElement.classList.toggle("hidden",!e)}}var wt=Object.freeze({__proto__:null,TimelinePaintProfilerView:vt,TimelinePaintImageView:Tt});class St extends W.VBox{constructor(e){super(),this.element.classList.add("timeline-details"),this._detailsLinkifier=new me.Linkifier,this._tabbedPane=new O.TabbedPane,this._tabbedPane.show(this.element);const t=yt;this._defaultDetailsWidget=new W.VBox,this._defaultDetailsWidget.element.classList.add("timeline-details-view"),this._defaultDetailsContentElement=this._defaultDetailsWidget.element.createChild("div","timeline-details-view-body vbox"),this._appendTab(t.Details,m.UIString("Summary"),this._defaultDetailsWidget),this.setPreferredTab(t.Details),this._rangeDetailViews=new Map;const i=new dt;this._appendTab(t.BottomUp,m.UIString("Bottom-Up"),i),this._rangeDetailViews.set(t.BottomUp,i);const n=new ht;this._appendTab(t.CallTree,m.UIString("Call Tree"),n),this._rangeDetailViews.set(t.CallTree,n);const s=new ut(e);this._appendTab(t.EventLog,m.UIString("Event Log"),s),this._rangeDetailViews.set(t.EventLog,s),this._additionalMetricsToolbar=new A.Toolbar("timeline-additional-metrics"),this.element.appendChild(this._additionalMetricsToolbar.element),this._tabbedPane.addEventListener(O.Events.TabSelected,this._tabSelected,this)}setModel(e,t){this._model!==e&&(this._model&&this._model.removeEventListener(pi.WindowChanged,this._onWindowChanged,this),this._model=e,this._model&&this._model.addEventListener(pi.WindowChanged,this._onWindowChanged,this)),this._track=t,this._tabbedPane.closeTabs([yt.PaintProfiler,yt.LayerViewer],!1);for(const i of this._rangeDetailViews.values())i.setModel(e,t);if(this._lazyPaintProfilerView=null,this._lazyLayersView=null,this.setSelection(null),this._additionalMetricsToolbar.removeToolbarItems(),e&&e.timelineModel()){const{estimated:t,time:i}=e.timelineModel().totalBlockingTime(),n=t?` (${ls`estimated`})`:"",s=ls`Total blocking time: ${i.toFixed(2)}ms${n}`,a=createElement("span"),r=B.createWebDevLink("tbt/",ls`Learn more`);r.style.marginRight="2px",a.appendChild(B.formatLocalized("%s",[r])),this._additionalMetricsToolbar.appendText(s),this._additionalMetricsToolbar.appendToolbarItem(new A.ToolbarItem(a))}}_setContent(e){const t=this._tabbedPane.otherTabs(yt.Details);for(let e=0;e<t.length;++e)this._rangeDetailViews.has(t[e])||this._tabbedPane.closeTab(t[e]);this._defaultDetailsContentElement.removeChildren(),this._defaultDetailsContentElement.appendChild(e)}_updateContents(){const e=this._rangeDetailViews.get(this._tabbedPane.selectedTabId||"");if(e){const t=this._model.window();e.updateContents(this._selection||Qt.fromRange(t.left,t.right))}}_appendTab(e,t,i,n){this._tabbedPane.appendTab(e,t,i,void 0,void 0,n),this._preferredTabId!==this._tabbedPane.selectedTabId&&this._tabbedPane.selectTab(e)}headerElement(){return this._tabbedPane.headerElement()}setPreferredTab(e){this._preferredTabId=e}_onWindowChanged(e){this._selection||this._updateContentsFromWindow()}_updateContentsFromWindow(){if(!this._model)return void this._setContent(z.html`<div/>`);const e=this._model.window();this._updateSelectedRangeStats(e.left,e.right),this._updateContents()}setSelection(e){if(this._detailsLinkifier.reset(),this._selection=e,this._selection){switch(this._selection.type()){case Qt.Type.TraceEvent:{const e=this._selection.object();ii.buildTraceEventDetails(e,this._model.timelineModel(),this._detailsLinkifier,!0).then(t=>this._appendDetailsTabsForTraceEventAndShowDetails(e,t));break}case Qt.Type.Frame:{const e=this._selection.object(),t=this._model.filmStripModelFrame(e);if(this._setContent(ii.generateDetailsContentForFrame(e,t)),e.layerTree){const t=this._layersView();t.showLayerTree(e.layerTree),this._tabbedPane.hasTab(yt.LayerViewer)||this._appendTab(yt.LayerViewer,m.UIString("Layers"),t)}break}case Qt.Type.NetworkRequest:{const e=this._selection.object();ii.buildNetworkRequestDetails(e,this._model.timelineModel(),this._detailsLinkifier).then(this._setContent.bind(this));break}case Qt.Type.Range:this._updateSelectedRangeStats(this._selection.startTime(),this._selection.endTime())}this._updateContents()}else this._updateContentsFromWindow()}_tabSelected(e){e.data.isUserGesture&&(this.setPreferredTab(e.data.tabId),this._updateContents())}_layersView(){return this._lazyLayersView||(this._lazyLayersView=new gt(this._model.timelineModel(),this._showSnapshotInPaintProfiler.bind(this))),this._lazyLayersView}_paintProfilerView(){return this._lazyPaintProfilerView||(this._lazyPaintProfilerView=new vt(this._model.frameModel())),this._lazyPaintProfilerView}_showSnapshotInPaintProfiler(e){const t=this._paintProfilerView();t.setSnapshot(e),this._tabbedPane.hasTab(yt.PaintProfiler)||this._appendTab(yt.PaintProfiler,m.UIString("Paint Profiler"),t,!0),this._tabbedPane.selectTab(yt.PaintProfiler,!0)}_appendDetailsTabsForTraceEventAndShowDetails(e,t){this._setContent(t),e.name!==I.RecordType.Paint&&e.name!==I.RecordType.RasterTask||this._showEventInPaintProfiler(e)}_showEventInPaintProfiler(e){const t=n.TargetManager.instance().models(r.PaintProfilerModel)[0];if(!t)return;const i=this._paintProfilerView();i.setEvent(t,e)&&(this._tabbedPane.hasTab(yt.PaintProfiler)||this._appendTab(yt.PaintProfiler,m.UIString("Paint Profiler"),i))}_updateSelectedRangeStats(e,t){if(!this._model||!this._track)return;const i=ii.statsForTimeRange(this._track.syncEvents(),e,t),n=e-this._model.timelineModel().minimumRecordTime(),s=t-this._model.timelineModel().minimumRecordTime(),a=new di(null,null);a.addSection(ls`Range:  ${Number.millisToString(n)} \u2013 ${Number.millisToString(s)}`);const r=ii.generatePieChart(i);a.appendElementRow("",r),this._setContent(a.fragment)}}const yt={Details:"Details",EventLog:"EventLog",CallTree:"CallTree",BottomUp:"BottomUp",PaintProfiler:"PaintProfiler",LayerViewer:"LayerViewer"};var Ct=Object.freeze({__proto__:null,TimelineDetailsView:St,Tab:yt});class bt extends g.ObjectWrapper{constructor(){super(),this.reset(),this._font="11px "+fe.fontFamily(),this._timelineData=null,this._currentLevel=0,this._performanceModel=null,this._model=null,this._minimumBoundary=0,this._maximumBoundary=0,this._timeSpan=0,this._consoleColorGenerator=new f.Generator({min:30,max:55},{min:70,max:100,count:6},50,.7),this._extensionColorGenerator=new f.Generator({min:210,max:300},{min:70,max:100,count:6},70,.7),this._headerLevel1=this._buildGroupStyle({shareHeaderLine:!1}),this._headerLevel2=this._buildGroupStyle({padding:2,nestingLevel:1,collapsible:!1}),this._staticHeader=this._buildGroupStyle({collapsible:!1}),this._framesHeader=this._buildGroupStyle({useFirstLineForOverview:!0}),this._collapsibleTimingsHeader=this._buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!0}),this._timingsHeader=this._buildGroupStyle({shareHeaderLine:!0,useFirstLineForOverview:!0,collapsible:!1}),this._screenshotsHeader=this._buildGroupStyle({useFirstLineForOverview:!0,nestingLevel:1,collapsible:!1,itemsHeight:150}),this._interactionsHeaderLevel1=this._buildGroupStyle({useFirstLineForOverview:!0}),this._interactionsHeaderLevel2=this._buildGroupStyle({padding:2,nestingLevel:1}),this._experienceHeader=this._buildGroupStyle({collapsible:!1}),this._flowEventIndexById=new Map}_buildGroupStyle(e){const t={padding:4,height:17,collapsible:!0,color:Fe.instance().patchColorText("#222",Fe.ColorUsage.Foreground),backgroundColor:Fe.instance().patchColorText("white",Fe.ColorUsage.Background),font:this._font,nestingLevel:0,shareHeaderLine:!0};return Object.assign(t,e)}setModel(e){this.reset(),this._performanceModel=e,this._model=e&&e.timelineModel()}groupTrack(e){return e._track||null}navStartTimes(){return this._model?this._model.navStartTimes():new Map}entryTitle(e){const i=Rt,n=this._entryType(e);if(n===i.Event){const i=this._entryData[e];return i.phase===t.Phase.AsyncStepInto||i.phase===t.Phase.AsyncStepPast?i.name+":"+i.args.step:i._blackboxRoot?m.UIString("Blackboxed"):this._performanceModel.timelineModel().isMarkerEvent(i)?ii.markerShortTitle(i):ii.eventTitle(i)}if(n===i.ExtensionEvent){return this._entryData[e].name}if(n===i.Screenshot)return"";let s=this._entryIndexToTitle[e];return s||(s=m.UIString("Unexpected entryIndex %d",e),console.error(s)),s}textColor(e){const t=this._entryData[e];return t&&t._blackboxRoot?"#888":Dt.textColor}entryFont(e){return this._font}reset(){this._currentLevel=0,this._timelineData=null,this._entryData=[],this._entryParent=[],this._entryTypeByLevel=[],this._entryIndexToTitle=[],this._markers=[],this._asyncColorByCategory=new Map,this._asyncColorByInteractionPhase=new Map,this._extensionInfo=[],this._screenshotImageCache=new Map}maxStackDepth(){return this._currentLevel}timelineData(){return this._timelineData?this._timelineData:(this._timelineData=new S.TimelineData([],[],[],[]),this._model?(this._flowEventIndexById.clear(),this._minimumBoundary=this._model.minimumRecordTime(),this._timeSpan=this._model.isEmpty()?1e3:this._model.maximumRecordTime()-this._minimumBoundary,this._currentLevel=0,this._model.isGenericTrace()?this._processGenericTrace():this._processInspectorTrace(),this._timelineData):this._timelineData)}_processGenericTrace(){const e=this._buildGroupStyle({shareHeaderLine:!1}),t=this._buildGroupStyle({padding:2,nestingLevel:1,shareHeaderLine:!1}),i=Rt.Event,n=new Platform.Multimap;for(const e of this._model.tracks())null!==e.thread?n.set(e.thread.process(),e):console.error("Failed to process track");for(const s of n.keysArray()){if(n.size>1){const t=`${s.name()} ${s.id()}`;this._appendHeader(t,e,!1)}for(const e of n.get(s)){const n=this._appendSyncEvents(e,e.events,e.name,t,i,!0);this._timelineData.selectedGroup&&e.name!==I.TimelineModelImpl.BrowserMainThreadName||(this._timelineData.selectedGroup=n)}}}_processInspectorTrace(){this._appendFrames(),this._appendInteractionRecords();const e=Rt.Event,t=e=>{switch(e.type){case I.TrackType.Input:return 0;case I.TrackType.Animation:return 1;case I.TrackType.Timings:return 2;case I.TrackType.Console:return 3;case I.TrackType.Experience:return 4;case I.TrackType.MainThread:return e.forMainFrame?5:6;case I.TrackType.Worker:return 7;case I.TrackType.Raster:return 8;case I.TrackType.GPU:return 9;case I.TrackType.Other:return 10}},i=this._model.tracks().slice();i.sort((e,i)=>t(e)-t(i));let n=0;for(const t of i)switch(t.type){case I.TrackType.Input:this._appendAsyncEventsGroup(t,ls`Input`,t.asyncEvents,this._interactionsHeaderLevel2,e,!1);break;case I.TrackType.Animation:this._appendAsyncEventsGroup(t,ls`Animation`,t.asyncEvents,this._interactionsHeaderLevel2,e,!1);break;case I.TrackType.Timings:{const i=t.asyncEvents.length>0?this._collapsibleTimingsHeader:this._timingsHeader;this._appendHeader(ls`Timings`,i,!0)._track=t,this._appendPageMetrics(),this._copyPerfMarkEvents(t),this._appendSyncEvents(t,t.events,null,null,e,!0),this._appendAsyncEventsGroup(t,null,t.asyncEvents,null,e,!0);break}case I.TrackType.Console:this._appendAsyncEventsGroup(t,ls`Console`,t.asyncEvents,this._headerLevel1,e,!0);break;case I.TrackType.MainThread:if(t.forMainFrame){const i=this._appendSyncEvents(t,t.events,t.url?ls`Main \u2014 ${t.url}`:ls`Main`,this._headerLevel1,e,!0);i&&(this._timelineData.selectedGroup=i)}else this._appendSyncEvents(t,t.events,t.url?ls`Frame \u2014 ${t.url}`:ls`Subframe`,this._headerLevel1,e,!0);break;case I.TrackType.Worker:this._appendSyncEvents(t,t.events,t.name,this._headerLevel1,e,!0);break;case I.TrackType.Raster:n||this._appendHeader(ls`Raster`,this._headerLevel1,!1),++n,this._appendSyncEvents(t,t.events,ls`Rasterizer Thread ${n}`,this._headerLevel2,e,!0);break;case I.TrackType.GPU:this._appendSyncEvents(t,t.events,ls`GPU`,this._headerLevel1,e,!0);break;case I.TrackType.Other:this._appendSyncEvents(t,t.events,t.name||ls`Thread`,this._headerLevel1,e,!0),this._appendAsyncEventsGroup(t,t.name,t.asyncEvents,this._headerLevel1,e,!0);break;case I.TrackType.Experience:this._appendSyncEvents(t,t.events,ls`Experience`,this._experienceHeader,e,!0)}this._timelineData.selectedGroup&&(this._timelineData.selectedGroup.expanded=!0);for(let e=0;e<this._extensionInfo.length;e++)this._innerAppendExtensionEvents(e);this._markers.sort((e,t)=>e.startTime()-t.startTime()),this._timelineData.markers=this._markers,this._flowEventIndexById.clear()}minimumBoundary(){return this._minimumBoundary}totalTime(){return this._timeSpan}search(e,i,n){const s=[],a=Rt;this.timelineData();for(let t=0;t<this._entryData.length;++t){if(this._entryType(t)!==a.Event)continue;const r=this._entryData[t];r.startTime>i||((r.endTime||r.startTime)<e||n.accept(r)&&s.push(t))}return s.sort((e,i)=>t.Event.compareStartTime(this._entryData[e],this._entryData[i])),s}_appendSyncEvents(e,i,n,s,a,r){if(!i.length)return null;const o=a===Rt.ExtensionEvent,l=[],h=Root.Runtime.experiments.isEnabled("timelineFlowEvents"),d=!o&&Root.Runtime.experiments.isEnabled("blackboxJSFramesOnTimeline");let c=0,m=null;e&&e.type===I.TrackType.MainThread&&(m=this._appendHeader(n,s,r),m._track=e);for(let a=0;a<i.length;++a){const u=i[a];if(this._performanceModel){const t=this._performanceModel.timelineModel().isInteractiveTimeEvent(u),i=this._performanceModel.timelineModel().isLayoutShiftEvent(u),n=t||i;if(e&&e.type===I.TrackType.MainThread&&n)continue}if(this._performanceModel&&this._performanceModel.timelineModel().isLayoutShiftEvent(u))for(const e of this._performanceModel.frames()){void 0===u.endTime&&u.setEndTime(u.startTime);const t=u.startTime>=e.startTime,i=u.endTime&&u.endTime<=e.endTime;t&&i&&(u.startTime=e.startTime,u.setEndTime(e.endTime))}if(!o&&this._performanceModel.timelineModel().isMarkerEvent(u)&&this._markers.push(new Ut(u.startTime,u.startTime-this._model.minimumRecordTime(),ii.markerStyleForEvent(u))),!t.TracingModel.isFlowPhase(u.phase)){if(!u.endTime&&u.phase!==t.Phase.Instant)continue;if(t.TracingModel.isAsyncPhase(u.phase))continue;if(!o&&!this._performanceModel.isVisible(u))continue}for(;l.length&&l.peekLast().endTime<=u.startTime;)l.pop();if(u._blackboxRoot=!1,d&&this._isBlackboxedEvent(u)){const e=l.peekLast();if(e&&e._blackboxRoot)continue;u._blackboxRoot=!0}!m&&n&&(m=this._appendHeader(n,s,r),r&&(m._track=e));const p=this._currentLevel+l.length;h&&this._appendFlowEvent(u,p);const _=this._appendEvent(u,p);l.length&&(this._entryParent[_]=l.peekLast()),!o&&this._performanceModel.timelineModel().isMarkerEvent(u)&&(this._timelineData.entryTotalTimes[this._entryData.length]=void 0),c=Math.max(c,l.length+1),u.endTime&&l.push(u)}return this._entryTypeByLevel.length=this._currentLevel+c,this._entryTypeByLevel.fill(a,this._currentLevel),this._currentLevel+=c,m}_isBlackboxedEvent(e){if(e.name!==I.RecordType.JSFrame)return!1;const t=e.args.data.url;return t&&this._isBlackboxedURL(t)}_isBlackboxedURL(e){return he.BlackboxManager.instance().isBlackboxedURL(e)}_appendAsyncEventsGroup(e,t,i,n,s,a){if(!i.length)return null;const r=[];let o=null;for(let s=0;s<i.length;++s){const l=i[s];if(!this._performanceModel.isVisible(l))continue;!o&&t&&(o=this._appendHeader(t,n,a),a&&(o._track=e));const h=l.startTime;let d;for(d=0;d<r.length&&r[d]>h;++d);this._appendAsyncEvent(l,this._currentLevel+d),r[d]=l.endTime}return this._entryTypeByLevel.length=this._currentLevel+r.length,this._entryTypeByLevel.fill(s,this._currentLevel),this._currentLevel+=r.length,o}_appendInteractionRecords(){const e=this._performanceModel.interactionRecords();if(e.length){this._appendHeader(ls`Interactions`,this._interactionsHeaderLevel1,!1);for(const t of e){const e=this._entryData.length;this._entryData.push(t.data),this._entryIndexToTitle[e]=t.data,this._timelineData.entryLevels[e]=this._currentLevel,this._timelineData.entryTotalTimes[e]=t.end-t.begin,this._timelineData.entryStartTimes[e]=t.begin}this._entryTypeByLevel[this._currentLevel++]=Rt.InteractionRecord}}_appendPageMetrics(){this._entryTypeByLevel[this._currentLevel]=Rt.Event;const e=[],i=[],n=this._performanceModel.timelineModel();for(const t of this._model.tracks())for(const s of t.events)n.isMarkerEvent(s)&&(n.isLCPCandidateEvent(s)||n.isLCPInvalidateEvent(s)?i.push(s):e.push(s));if(i.length>0){const t=new Map;for(const e of i){const i=e.args.data.navigationId,n=t.get(i);(!n||n.args.data.candidateIndex<e.args.data.candidateIndex)&&t.set(i,e)}const s=Array.from(t.values()).filter(e=>n.isLCPCandidateEvent(e));e.push(...s)}e.sort(t.Event.compareStartTime);const s=this._timelineData.entryTotalTimes;for(const t of e)this._appendEvent(t,this._currentLevel),s[s.length-1]=Number.NaN;++this._currentLevel}_copyPerfMarkEvents(e){this._entryTypeByLevel[this._currentLevel]=Rt.Event;const i=this._performanceModel.timelineModel(),n=["workerStart","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","secureConnectionStart","requestStart","responseStart","responseEnd","navigationStart","unloadEventStart","unloadEventEnd","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","secureConnectionStart","requestStart","responseStart","responseEnd","domLoading","domInteractive","domContentLoadedEventStart","domContentLoadedEventEnd","domComplete","loadEventStart","loadEventEnd"];for(const s of this._model.tracks())if(s.type===I.TrackType.MainThread)for(const a of s.events)if(i.isUserTimingEvent(a)){if(n.includes(a.name))continue;if(t.TracingModel.isAsyncPhase(a.phase))continue;a.setEndTime(a.startTime),e.events.push(a)}++this._currentLevel}_appendFrames(){const e=this._performanceModel.filmStripModel().frames(),t=!!e.length;this._framesHeader.collapsible=t,this._appendHeader(m.UIString("Frames"),this._framesHeader,!1),this._frameGroup=this._timelineData.groups.peekLast();const i=ii.markerStyleForFrame();this._entryTypeByLevel[this._currentLevel]=Rt.Frame;for(const e of this._performanceModel.frames())this._markers.push(new Ut(e.startTime,e.startTime-this._model.minimumRecordTime(),i)),this._appendFrame(e);if(++this._currentLevel,!t)return;let n;this._appendHeader("",this._screenshotsHeader,!1),this._entryTypeByLevel[this._currentLevel]=Rt.Screenshot;for(const t of e)this._entryData.push(t),this._timelineData.entryLevels.push(this._currentLevel),this._timelineData.entryStartTimes.push(t.timestamp),n&&this._timelineData.entryTotalTimes.push(t.timestamp-n),n=t.timestamp;e.length&&this._timelineData.entryTotalTimes.push(this._model.maximumRecordTime()-n),++this._currentLevel}_entryType(e){return this._entryTypeByLevel[this._timelineData.entryLevels[e]]}prepareHighlightedEntryInfo(e){let t,i,n="";const s=this._entryType(e);if(s===Rt.Event){const s=this._entryData[e],a=s.duration,r=s.selfTime,o=1e-6;if("number"==typeof a&&(n=Math.abs(a-r)>o&&r>o?m.UIString("%s (self %s)",Number.millisToString(a,!0),Number.millisToString(r,!0)):Number.millisToString(a,!0)),t=this._performanceModel.timelineModel().isMarkerEvent(s)?ii.eventTitle(s):this.entryTitle(e),i=ii.eventWarning(s),this._model&&this._model.isLayoutShiftEvent(s)){n=ls`Occurrences: ${1}`}if(this._model&&this._model.isParseHTMLEvent(s)){const e=s.args.beginData.startLine,i=s.args.endData&&s.args.endData.endLine;t+=` - ${de.displayNameForURL(s.args.beginData.url)} [${-1!==i||i===e?`${e}...${i}`:e}]`}}else{if(s!==Rt.Frame)return null;{const s=this._entryData[e];n=m.UIString("%s ~ %.0f fps",Number.preciseMillisToString(s.duration,1),1e3/s.duration),t=s.idle?m.UIString("Idle Frame"):m.UIString("Frame"),s.hasWarnings()&&(i=createElement("span"),i.textContent=m.UIString("Long frame"))}}const a=createElement("div"),r=j.createShadowRootWithCoreStyles(a,"timeline/timelineFlamechartPopover.css").createChild("div","timeline-flamechart-popover");return r.createChild("span","timeline-info-time").textContent=n,r.createChild("span","timeline-info-title").textContent=t,i&&(i.classList.add("timeline-info-warning"),r.appendChild(i)),a}entryColor(e){function i(e,t,i){let n=e.get(t);if(n)return n;return n=f.Color.parse(i(t)).setAlpha(.7).asString(f.Format.RGBA)||"",e.set(t,n),n}const n=Rt,s=this._entryType(e);if(s===n.Event){const n=this._entryData[e];if(this._model.isGenericTrace())return this._genericTraceEventColor(n);if(this._performanceModel.timelineModel().isMarkerEvent(n))return ii.markerStyleForEvent(n).color;if(!t.TracingModel.isAsyncPhase(n.phase))return this._colorForEvent(n);if(n.hasCategory(I.TimelineModelImpl.Category.Console)||n.hasCategory(I.TimelineModelImpl.Category.UserTiming))return this._consoleColorGenerator.colorForID(n.name);if(n.hasCategory(I.TimelineModelImpl.Category.LatencyInfo)){const e=U.TimelineIRModel.phaseForEvent(n)||U.Phases.Uncategorized;return i(this._asyncColorByInteractionPhase,e,ii.interactionPhaseColor)}const s=ii.eventStyle(n).category;return i(this._asyncColorByCategory,s,()=>s.color)}if(s===n.Frame)return"white";if(s===n.InteractionRecord)return"transparent";if(s===n.ExtensionEvent){const t=this._entryData[e];return this._extensionColorGenerator.colorForID(t.name)}return""}_genericTraceEventColor(e){const t=e.categoriesString||e.name;return t?`hsl(${String.hashCode(t)%300+30}, 40%, 70%)`:"#ccc"}_drawFrame(e,t,i,n,s,a,r){const o=this._entryData[e];n+=1,a-=2,t.fillStyle=o.idle?"white":o.hasWarnings()?"#fad1d1":"#d7f0d1",t.fillRect(n,s,a,r);const l=Number.preciseMillisToString(o.duration,1),h=t.measureText(l).width;h<=a&&(t.fillStyle=this.textColor(e),t.fillText(l,n+(a-h)/2,s+r-4))}async _drawScreenshot(e,t,i,n,s,a){const r=this._entryData[e];if(!this._screenshotImageCache.has(r)){this._screenshotImageCache.set(r,null);const e=await r.imageDataPromise(),t=await B.loadImageFromData(e);return this._screenshotImageCache.set(r,t),void this.dispatchEventToListeners(Mt.DataChanged)}const o=this._screenshotImageCache.get(r);if(!o)return;const l=i+1,h=n+1,d=a-2,c=d/o.naturalHeight,m=Math.floor(o.naturalWidth*c);t.save(),t.beginPath(),t.rect(i,n,s,a),t.clip(),t.drawImage(o,l,h,m,d),t.strokeStyle="#ccc",t.strokeRect(l-.5,h-.5,Math.min(s-1,m+1),d),t.restore()}decorateEntry(e,t,i,n,s,a,r,o,l){const h=this._entryData[e],d=this._entryType(e),c=Rt;if(d===c.Frame)return this._drawFrame(e,t,i,n,s,a,r),!0;if(d===c.Screenshot)return this._drawScreenshot(e,t,n,s,a,r),!0;if(d===c.InteractionRecord){const e=ii.interactionPhaseColor(h);return t.fillStyle=e,t.fillRect(n,s,a-1,2),t.fillRect(n,s-3,2,3),t.fillRect(n+a-3,s-3,2,3),!1}if(d===c.Event){const e=h;if(e.hasCategory(I.TimelineModelImpl.Category.LatencyInfo)){const i=I.TimelineData.forEvent(e).timeWaitingForMainThread;if(i){t.fillStyle="hsla(0, 70%, 60%, 1)";const e=Math.floor(o-n+i*l);t.fillRect(n,s+r-3,e,2)}}I.TimelineData.forEvent(e).warning&&(m=n,u=a-1.5,t.save(),t.beginPath(),t.rect(m,s,u,r),t.clip(),t.beginPath(),t.fillStyle="red",t.moveTo(m+u-8,s),t.lineTo(m+u,s),t.lineTo(m+u,s+8),t.fill(),t.restore())}var m,u;return!1}forceDecoration(e){const t=Rt,i=this._entryType(e);if(i===t.Frame)return!0;if(i===t.Screenshot)return!0;if(i===t.Event){const t=this._entryData[e];return!!I.TimelineData.forEvent(t).warning}return!1}appendExtensionEvents(e){this._extensionInfo.push(e),this._timelineData&&this._innerAppendExtensionEvents(this._extensionInfo.length-1)}_innerAppendExtensionEvents(e){const t=this._extensionInfo[e],i=Rt.ExtensionEvent,n=[].concat(...t.model.sortedProcesses().map(e=>e.sortedThreads()));if(!n.length)return;const s=!(1!==n.length||n[0].events().length&&n[0].asyncEvents().length);s||this._appendHeader(t.title,this._headerLevel1,!1);const a=s?this._headerLevel2:this._headerLevel1;let r=0;for(const e of n){const n=s?t.title:e.name()||ls`Thread ${++r}`;this._appendAsyncEventsGroup(null,n,e.asyncEvents(),a,i,!1),this._appendSyncEvents(null,e.events(),n,a,i,!1)}}_appendHeader(e,t,i){const n={startLevel:this._currentLevel,name:e,style:t,selectable:i};return this._timelineData.groups.push(n),n}_appendEvent(e,t){const i=this._entryData.length;return this._entryData.push(e),this._timelineData.entryLevels[i]=t,this._timelineData.entryTotalTimes[i]=e.duration||kt,this._timelineData.entryStartTimes[i]=e.startTime,e[Et]=i,i}_appendAsyncEvent(e,i){if(t.TracingModel.isNestableAsyncPhase(e.phase))return void this._appendEvent(e,i);const n=e.steps,s=n.length>1&&n[1].phase===t.Phase.AsyncStepPast?1:0;for(let e=0;e<n.length-1;++e){const t=this._entryData.length;this._entryData.push(n[e+s]);const a=n[e].startTime;this._timelineData.entryLevels[t]=i,this._timelineData.entryTotalTimes[t]=n[e+1].startTime-a,this._timelineData.entryStartTimes[t]=a}}_appendFlowEvent(e,i){const n=this._timelineData;function s(e){const t=n.flowStartTimes.length;return n.flowStartTimes.push(e.startTime),n.flowStartLevels.push(i),t}function a(e,t){n.flowEndTimes[t]=e.startTime,n.flowEndLevels[t]=i}const r=e.id;if(r)switch(e.phase){case t.Phase.FlowBegin:this._flowEventIndexById.set(r,s(e));break;case t.Phase.FlowStep:a(e,this._flowEventIndexById.get(r)),this._flowEventIndexById.set(r,s(e));break;case t.Phase.FlowEnd:a(e,this._flowEventIndexById.get(r)),this._flowEventIndexById.delete(r)}}_appendFrame(e){const t=this._entryData.length;this._entryData.push(e),this._entryIndexToTitle[t]=Number.millisToString(e.duration,!0),this._timelineData.entryLevels[t]=this._currentLevel,this._timelineData.entryTotalTimes[t]=e.duration,this._timelineData.entryStartTimes[t]=e.startTime}createSelection(e){const t=this._entryType(e);let i=null;return t===Rt.Event?i=Qt.fromTraceEvent(this._entryData[e]):t===Rt.Frame&&(i=Qt.fromFrame(this._entryData[e])),i&&(this._lastSelection=new Ft(i,e)),i}formatValue(e,t){return Number.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}entryIndexForSelection(e){if(!e||e.type()===Qt.Type.Range)return-1;if(this._lastSelection&&this._lastSelection.timelineSelection.object()===e.object())return this._lastSelection.entryIndex;const t=this._entryData.indexOf(e.object());return-1!==t&&(this._lastSelection=new Ft(e,t)),t}buildFlowForInitiator(e){if(this._lastInitiatorEntry===e)return!1;this._lastInitiatorEntry=e;let t=this.eventByIndex(e);const i=this._timelineData;for(i.flowStartTimes=[],i.flowStartLevels=[],i.flowEndTimes=[],i.flowEndLevels=[];t;){let e;for(;t&&(e=I.TimelineData.forEvent(t).initiator(),!e);t=this._eventParent(t));if(!e)break;const n=t[Et],s=e[Et];i.flowStartTimes.push(e.endTime||e.startTime),i.flowStartLevels.push(i.entryLevels[s]),i.flowEndTimes.push(t.startTime),i.flowEndLevels.push(i.entryLevels[n]),t=e}return!0}_eventParent(e){return this._entryParent[e[Et]]||null}eventByIndex(e){return e>=0&&this._entryType(e)===Rt.Event?this._entryData[e]:null}setEventColorMapping(e){this._colorForEvent=e}}const kt=.001,Et=Symbol("index"),Mt={DataChanged:Symbol("DataChanged")},Rt={Frame:Symbol("Frame"),Event:Symbol("Event"),InteractionRecord:Symbol("InteractionRecord"),ExtensionEvent:Symbol("ExtensionEvent"),Screenshot:Symbol("Screenshot")};var Pt=Object.freeze({__proto__:null,TimelineFlameChartDataProvider:bt,InstantEventVisibleDurationMs:kt,indexSymbol:Et,Events:Mt,EntryType:Rt});class xt{constructor(){this._font="11px "+fe.fontFamily(),this.setModel(null),this._style={padding:4,height:17,collapsible:!0,color:Fe.instance().patchColorText("#222",Fe.ColorUsage.Foreground),font:this._font,backgroundColor:Fe.instance().patchColorText("white",Fe.ColorUsage.Background),nestingLevel:0,useFirstLineForOverview:!1,useDecoratorsForOverview:!0,shareHeaderLine:!1},this._group={startLevel:0,name:m.UIString("Network"),expanded:!1,style:this._style},this._minimumBoundary=0,this._maximumBoundary=0,this._timeSpan=0}setModel(e){this._model=e&&e.timelineModel(),this._maxLevel=0,this._timelineData=null,this._requests=[]}isEmpty(){return this.timelineData(),!this._requests.length}maxStackDepth(){return this._maxLevel}timelineData(){return this._timelineData||(this._requests=[],this._timelineData=new S.TimelineData([],[],[],[]),this._model&&this._appendTimelineData()),this._timelineData}minimumBoundary(){return this._minimumBoundary}totalTime(){return this._timeSpan}setWindowTimes(e,t){this._startTime=e,this._endTime=t,this._updateTimelineData()}createSelection(e){if(-1===e)return null;const t=this._requests[e];return this._lastSelection=new Ft(Qt.fromNetworkRequest(t),e),this._lastSelection.timelineSelection}entryIndexForSelection(e){if(!e)return-1;if(this._lastSelection&&this._lastSelection.timelineSelection.object()===e.object())return this._lastSelection.entryIndex;if(e.type()!==Qt.Type.NetworkRequest)return-1;const t=e.object(),i=this._requests.indexOf(t);return-1!==i&&(this._lastSelection=new Ft(Qt.fromNetworkRequest(t),i)),i}entryColor(e){const t=this._requests[e],i=ii.networkRequestCategory(t);return ii.networkCategoryColor(i)}textColor(e){return Dt.textColor}entryTitle(e){const t=this._requests[e],i=new _.ParsedURL(t.url||"");return i.isValid?`${i.displayName} (${i.host})`:t.url||null}entryFont(e){return this._font}decorateEntry(e,t,i,n,s,a,r,o,l){const h=this._requests[e];if(!h.timing)return!1;const d=h.beginTime(),c=e=>Math.floor(o+(e-d)*l),m=h.getStartTime(),u=h.endTime,{sendStartTime:p,headersEndTime:_}=h.getSendReceiveTiming(),g=Math.max(c(p),o),f=Math.max(c(_),g),v=Math.max(c(h.finishTime||u),f+2),T=c(m),w=Math.max(c(u),v);if(t.fillStyle="hsla(0, 100%, 100%, 0.8)",t.fillRect(g+.5,s+.5,f-g-.5,r-2),t.fillStyle=Fe.instance().patchColorText("white",Fe.ColorUsage.Background),t.fillRect(n,s-.5,g-n,r),t.fillRect(v,s-.5,n+a-v,r),!h.cached()&&h.timing.pushStart){const i=c(1e3*h.timing.pushStart),n=h.timing.pushEnd?c(1e3*h.timing.pushEnd):T,a=M.clamp(n-i-2,0,4),o=1;if(t.save(),t.beginPath(),t.moveTo(i+a,s+r/2),t.lineTo(i,s+o),t.lineTo(n-a,s+o),t.lineTo(n,s+r/2),t.lineTo(n-a,s+r-o),t.lineTo(i,s+r-o),t.closePath(),h.timing.pushEnd)t.fillStyle=this.entryColor(e);else{const s=t.createLinearGradient(i,0,n,0);s.addColorStop(0,this.entryColor(e)),s.addColorStop(1,"white"),t.fillStyle=s}t.globalAlpha=.3,t.fill(),t.restore()}function S(e,i,n){t.moveTo(e,n-3),t.lineTo(e,n+3),t.moveTo(e,n),t.lineTo(i,n)}t.beginPath(),t.lineWidth=1,t.strokeStyle="#ccc";const y=Math.floor(s+r/2)+.5,C=w-.5;if(S(T+.5,g,y),S(C,v,y),t.stroke(),"string"==typeof h.priority){const e=this._colorForPriority(h.priority);e&&(t.fillStyle=e,t.fillRect(g+.5,s+.5,3.5,3.5))}const b=Math.max(g,0),k=v-b;if(k>=20&&(i=this.entryTitle(e)||"",h.fromServiceWorker&&(i="⚙ "+i),i)){const e=4,n=r-5,a=B.trimTextEnd(t,i,k-2*e);t.fillStyle="#333",t.fillText(a,b+e,s+n)}return!0}forceDecoration(e){return!0}prepareHighlightedEntryInfo(e){const t=this._requests[e];if(!t.url)return null;const i=createElement("div"),n=j.createShadowRootWithCoreStyles(i,"timeline/timelineFlamechartPopover.css").createChild("div","timeline-flamechart-popover"),s=t.getStartTime(),a=t.endTime-s;if(s&&isFinite(a)&&(n.createChild("span","timeline-info-network-time").textContent=Number.millisToString(a,!0)),"string"==typeof t.priority){const e=n.createChild("span");e.textContent=y.uiLabelForNetworkPriority(t.priority),e.style.color=this._colorForPriority(t.priority)||"black"}return n.createChild("span").textContent=t.url.trimMiddle(80),i}_colorForPriority(e){if(!this._priorityToValue){const e=Protocol.Network.ResourcePriority;this._priorityToValue=new Map([[e.VeryLow,1],[e.Low,2],[e.Medium,3],[e.High,4],[e.VeryHigh,5]])}const t=this._priorityToValue.get(e);return t?`hsla(214, 80%, 50%, ${t/5})`:null}_appendTimelineData(){this._minimumBoundary=this._model.minimumRecordTime(),this._maximumBoundary=this._model.maximumRecordTime(),this._timeSpan=this._model.isEmpty()?1e3:this._maximumBoundary-this._minimumBoundary,this._model.networkRequests().forEach(this._appendEntry.bind(this)),this._updateTimelineData()}_updateTimelineData(){if(!this._timelineData)return;const e=[];let t=0;for(let i=0;i<this._requests.length;++i){const n=this._requests[i],s=n.beginTime();if(s<this._endTime&&n.endTime>this._startTime){for(;e.length&&e.peekLast()<=s;)e.pop();this._timelineData.entryLevels[i]=e.length,e.push(n.endTime),t=Math.max(t,e.length)}else this._timelineData.entryLevels[i]=-1}for(let e=0;e<this._requests.length;++e)-1===this._timelineData.entryLevels[e]&&(this._timelineData.entryLevels[e]=t);this._timelineData=new S.TimelineData(this._timelineData.entryLevels,this._timelineData.entryTotalTimes,this._timelineData.entryStartTimes,[this._group]),this._maxLevel=t}_appendEntry(e){this._requests.push(e),this._timelineData.entryStartTimes.push(e.beginTime()),this._timelineData.entryTotalTimes.push(e.endTime-e.beginTime()),this._timelineData.entryLevels.push(this._requests.length-1)}preferredHeight(){return this._style.height*(this._group.expanded?M.clamp(this._maxLevel+1,4,8.5):1)}isExpanded(){return this._group.expanded}formatValue(e,t){return Number.preciseMillisToString(e,t)}canJumpToEntry(e){return!1}navStartTimes(){return this._model?this._model.navStartTimes():new Map}}var Lt=Object.freeze({__proto__:null,TimelineFlameChartNetworkDataProvider:xt});class It extends W.VBox{constructor(e){super(),this.element.classList.add("timeline-flamechart"),this._delegate=e,this._model=null,this._searchResults,this._eventListeners=[],this._showMemoryGraphSetting=p.Settings.instance().createSetting("timelineShowMemory",!1),this._networkSplitWidget=new V.SplitWidget(!1,!1,"timelineFlamechartMainView",150);const t=p.Settings.instance().createSetting("timelineFlamechartMainViewGroupExpansion",{});this._mainDataProvider=new bt,this._mainDataProvider.addEventListener(Mt.DataChanged,()=>this._mainFlameChart.scheduleUpdate()),this._mainFlameChart=new S.FlameChart(this._mainDataProvider,this,t),this._mainFlameChart.alwaysShowVerticalScroll(),this._mainFlameChart.enableRuler(!1),this._networkFlameChartGroupExpansionSetting=p.Settings.instance().createSetting("timelineFlamechartNetworkViewGroupExpansion",{}),this._networkDataProvider=new xt,this._networkFlameChart=new S.FlameChart(this._networkDataProvider,this,this._networkFlameChartGroupExpansionSetting),this._networkFlameChart.alwaysShowVerticalScroll(),this._networkFlameChart.disableRangeSelection(),this._networkPane=new W.VBox,this._networkPane.setMinimumSize(23,23),this._networkFlameChart.show(this._networkPane.element),this._splitResizer=this._networkPane.element.createChild("div","timeline-flamechart-resizer"),this._networkSplitWidget.hideDefaultResizer(!0),this._networkSplitWidget.installResizer(this._splitResizer),this._networkSplitWidget.setMainWidget(this._mainFlameChart),this._networkSplitWidget.setSidebarWidget(this._networkPane),this._chartSplitWidget=new V.SplitWidget(!1,!0,"timelineCountersSplitViewState"),this._countersView=new gi(this._delegate),this._chartSplitWidget.setMainWidget(this._networkSplitWidget),this._chartSplitWidget.setSidebarWidget(this._countersView),this._chartSplitWidget.hideDefaultResizer(),this._chartSplitWidget.installResizer(this._countersView.resizerElement()),this._updateCountersGraphToggle(),this._detailsSplitWidget=new V.SplitWidget(!1,!0,"timelinePanelDetailsSplitViewState"),this._detailsSplitWidget.element.classList.add("timeline-details-split"),this._detailsView=new St(e),this._detailsSplitWidget.installResizer(this._detailsView.headerElement()),this._detailsSplitWidget.setMainWidget(this._chartSplitWidget),this._detailsSplitWidget.setSidebarWidget(this._detailsView),this._detailsSplitWidget.show(this.element),this._onMainEntrySelected=this._onEntrySelected.bind(this,this._mainDataProvider),this._onNetworkEntrySelected=this._onEntrySelected.bind(this,this._networkDataProvider),this._mainFlameChart.addEventListener(S.Events.EntrySelected,this._onMainEntrySelected,this),this._mainFlameChart.addEventListener(S.Events.EntryInvoked,this._onMainEntrySelected,this),this._networkFlameChart.addEventListener(S.Events.EntrySelected,this._onNetworkEntrySelected,this),this._networkFlameChart.addEventListener(S.Events.EntryInvoked,this._onNetworkEntrySelected,this),this._mainFlameChart.addEventListener(S.Events.EntryHighlighted,this._onEntryHighlighted,this),this._nextExtensionIndex=0,this._boundRefresh=this._refresh.bind(this),this._selectedTrack=null,this._mainDataProvider.setEventColorMapping(ii.eventColor),this._groupBySetting=p.Settings.instance().createSetting("timelineTreeGroupBy",lt.GroupBy.None),this._groupBySetting.addChangeListener(this._updateColorMapper,this),this._updateColorMapper()}_updateColorMapper(){this._urlToColorCache=new Map,this._model&&(this._mainDataProvider.setEventColorMapping(ii.eventColor),this._mainFlameChart.update())}_onWindowChanged(e){const t=e.data.window,i=!!e.data.animate;this._mainFlameChart.setWindowTimes(t.left,t.right,i),this._networkFlameChart.setWindowTimes(t.left,t.right,i),this._networkDataProvider.setWindowTimes(t.left,t.right),this._updateSearchResults(!1,!1)}windowChanged(e,t,i){this._model.setWindow({left:e,right:t},i)}updateRangeSelection(e,t){this._delegate.select(Qt.fromRange(e,t))}updateSelectedGroup(e,t){if(e!==this._mainFlameChart)return;const i=t?this._mainDataProvider.groupTrack(t):null;this._selectedTrack=i,this._updateTrack()}setModel(e){if(e!==this._model){if(v.EventTarget.removeEventListeners(this._eventListeners),this._model=e,this._selectedTrack=null,this._mainDataProvider.setModel(this._model),this._networkDataProvider.setModel(this._model),this._model){this._eventListeners=[this._model.addEventListener(pi.WindowChanged,this._onWindowChanged,this),this._model.addEventListener(pi.ExtensionDataAdded,this._appendExtensionData,this)];const t=e.window();this._mainFlameChart.setWindowTimes(t.left,t.right),this._networkFlameChart.setWindowTimes(t.left,t.right),this._networkDataProvider.setWindowTimes(t.left,t.right),this._updateSearchResults(!1,!1)}this._updateColorMapper(),this._updateTrack(),this._nextExtensionIndex=0,this._appendExtensionData(),this._refresh()}}_updateTrack(){this._countersView.setModel(this._model,this._selectedTrack),this._detailsView.setModel(this._model,this._selectedTrack)}_refresh(){this._networkDataProvider.isEmpty()?(this._mainFlameChart.enableRuler(!0),this._networkSplitWidget.hideSidebar()):(this._mainFlameChart.enableRuler(!1),this._networkSplitWidget.showBoth(),this.resizeToPreferredHeights()),this._mainFlameChart.reset(),this._networkFlameChart.reset(),this._updateSearchResults(!1,!1)}_appendExtensionData(){if(!this._model)return;const e=this._model.extensionInfo();for(;this._nextExtensionIndex<e.length;)this._mainDataProvider.appendExtensionEvents(e[this._nextExtensionIndex++]);this._mainFlameChart.scheduleUpdate()}_onEntryHighlighted(t){e.OverlayModel.hideDOMNodeHighlight();const i=t.data,n=this._mainDataProvider.eventByIndex(i);if(!n)return;const s=this._model&&this._model.timelineModel().targetByEvent(n);if(!s)return;const a=I.TimelineData.forEvent(n).backendNodeId;a&&new o.DeferredDOMNode(s,a).highlight()}highlightEvent(e){const t=e?this._mainDataProvider.entryIndexForSelection(Qt.fromTraceEvent(e)):-1;t>=0?this._mainFlameChart.highlightEntry(t):this._mainFlameChart.hideHighlight()}willHide(){this._networkFlameChartGroupExpansionSetting.removeChangeListener(this.resizeToPreferredHeights,this),this._showMemoryGraphSetting.removeChangeListener(this._updateCountersGraphToggle,this),he.BlackboxManager.instance().removeChangeListener(this._boundRefresh)}wasShown(){this._networkFlameChartGroupExpansionSetting.addChangeListener(this.resizeToPreferredHeights,this),this._showMemoryGraphSetting.addChangeListener(this._updateCountersGraphToggle,this),he.BlackboxManager.instance().addChangeListener(this._boundRefresh),this._needsResizeToPreferredHeights&&this.resizeToPreferredHeights(),this._mainFlameChart.scheduleUpdate(),this._networkFlameChart.scheduleUpdate()}_updateCountersGraphToggle(){this._showMemoryGraphSetting.get()?this._chartSplitWidget.showBoth():this._chartSplitWidget.hideSidebar()}setSelection(e){let t=this._mainDataProvider.entryIndexForSelection(e);this._mainFlameChart.setSelectedEntry(t),t=this._networkDataProvider.entryIndexForSelection(e),this._networkFlameChart.setSelectedEntry(t),this._detailsView&&this._detailsView.setSelection(e)}_onEntrySelected(e,t){const i=t.data;Root.Runtime.experiments.isEnabled("timelineEventInitiators")&&e===this._mainDataProvider&&this._mainDataProvider.buildFlowForInitiator(i)&&this._mainFlameChart.scheduleUpdate(),this._delegate.select(e.createSelection(i))}resizeToPreferredHeights(){this.isShowing()?(this._needsResizeToPreferredHeights=!1,this._networkPane.element.classList.toggle("timeline-network-resizer-disabled",!this._networkDataProvider.isExpanded()),this._networkSplitWidget.setSidebarSize(this._networkDataProvider.preferredHeight()+this._splitResizer.clientHeight+S.HeaderHeight+2)):this._needsResizeToPreferredHeights=!0}setSearchableView(e){this._searchableView=e}jumpToNextSearchResult(){if(!this._searchResults||!this._searchResults.length)return;const e=void 0!==this._selectedSearchResult?this._searchResults.indexOf(this._selectedSearchResult):-1;this._selectSearchResult(M.mod(e+1,this._searchResults.length))}jumpToPreviousSearchResult(){if(!this._searchResults||!this._searchResults.length)return;const e=void 0!==this._selectedSearchResult?this._searchResults.indexOf(this._selectedSearchResult):0;this._selectSearchResult(M.mod(e-1,this._searchResults.length))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!0}_selectSearchResult(e){this._searchableView.updateCurrentMatchIndex(e),this._selectedSearchResult=this._searchResults[e],this._delegate.select(this._mainDataProvider.createSelection(this._selectedSearchResult))}_updateSearchResults(e,t){const i=this._selectedSearchResult;if(delete this._selectedSearchResult,this._searchResults=[],!this._searchRegex||!this._model)return;const n=new nt(this._searchRegex),s=this._model.window();if(this._searchResults=this._mainDataProvider.search(s.left,s.right,n),this._searchableView.updateSearchMatchesCount(this._searchResults.length),!e||!this._searchResults.length)return;let a=this._searchResults.indexOf(i);-1===a&&(a=t?this._searchResults.length-1:0),this._selectSearchResult(a)}searchCanceled(){void 0!==this._selectedSearchResult&&this._delegate.select(null),delete this._searchResults,delete this._selectedSearchResult,delete this._searchRegex}performSearch(e,t,i){this._searchRegex=e.toSearchRegex(),this._updateSearchResults(t,i)}}class Ft{constructor(e,t){this.timelineSelection=e,this.entryIndex=t}}const Dt={textColor:"#333"};class Ut{constructor(e,t,i){this._startTime=e,this._startOffset=t,this._style=i}startTime(){return this._startTime}color(){return this._style.color}title(){if(this._style.lowPriority)return null;const e=Number.millisToString(this._startOffset);return ls`${this._style.title} at ${e}`}draw(e,t,i,n){this._style.lowPriority&&n<4||(e.save(),this._style.tall&&(e.strokeStyle=this._style.color,e.lineWidth=this._style.lineWidth,e.translate(this._style.lineWidth<1||1&this._style.lineWidth?.5:0,.5),e.beginPath(),e.moveTo(t,0),e.setLineDash(this._style.dashStyle),e.lineTo(t,e.canvas.height),e.stroke()),e.restore())}}var Nt=Object.freeze({__proto__:null,TimelineFlameChartView:It,Selection:Ft,FlameChartStyle:Dt,TimelineFlameChartMarker:Ut,ColorBy:{URL:"URL"}});class Bt{constructor(){this._recordings=[],this._action=q.ActionRegistry.instance().action("timeline.show-history"),this._nextNumberByDomain=new Map,this._button=new Ht(this._action),G.markAsMenuButton(this._button.element),this.clear(),this._allOverviews=[{constructor:Je,height:3},{constructor:Ke,height:16},{constructor:$e,height:20},{constructor:qe,height:8}],this._totalHeight=this._allOverviews.reduce((e,t)=>e+t.height,0),this._enabled=!0,this._lastActiveModel=null}addRecording(e){this._lastActiveModel=e,this._recordings.unshift(e),this._buildPreview(e);const t=this._title(e);this._button.setText(t);const i=this._action.title();if(G.setAccessibleName(this._button.element,ls`Current Session: ${t}. ${i}`),this._updateState(),this._recordings.length<=Wt)return;const n=this._recordings.reduce((e,t)=>s(e)<s(t)?e:t);function s(e){return Bt._dataForModel(e).lastUsed}this._recordings.splice(this._recordings.indexOf(n),1),n.dispose()}setEnabled(e){this._enabled=e,this._updateState()}button(){return this._button}clear(){this._recordings.forEach(e=>e.dispose()),this._recordings=[],this._lastActiveModel=null,this._updateState(),this._button.setText(m.UIString("(no recordings)")),this._nextNumberByDomain.clear()}async showHistoryDropDown(){if(this._recordings.length<2||!this._enabled)return null;const e=await Gt.show(this._recordings,this._lastActiveModel,this._button.element);if(!e)return null;return this._recordings.indexOf(e)<0?(console.assert(!1,"selected recording not found"),null):(this._setCurrentModel(e),e)}cancelIfShowing(){Gt.cancelIfShowing()}navigate(e){if(!this._enabled||!this._lastActiveModel)return null;const t=this._recordings.indexOf(this._lastActiveModel);if(t<0)return null;const i=M.clamp(t+e,0,this._recordings.length-1),n=this._recordings[i];return this._setCurrentModel(n),n}_setCurrentModel(e){Bt._dataForModel(e).lastUsed=Date.now(),this._lastActiveModel=e;const t=this._title(e),i=this._action.title();this._button.setText(t),G.setAccessibleName(this._button.element,ls`Current Session: ${t}. ${i}`)}_updateState(){this._action.setEnabled(this._recordings.length>1&&this._enabled)}static _previewElement(e){const t=Bt._dataForModel(e),i=e.recordStartTime();return t.time.textContent=i?m.UIString("(%s ago)",Bt._coarseAge(i)):"",t.preview}static _coarseAge(e){const t=Math.round((Date.now()-e)/1e3);if(t<50)return m.UIString("moments");const i=Math.round(t/60);if(i<50)return m.UIString("%s m",i);const n=Math.round(i/60);return m.UIString("%s h",n)}_title(e){return Bt._dataForModel(e).title}_buildPreview(e){const t=_.ParsedURL.fromString(e.timelineModel().pageURL()),i=t?t.host:"",n=this._nextNumberByDomain.get(i)||1,s=m.UIString("%s #%d",i,n);this._nextNumberByDomain.set(i,n+1);const a=createElement("span"),r=document.createElement("div");r.classList.add("preview-item"),r.classList.add("vbox");const o={preview:r,title:s,time:a,lastUsed:Date.now()};e[At]=o,r.appendChild(this._buildTextDetails(e,s,a));const l=r.createChild("div","hbox");return l.appendChild(this._buildScreenshotThumbnail(e)),l.appendChild(this._buildOverview(e)),o.preview}_buildTextDetails(e,t,i){const n=document.createElement("div");n.classList.add("text-details"),n.classList.add("hbox");const s=n.createChild("span","name");s.textContent=t,G.setAccessibleName(s,t);const a=e.tracingModel(),r=Number.millisToString(a.maximumRecordTime()-a.minimumRecordTime(),!1),o=n.createChild("span","time");return o.appendChild(createTextNode(r)),o.appendChild(i),n}_buildScreenshotThumbnail(e){const t=document.createElement("div");t.classList.add("screenshot-thumb");t.style.width=1.5*this._totalHeight+"px",t.style.height=this._totalHeight+"px";const i=e.filmStripModel().frames().peekLast();return i?(i.imageDataPromise().then(e=>B.loadImageFromData(e)).then(e=>e&&t.appendChild(e)),t):t}_buildOverview(e){const t=createElement("div");t.style.width=Vt+"px",t.style.height=this._totalHeight+"px";const i=t.createChild("canvas");i.width=window.devicePixelRatio*Vt,i.height=window.devicePixelRatio*this._totalHeight;const n=i.getContext("2d");let s=0;for(const t of this._allOverviews){const i=new t.constructor;i.setCanvasSize(Vt,t.height),i.setModel(e),i.update();const a=i.context(),r=a.getImageData(0,0,a.canvas.width,a.canvas.height);n.putImageData(r,0,s),s+=t.height*window.devicePixelRatio}return t}static _dataForModel(e){return e[At]||null}}const Wt=5,Vt=450,At=Symbol("previewData");class Gt{constructor(e){this._glassPane=new $.GlassPane,this._glassPane.setSizeBehavior($.SizeBehavior.MeasureContent),this._glassPane.setOutsideClickCallback(()=>this._close(null)),this._glassPane.setPointerEventsBehavior($.PointerEventsBehavior.BlockedByGlassPane),this._glassPane.setAnchorBehavior($.AnchorBehavior.PreferBottom),this._glassPane.element.addEventListener("blur",()=>this._close(null));const t=j.createShadowRootWithCoreStyles(this._glassPane.contentElement,"timeline/timelineHistoryManager.css").createChild("div","drop-down"),i=new J.ListModel;this._listControl=new X.ListControl(i,this,X.ListMode.NonViewport),this._listControl.element.addEventListener("mousemove",this._onMouseMove.bind(this),!1),i.replaceAll(e),G.markAsMenu(this._listControl.element),G.setAccessibleName(this._listControl.element,ls`Select Timeline Session`),t.appendChild(this._listControl.element),t.addEventListener("keydown",this._onKeyDown.bind(this),!1),t.addEventListener("click",this._onClick.bind(this),!1),this._focusRestorer=new B.ElementFocusRestorer(this._listControl.element),this._selectionDone=null}static show(e,t,i){if(Gt._instance)return Promise.resolve(null);return new Gt(e)._show(i,t)}static cancelIfShowing(){Gt._instance&&Gt._instance._close(null)}_show(e,t){return Gt._instance=this,this._glassPane.setContentAnchorBox(e.boxInWindow()),this._glassPane.show(this._glassPane.contentElement.ownerDocument),this._listControl.element.focus(),this._listControl.selectItem(t),new Promise(e=>{this._selectionDone=e})}_onMouseMove(e){const t=e.target.enclosingNodeOrSelfWithClass("preview-item"),i=t&&this._listControl.itemForNode(t);i&&this._listControl.selectItem(i)}_onClick(e){e.target.enclosingNodeOrSelfWithClass("preview-item")&&this._close(this._listControl.selectedItem())}_onKeyDown(e){switch(e.key){case"Tab":case"Escape":this._close(null);break;case"Enter":this._close(this._listControl.selectedItem());break;default:return}e.consume(!0)}_close(e){this._selectionDone(e),this._focusRestorer.restore(),this._glassPane.hide(),Gt._instance=null}createElementForItem(e){const t=Bt._previewElement(e);return G.markAsMenuItem(t),t.classList.remove("selected"),t}heightForItem(e){return console.assert(!1,"Should not be called"),0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,n){i&&i.classList.remove("selected"),n&&n.classList.add("selected")}updateSelectedItemARIA(e,t){return!1}}Gt._instance=null;class Ht extends A.ToolbarItem{constructor(e){const t=document.createElement("button");t.classList.add("history-dropdown-button"),super(t),j.appendStyle(this.element,"timeline/historyToolbarButton.css"),this._contentElement=this.element.createChild("span","content");const i=K.Icon.create("smallicon-triangle-down");this.element.appendChild(i),this.element.addEventListener("click",()=>{e.execute()},!1),this.setEnabled(e.enabled()),e.addEventListener(Y.Events.Enabled,e=>this.setEnabled(e.data)),this.setTitle(e.title())}setText(e){this._contentElement.textContent=e}}var Ot=Object.freeze({__proto__:null,TimelineHistoryManager:Bt,maxRecordings:Wt,previewWidth:Vt,previewDataSymbol:At,DropDown:Gt,ToolbarButton:Ht,PreviewData:void 0});class zt{static isUiDevTools(){return"true"===Root.Runtime.queryParam("uiDevTools")}static categorizeEvents(){if(zt._eventStylesMap)return zt._eventStylesMap;const e=jt,t=zt.categories(),i=t.drawing,n=t.rasterizing,s=t.layout,a=t.painting,r=t.other,o={};return o[e.ViewPaint]=new ni(ls`View::Paint`,a),o[e.ViewOnPaint]=new ni(ls`View::OnPaint`,a),o[e.ViewPaintChildren]=new ni(ls`View::PaintChildren`,a),o[e.ViewOnPaintBackground]=new ni(ls`View::OnPaintBackground`,a),o[e.ViewOnPaintBorder]=new ni(ls`View::OnPaintBorder`,a),o[e.LayerPaintContentsToDisplayList]=new ni(ls`Layer::PaintContentsToDisplayList`,a),o[e.ViewLayout]=new ni(ls`View::Layout`,s),o[e.ViewLayoutBoundsChanged]=new ni(ls`View::Layout(bounds_changed)`,s),o[e.RasterTask]=new ni(ls`RasterTask`,n),o[e.RasterizerTaskImplRunOnWorkerThread]=new ni(ls`RasterizerTaskImpl::RunOnWorkerThread`,n),o[e.DirectRendererDrawFrame]=new ni(ls`DirectRenderer::DrawFrame`,i),o[e.BeginFrame]=new ni(ls`Frame Start`,i,!0),o[e.DrawFrame]=new ni(ls`Draw Frame`,i,!0),o[e.NeedsBeginFrameChanged]=new ni(ls`NeedsBeginFrameChanged`,i,!0),o[e.ThreadControllerImplRunTask]=new ni(ls`ThreadControllerImpl::RunTask`,r),zt._eventStylesMap=o,o}static categories(){return zt._categories||(zt._categories={layout:new hi("layout",ls`Layout`,!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),rasterizing:new hi("rasterizing",ls`Rasterizing`,!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),drawing:new hi("drawing",ls`Drawing`,!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new hi("painting",ls`Painting`,!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),other:new hi("other",ls`System`,!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new hi("idle",ls`Idle`,!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")}),zt._categories}static getMainCategoriesList(){return["idle","drawing","painting","rasterizing","layout","other"]}}const jt={ViewPaint:"View::Paint",ViewOnPaint:"View::OnPaint",ViewPaintChildren:"View::PaintChildren",ViewOnPaintBackground:"View::OnPaintBackground",ViewOnPaintBorder:"View::OnPaintBorder",ViewLayout:"View::Layout",ViewLayoutBoundsChanged:"View::Layout(bounds_changed)",LayerPaintContentsToDisplayList:"Layer::PaintContentsToDisplayList",DirectRendererDrawFrame:"DirectRenderer::DrawFrame",RasterTask:"RasterTask",RasterizerTaskImplRunOnWorkerThread:"RasterizerTaskImpl::RunOnWorkerThread",BeginFrame:"BeginFrame",DrawFrame:"DrawFrame",NeedsBeginFrameChanged:"NeedsBeginFrameChanged",ThreadControllerImplRunTask:"ThreadControllerImpl::RunTask"};var qt=Object.freeze({__proto__:null,UIDevtoolsUtils:zt,RecordType:jt});class $t extends He{constructor(e,t){super(e,t),ii.setEventStylesMap(zt.categorizeEvents()),ii.setCategories(zt.categories()),ii.setTimelineMainEventCategories(zt.getMainCategoriesList())}}var Jt=Object.freeze({__proto__:null,UIDevtoolsController:$t});class Xt extends Q.Panel{constructor(){super("timeline"),this.registerRequiredCSS("timeline/timelinePanel.css"),this.element.addEventListener("contextmenu",this._contextMenu.bind(this),!1),this._dropTarget=new Z.DropTarget(this.element,[Z.Type.File,Z.Type.URI],m.UIString("Drop timeline file or URL here"),this._handleDrop.bind(this)),this._recordingOptionUIControls=[],this._state=Kt.Idle,this._recordingPageReload=!1,this._millisecondsToRecordAfterLoadEvent=5e3,this._toggleRecordAction=q.ActionRegistry.instance().action("timeline.toggle-recording"),this._recordReloadAction=q.ActionRegistry.instance().action("timeline.record-reload"),this._historyManager=new Bt,this._performanceModel=null,this._viewModeSetting=p.Settings.instance().createSetting("timelineViewMode",Yt.FlameChart),this._disableCaptureJSProfileSetting=p.Settings.instance().createSetting("timelineDisableJSSampling",!1),this._disableCaptureJSProfileSetting.setTitle(m.UIString("Disable JavaScript samples")),this._captureLayersAndPicturesSetting=p.Settings.instance().createSetting("timelineCaptureLayersAndPictures",!1),this._captureLayersAndPicturesSetting.setTitle(m.UIString("Enable advanced paint instrumentation (slow)")),this._showScreenshotsSetting=p.Settings.instance().createSetting("timelineShowScreenshots",!0),this._showScreenshotsSetting.setTitle(m.UIString("Screenshots")),this._showScreenshotsSetting.addChangeListener(this._updateOverviewControls,this),this._startCoverage=p.Settings.instance().createSetting("timelineStartCoverage",!1),this._startCoverage.setTitle(ls`Coverage`),Root.Runtime.experiments.isEnabled("recordCoverageWithPerformanceTracing")||this._startCoverage.set(!1),this._showMemorySetting=p.Settings.instance().createSetting("timelineShowMemory",!1),this._showMemorySetting.setTitle(m.UIString("Memory")),this._showMemorySetting.addChangeListener(this._onModeChanged,this);const e=this.element.createChild("div","timeline-toolbar-container");this._panelToolbar=new A.Toolbar("timeline-main-toolbar",e),this._panelRightToolbar=new A.Toolbar("",e),this._createSettingsPane(),this._updateShowSettingsToolbarButton(),this._timelinePane=new W.VBox,this._timelinePane.show(this.element);const t=this._timelinePane.element.createChild("div","hbox");t.id="timeline-overview-panel",this._overviewPane=new w.TimelineOverviewPane("timeline"),this._overviewPane.addEventListener(w.Events.WindowChanged,this._onOverviewWindowChanged.bind(this)),this._overviewPane.show(t),this._overviewControls=[],this._statusPaneContainer=this._timelinePane.element.createChild("div","status-pane-container fill"),this._createFileSelector(),n.TargetManager.instance().addModelListener(l.ResourceTreeModel,l.Events.Load,this._loadEventFired,this),this._flameChart=new It(this),this._searchableView=new ee.SearchableView(this._flameChart),this._searchableView.setMinimumSize(0,100),this._searchableView.element.classList.add("searchable-view"),this._searchableView.show(this._timelinePane.element),this._flameChart.show(this._searchableView.element),this._flameChart.setSearchableView(this._searchableView),this._searchableView.hideWidget(),this._onModeChanged(),this._populateToolbar(),this._showLandingPage(),this._updateTimelineControls(),_e.ExtensionServer.instance().addEventListener(_e.Events.TraceProviderAdded,this._appendExtensionsToToolbar,this),n.TargetManager.instance().addEventListener(n.Events.SuspendStateChanged,this._onSuspendStateChanged,this)}static instance(){return self.runtime.sharedInstance(Xt)}searchableView(){return this._searchableView}wasShown(){te.Context.instance().setFlavor(Xt,this),ve.panelLoaded("timeline","DevTools.Launch.Timeline")}willHide(){te.Context.instance().setFlavor(Xt,null),this._historyManager.cancelIfShowing()}loadFromEvents(e){this._state===Kt.Idle&&(this._prepareToLoadTimeline(),this._loader=Ne.loadFromEvents(e,this))}_onOverviewWindowChanged(e){const t=e.data.startTime,i=e.data.endTime;this._performanceModel.setWindow({left:t,right:i},!0)}_onModelWindowChanged(e){const t=e.data.window;this._overviewPane.setWindowTimes(t.left,t.right)}_setState(e){this._state=e,this._updateTimelineControls()}_createSettingCheckbox(e,t){const i=new A.ToolbarSettingCheckbox(e,t);return this._recordingOptionUIControls.push(i),i}_populateToolbar(){this._panelToolbar.appendToolbarItem(A.Toolbar.createActionButton(this._toggleRecordAction)),this._panelToolbar.appendToolbarItem(A.Toolbar.createActionButton(this._recordReloadAction)),this._clearButton=new A.ToolbarButton(m.UIString("Clear"),"largeicon-clear"),this._clearButton.addEventListener(A.ToolbarButton.Events.Click,()=>this._onClearButton()),this._panelToolbar.appendToolbarItem(this._clearButton),this._loadButton=new A.ToolbarButton(m.UIString("Load profile…"),"largeicon-load"),this._loadButton.addEventListener(A.ToolbarButton.Events.Click,()=>this._selectFileToLoad()),this._saveButton=new A.ToolbarButton(m.UIString("Save profile…"),"largeicon-download"),this._saveButton.addEventListener(A.ToolbarButton.Events.Click,e=>{this._saveToFile()}),this._panelToolbar.appendSeparator(),this._panelToolbar.appendToolbarItem(this._loadButton),this._panelToolbar.appendToolbarItem(this._saveButton),this._panelToolbar.appendSeparator(),this._panelToolbar.appendToolbarItem(this._historyManager.button()),this._panelToolbar.appendSeparator(),this._panelToolbar.appendSeparator(),this._showScreenshotsToolbarCheckbox=this._createSettingCheckbox(this._showScreenshotsSetting,m.UIString("Capture screenshots")),this._panelToolbar.appendToolbarItem(this._showScreenshotsToolbarCheckbox),this._showMemoryToolbarCheckbox=this._createSettingCheckbox(this._showMemorySetting,m.UIString("Show memory timeline")),this._panelToolbar.appendToolbarItem(this._showMemoryToolbarCheckbox),Root.Runtime.experiments.isEnabled("recordCoverageWithPerformanceTracing")&&(this._startCoverageCheckbox=this._createSettingCheckbox(this._startCoverage,ls`Record coverage with performance trace`),this._panelToolbar.appendToolbarItem(this._startCoverageCheckbox)),this._panelToolbar.appendToolbarItem(A.Toolbar.createActionButtonForId("components.collect-garbage")),this._panelRightToolbar.appendSeparator(),this._panelRightToolbar.appendToolbarItem(this._showSettingsPaneButton)}_createSettingsPane(){this._showSettingsPaneSetting=p.Settings.instance().createSetting("timelineShowSettingsToolbar",!1),this._showSettingsPaneButton=new A.ToolbarSettingToggle(this._showSettingsPaneSetting,"largeicon-settings-gear",m.UIString("Capture settings")),h.MultitargetNetworkManager.instance().addEventListener(h.MultitargetNetworkManager.Events.ConditionsChanged,this._updateShowSettingsToolbarButton,this),we.throttlingManager().addEventListener(we.Events.RateChanged,this._updateShowSettingsToolbarButton,this),this._disableCaptureJSProfileSetting.addChangeListener(this._updateShowSettingsToolbarButton,this),this._captureLayersAndPicturesSetting.addChangeListener(this._updateShowSettingsToolbarButton,this),this._settingsPane=new W.HBox,this._settingsPane.element.classList.add("timeline-settings-pane"),this._settingsPane.show(this.element);const e=new A.Toolbar("",this._settingsPane.element);e.element.classList.add("flex-auto"),e.makeVertical(),e.appendToolbarItem(this._createSettingCheckbox(this._disableCaptureJSProfileSetting,m.UIString("Disables JavaScript sampling, reduces overhead when running against mobile devices"))),e.appendToolbarItem(this._createSettingCheckbox(this._captureLayersAndPicturesSetting,m.UIString("Captures advanced paint instrumentation, introduces significant performance overhead")));const t=new W.VBox;t.element.classList.add("flex-auto"),t.show(this._settingsPane.element);const i=new A.Toolbar("",t.element);i.appendText(m.UIString("Network:")),this._networkThrottlingSelect=this._createNetworkConditionsSelect(),i.appendToolbarItem(this._networkThrottlingSelect);const n=new A.Toolbar("",t.element);n.appendText(m.UIString("CPU:")),this._cpuThrottlingSelect=we.throttlingManager().createCPUThrottlingSelector(),n.appendToolbarItem(this._cpuThrottlingSelect),this._showSettingsPaneSetting.addChangeListener(this._updateSettingsPaneVisibility.bind(this)),this._updateSettingsPaneVisibility()}_appendExtensionsToToolbar(e){const t=e.data,i=Xt._settingForTraceProvider(t),n=this._createSettingCheckbox(i,t.longDisplayName());this._panelToolbar.appendToolbarItem(n)}static _settingForTraceProvider(e){let t=e[ei];if(!t){const i=e.persistentIdentifier();t=p.Settings.instance().createSetting(i,!1),t.setTitle(e.shortDisplayName()),e[ei]=t}return t}_createNetworkConditionsSelect(){const e=new A.ToolbarComboBox(null,ls`Network conditions`);return e.setMaxWidth(140),we.throttlingManager().decorateSelectWithNetworkThrottling(e.selectElement()),e}_prepareToLoadTimeline(){console.assert(this._state===Kt.Idle),this._setState(Kt.Loading),this._performanceModel&&(this._performanceModel.dispose(),this._performanceModel=null)}_createFileSelector(){this._fileSelectorElement&&this._fileSelectorElement.remove(),this._fileSelectorElement=B.createFileSelectorElement(this._loadFromFile.bind(this)),this._timelinePane.element.appendChild(this._fileSelectorElement)}_contextMenu(e){const t=new ie.ContextMenu(e);t.appendItemsAtLocation("timelineMenu"),t.show()}async _saveToFile(){if(this._state!==Kt.Idle)return;const e=this._performanceModel;if(!e)return;const t=new Date,i="Profile-"+R.toISO8601Compact(t)+".json",n=new le.FileOutputStream;if(!await n.open(i))return;const s=await e.save(n);s&&u.Console.instance().error(m.UIString("Failed to save timeline: %s (%s, %s)",s.message,s.name,s.code))}async _showHistory(){const e=await this._historyManager.showHistoryDropDown();e&&e!==this._performanceModel&&this._setModel(e)}_navigateHistory(e){const t=this._historyManager.navigate(e);return t&&t!==this._performanceModel&&this._setModel(t),!0}_selectFileToLoad(){this._fileSelectorElement.click()}_loadFromFile(e){this._state===Kt.Idle&&(this._prepareToLoadTimeline(),this._loader=Ne.loadFromFile(e,this),this._createFileSelector())}_loadFromURL(e){this._state===Kt.Idle&&(this._prepareToLoadTimeline(),this._loader=Ne.loadFromURL(e,this))}_updateOverviewControls(){this._overviewControls=[],this._overviewControls.push(new Je),Root.Runtime.experiments.isEnabled("inputEventsOnTimelineOverview")&&this._overviewControls.push(new je),this._overviewControls.push(new Ke),this._overviewControls.push(new $e),this._overviewControls.push(new qe),this._showScreenshotsSetting.get()&&this._performanceModel&&this._performanceModel.filmStripModel().frames().length&&this._overviewControls.push(new Xe),this._showMemorySetting.get()&&this._overviewControls.push(new Ye),this._startCoverage.get()&&this._overviewControls.push(new Ze);for(const e of this._overviewControls)e.setModel(this._performanceModel);this._overviewPane.setOverviewControls(this._overviewControls)}_onModeChanged(){this._updateOverviewControls(),this.doResize(),this.select(null)}_updateSettingsPaneVisibility(){this._showSettingsPaneSetting.get()?this._settingsPane.showWidget():this._settingsPane.hideWidget()}_updateShowSettingsToolbarButton(){const e=[];if(1!==we.throttlingManager().cpuThrottlingRate()&&e.push(m.UIString("- CPU throttling is enabled")),h.MultitargetNetworkManager.instance().isThrottling()&&e.push(m.UIString("- Network throttling is enabled")),this._captureLayersAndPicturesSetting.get()&&e.push(m.UIString("- Significant overhead due to paint instrumentation")),this._disableCaptureJSProfileSetting.get()&&e.push(m.UIString("- JavaScript sampling is disabled")),this._showSettingsPaneButton.setDefaultWithRedColor(e.length),this._showSettingsPaneButton.setToggleWithRedColor(e.length),e.length){const t=createElement("div");e.forEach(e=>{t.createChild("div").textContent=e}),this._showSettingsPaneButton.setTitle(t)}else this._showSettingsPaneButton.setTitle(m.UIString("Capture settings"))}_setUIControlsEnabled(e){this._recordingOptionUIControls.forEach(t=>t.setEnabled(e))}async _startRecording(){console.assert(!this._statusPane,"Status pane is already opened."),this._setState(Kt.StartPending);const e={enableJSSampling:!this._disableCaptureJSProfileSetting.get(),capturePictures:this._captureLayersAndPicturesSetting.get(),captureFilmStrip:this._showScreenshotsSetting.get(),startCoverage:this._startCoverage.get()};e.startCoverage&&await ne.ViewManager.instance().showView("coverage").then(()=>ne.ViewManager.instance().view("coverage").widget()).then(e=>e.ensureRecordingStarted()),this._showRecordingStarted();const t=_e.ExtensionServer.instance().traceProviders().filter(e=>Xt._settingForTraceProvider(e).get()),i=n.TargetManager.instance().mainTarget();zt.isUiDevTools()?this._controller=new $t(i,this):this._controller=new He(i,this),this._setUIControlsEnabled(!1),this._hideLandingPage();const s=await this._controller.startRecording(e,t);s[Se.ProtocolError]?this._recordingFailed(s[Se.ProtocolError]):this._recordingStarted()}async _stopRecording(){this._statusPane&&(this._statusPane.finish(),this._statusPane.updateStatus(m.UIString("Stopping timeline…")),this._statusPane.updateProgressBar(m.UIString("Received"),0)),this._setState(Kt.StopPending),this._startCoverage.get()&&await ne.ViewManager.instance().showView("coverage").then(()=>ne.ViewManager.instance().view("coverage").widget()).then(e=>e.stopRecording());const e=await this._controller.stopRecording();this._performanceModel=e,this._setUIControlsEnabled(!0),this._controller.dispose(),this._controller=null}_recordingFailed(e){this._statusPane&&this._statusPane.hide(),this._statusPane=new Zt({description:e,buttonText:ls`Close`,buttonDisabled:!1},()=>this.loadingComplete(null)),this._statusPane.showPane(this._statusPaneContainer),this._statusPane.updateStatus(ls`Recording failed`),this._setState(Kt.RecordingFailed),this._performanceModel=null,this._setUIControlsEnabled(!0),this._controller.dispose(),this._controller=null}_onSuspendStateChanged(){this._updateTimelineControls()}_updateTimelineControls(){const e=Kt;this._toggleRecordAction.setToggled(this._state===e.Recording),this._toggleRecordAction.setEnabled(this._state===e.Recording||this._state===e.Idle),this._recordReloadAction.setEnabled(this._state===e.Idle),this._historyManager.setEnabled(this._state===e.Idle),this._clearButton.setEnabled(this._state===e.Idle),this._panelToolbar.setEnabled(this._state!==e.Loading),this._panelRightToolbar.setEnabled(this._state!==e.Loading),this._dropTarget.setEnabled(this._state===e.Idle),this._loadButton.setEnabled(this._state===e.Idle),this._saveButton.setEnabled(this._state===e.Idle&&!!this._performanceModel)}_toggleRecording(){this._state===Kt.Idle?(this._recordingPageReload=!1,this._startRecording(),ve.actionTaken(Te.Action.TimelineStarted)):this._state===Kt.Recording&&this._stopRecording()}_recordReload(){this._state===Kt.Idle&&(this._recordingPageReload=!0,this._startRecording(),ve.actionTaken(Te.Action.TimelinePageReloadStarted))}_onClearButton(){this._historyManager.clear(),this._clear()}_clear(){this._showLandingPage(),this._reset()}_reset(){self.runtime.sharedInstance(C.Performance).reset(),this._setModel(null)}_applyFilters(e){e.timelineModel().isGenericTrace()||Root.Runtime.experiments.isEnabled("timelineShowAllEvents")||e.setFilters([ii.visibleEventsFilter()])}_setModel(e){if(this._performanceModel&&this._performanceModel.removeEventListener(pi.WindowChanged,this._onModelWindowChanged,this),this._performanceModel=e,e?(this._searchableView.showWidget(),this._applyFilters(e)):this._searchableView.hideWidget(),this._flameChart.setModel(e),this._updateOverviewControls(),this._overviewPane.reset(),e){this._performanceModel.addEventListener(pi.WindowChanged,this._onModelWindowChanged,this),this._overviewPane.setNavStartTimes(e.timelineModel().navStartTimes()),this._overviewPane.setBounds(e.timelineModel().minimumRecordTime(),e.timelineModel().maximumRecordTime());const t=self.runtime.sharedInstance(C.Performance);t.reset();for(const i of e.timelineModel().cpuProfiles())t.appendCPUProfile(i);this._setMarkers(e.timelineModel()),this._flameChart.setSelection(null),this._overviewPane.setWindowTimes(e.window().left,e.window().right)}for(const t of this._overviewControls)t.setModel(e);this._flameChart&&this._flameChart.resizeToPreferredHeights(),this._updateTimelineControls()}_recordingStarted(){if(this._recordingPageReload){const e=this._controller.mainTarget().model(l.ResourceTreeModel);e&&e.reloadPage()}this._reset(),this._setState(Kt.Recording),this._showRecordingStarted(),this._statusPane.enableAndFocusButton(),this._statusPane.updateStatus(m.UIString("Profiling…")),this._statusPane.updateProgressBar(m.UIString("Buffer usage"),0),this._statusPane.startTimer(),this._hideLandingPage()}recordingProgress(e){this._statusPane.updateProgressBar(m.UIString("Buffer usage"),100*e)}_showLandingPage(){if(this._landingPage)return void this._landingPage.show(this._statusPaneContainer);function e(e,t){const i=createElement(e);return i.textContent=t,i}const t=se.XLink.create("https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/",m.UIString("Learn more")),i=e("b",ae.ShortcutRegistry.instance().shortcutsForAction("timeline.toggle-recording")[0].title()),n=e("b",ae.ShortcutRegistry.instance().shortcutsForAction("timeline.record-reload")[0].title()),s=e("b",m.UIString("WASD"));this._landingPage=new W.VBox,this._landingPage.contentElement.classList.add("timeline-landing-page","fill");const a=this._landingPage.contentElement.createChild("div"),r=B.createInlineButton(A.Toolbar.createActionButton(this._toggleRecordAction)),o=B.createInlineButton(A.Toolbar.createActionButtonForId("timeline.record-reload"));a.createChild("p").appendChild(B.formatLocalized("Click the record button %s or hit %s to start a new recording.\nClick the reload button %s or hit %s to record the page load.",[r,i,o,n])),a.createChild("p").appendChild(B.formatLocalized("After recording, select an area of interest in the overview by dragging.\nThen, zoom and pan the timeline with the mousewheel or %s keys.\n%s",[s,t])),this._landingPage.show(this._statusPaneContainer)}_hideLandingPage(){this._landingPage.detach()}loadingStarted(){this._hideLandingPage(),this._statusPane&&this._statusPane.hide(),this._statusPane=new Zt({showProgress:!0},this._cancelLoading.bind(this)),this._statusPane.showPane(this._statusPaneContainer),this._statusPane.updateStatus(m.UIString("Loading profile…")),this._loader||this._statusPane.finish(),this.loadingProgress(0)}loadingProgress(e){"number"==typeof e&&this._statusPane.updateProgressBar(m.UIString("Received"),100*e)}processingStarted(){this._statusPane.updateStatus(m.UIString("Processing profile…"))}loadingComplete(e){delete this._loader,this._setState(Kt.Idle),this._statusPane&&this._statusPane.hide(),delete this._statusPane,e?(this._performanceModel||(this._performanceModel=new ui),this._performanceModel.setTracingModel(e),this._setModel(this._performanceModel),this._historyManager.addRecording(this._performanceModel),this._startCoverage.get()&&ne.ViewManager.instance().showView("coverage").then(()=>ne.ViewManager.instance().view("coverage").widget()).then(e=>e.processBacklog()).then(()=>this._updateOverviewControls())):this._clear()}_showRecordingStarted(){this._statusPane||(this._statusPane=new Zt({showTimer:!0,showProgress:!0,buttonDisabled:!0},this._stopRecording.bind(this)),this._statusPane.showPane(this._statusPaneContainer),this._statusPane.updateStatus(m.UIString("Initializing profiler…")))}_cancelLoading(){this._loader&&this._loader.cancel()}_setMarkers(e){const t=new Map,i=I.RecordType,n=e.minimumRecordTime();for(const s of e.timeMarkerEvents())s.name!==i.TimeStamp&&s.name!==i.ConsoleTime&&t.set(s.startTime,ii.createEventDivider(s,n));for(const i of e.navStartTimes().values())t.set(i.startTime,ii.createEventDivider(i,n));this._overviewPane.setMarkers(t)}async _loadEventFired(e){if(this._state!==Kt.Recording||!this._recordingPageReload||this._controller.mainTarget()!==e.data.resourceTreeModel.target())return;const t=this._controller;await new Promise(e=>setTimeout(e,this._millisecondsToRecordAfterLoadEvent)),t===this._controller&&this._state===Kt.Recording&&this._stopRecording()}_frameForSelection(e){switch(e.type()){case Qt.Type.Frame:return e.object();case Qt.Type.Range:return null;case Qt.Type.TraceEvent:return this._performanceModel.frameModel().frames(e._endTime,e._endTime)[0];default:return console.assert(!1,"Should never be reached"),null}}_jumpToFrame(e){const t=this._selection&&this._frameForSelection(this._selection);if(!t)return;const i=this._performanceModel.frames();let n=i.indexOf(t);console.assert(n>=0,"Can't find current frame in the frame list"),n=M.clamp(n+e,0,i.length-1);const s=i[n];return this._revealTimeRange(s.startTime,s.endTime),this.select(Qt.fromFrame(s)),!0}select(e){this._selection=e,this._flameChart.setSelection(e)}selectEntryAtTime(e,i){if(e){for(let n=e.upperBound(i,(e,t)=>e-t.startTime)-1;n>=0;--n){const s=e[n],a=s.endTime||s.startTime;if(t.TracingModel.isTopLevelEvent(s)&&a<i)break;if(this._performanceModel.isVisible(s)&&a>=i)return void this.select(Qt.fromTraceEvent(s))}this.select(null)}}highlightEvent(e){this._flameChart.highlightEvent(e)}_revealTimeRange(e,t){const i=this._performanceModel.window();let n=0;i.right<t?n=t-i.right:i.left>e&&(n=e-i.left),this._performanceModel.setWindow({left:i.left+n,right:i.right+n},!0)}_handleDrop(e){const t=e.items;if(!t.length)return;const i=t[0];if("string"===i.kind){const t=e.getData("text/uri-list");new _.ParsedURL(t).isValid&&this._loadFromURL(t)}else if("file"===i.kind){const e=t[0].webkitGetAsEntry();if(!e.isFile)return;e.file(this._loadFromFile.bind(this))}}}const Kt={Idle:Symbol("Idle"),StartPending:Symbol("StartPending"),Recording:Symbol("Recording"),StopPending:Symbol("StopPending"),Loading:Symbol("Loading"),RecordingFailed:Symbol("RecordingFailed")},Yt={FlameChart:"FlameChart",BottomUp:"BottomUp",CallTree:"CallTree",EventLog:"EventLog"};class Qt{constructor(e,t,i,n){this._type=e,this._startTime=t,this._endTime=i,this._object=n||null}static fromFrame(e){return new Qt(Qt.Type.Frame,e.startTime,e.endTime,e)}static fromNetworkRequest(e){return new Qt(Qt.Type.NetworkRequest,e.startTime,e.endTime||e.startTime,e)}static fromTraceEvent(e){return new Qt(Qt.Type.TraceEvent,e.startTime,e.endTime||e.startTime+1,e)}static fromRange(e,t){return new Qt(Qt.Type.Range,e,t)}type(){return this._type}object(){return this._object}startTime(){return this._startTime}endTime(){return this._endTime}}Qt.Type={Frame:"Frame",NetworkRequest:"NetworkRequest",TraceEvent:"TraceEvent",Range:"Range"};class Zt extends W.VBox{constructor(e,t){super(!0),this.registerRequiredCSS("timeline/timelineStatusDialog.css"),this.contentElement.classList.add("timeline-status-dialog");const i=this.contentElement.createChild("div","status-dialog-line status");if(i.createChild("div","label").textContent=m.UIString("Status"),this._status=i.createChild("div","content"),G.markAsStatus(this._status),e.showTimer){const e=this.contentElement.createChild("div","status-dialog-line time");e.createChild("div","label").textContent=m.UIString("Time"),this._time=e.createChild("div","content")}if(e.showProgress){const e=this.contentElement.createChild("div","status-dialog-line progress");this._progressLabel=e.createChild("div","label"),this._progressBar=e.createChild("div","indicator-container").createChild("div","indicator"),G.markAsProgressBar(this._progressBar)}if("string"==typeof e.description){const t=this.contentElement.createChild("div","status-dialog-line description");t.createChild("div","label").textContent=ls`Description`,this._description=t.createChild("div","content"),this._description.innerText=e.description}const n=e.buttonText||ls`Stop`;this._button=B.createTextButton(n,t,"",!0),this._button.disabled=!1==!e.buttonDisabled,this.contentElement.createChild("div","stop-button").appendChild(this._button)}finish(){this._stopTimer(),this._button.disabled=!0}hide(){this.element.parentNode.classList.remove("tinted"),this.element.remove()}showPane(e){this.show(e),e.classList.add("tinted")}enableAndFocusButton(){this._button.disabled=!1,this._button.focus()}updateStatus(e){this._status.textContent=e}updateProgressBar(e,t){this._progressLabel.textContent=e,this._progressBar.style.width=t.toFixed(1)+"%",G.setValueNow(this._progressBar,t),this._updateTimer()}startTimer(){this._startTime=Date.now(),this._timeUpdateTimer=setInterval(this._updateTimer.bind(this,!1),1e3),this._updateTimer()}_stopTimer(){this._timeUpdateTimer&&(clearInterval(this._timeUpdateTimer),this._updateTimer(!0),delete this._timeUpdateTimer)}_updateTimer(e){if(!this._timeUpdateTimer)return;const t=(Date.now()-this._startTime)/1e3;this._time.textContent=m.UIString("%s sec",t.toFixed(e?1:0))}}const ei=Symbol("traceProviderSetting");var ti=Object.freeze({__proto__:null,TimelinePanel:Xt,State:Kt,ViewMode:Yt,rowHeight:18,headerHeight:20,TimelineSelection:Qt,TimelineModeViewDelegate:class{select(e){}selectEntryAtTime(e,t){}highlightEvent(e){}},StatusPane:Zt,LoadTimelineHandler:class{handleQueryParam(e){ne.ViewManager.instance().showView("timeline").then(()=>{Xt.instance()._loadFromURL(window.decodeURIComponent(e))})}},ActionDelegate:class{handleAction(e,t){const i=te.Context.instance().flavor(Xt);switch(console.assert(i&&i instanceof Xt),t){case"timeline.toggle-recording":return i._toggleRecording(),!0;case"timeline.record-reload":return i._recordReload(),!0;case"timeline.save-to-file":return i._saveToFile(),!0;case"timeline.load-from-file":return i._selectFileToLoad(),!0;case"timeline.jump-to-previous-frame":return i._jumpToFrame(-1),!0;case"timeline.jump-to-next-frame":return i._jumpToFrame(1),!0;case"timeline.show-history":return i._showHistory(),!0;case"timeline.previous-recording":return i._navigateHistory(1),!0;case"timeline.next-recording":return i._navigateHistory(-1),!0}return!1}},traceProviderSettingSymbol:ei});class ii{static _initEventStyles(){if(ii._eventStylesMap)return ii._eventStylesMap;const e=I.RecordType,t=ii.categories(),i=t.rendering,n=t.scripting,s=t.loading,a=t.experience,r=t.painting,o=t.other,l=t.idle,h={};return h[e.Task]=new ni(ls`Task`,o),h[e.Program]=new ni(ls`Other`,o),h[e.Animation]=new ni(ls`Animation`,i),h[e.EventDispatch]=new ni(ls`Event`,n),h[e.RequestMainThreadFrame]=new ni(ls`Request Main Thread Frame`,i,!0),h[e.BeginFrame]=new ni(ls`Frame Start`,i,!0),h[e.BeginMainThreadFrame]=new ni(ls`Frame Start (main thread)`,i,!0),h[e.DrawFrame]=new ni(ls`Draw Frame`,i,!0),h[e.HitTest]=new ni(ls`Hit Test`,i),h[e.ScheduleStyleRecalculation]=new ni(ls`Schedule Style Recalculation`,i),h[e.RecalculateStyles]=new ni(ls`Recalculate Style`,i),h[e.UpdateLayoutTree]=new ni(ls`Recalculate Style`,i),h[e.InvalidateLayout]=new ni(ls`Invalidate Layout`,i,!0),h[e.Layout]=new ni(ls`Layout`,i),h[e.PaintSetup]=new ni(ls`Paint Setup`,r),h[e.PaintImage]=new ni(ls`Paint Image`,r,!0),h[e.UpdateLayer]=new ni(ls`Update Layer`,r,!0),h[e.UpdateLayerTree]=new ni(ls`Update Layer Tree`,i),h[e.Paint]=new ni(ls`Paint`,r),h[e.RasterTask]=new ni(ls`Rasterize Paint`,r),h[e.ScrollLayer]=new ni(ls`Scroll`,i),h[e.CompositeLayers]=new ni(ls`Composite Layers`,r),h[e.ParseHTML]=new ni(ls`Parse HTML`,s),h[e.ParseAuthorStyleSheet]=new ni(ls`Parse Stylesheet`,s),h[e.TimerInstall]=new ni(ls`Install Timer`,n),h[e.TimerRemove]=new ni(ls`Remove Timer`,n),h[e.TimerFire]=new ni(ls`Timer Fired`,n),h[e.XHRReadyStateChange]=new ni(ls`XHR Ready State Change`,n),h[e.XHRLoad]=new ni(ls`XHR Load`,n),h[e.CompileScript]=new ni(ls`Compile Script`,n),h[e.EvaluateScript]=new ni(ls`Evaluate Script`,n),h[e.CompileModule]=new ni(ls`Compile Module`,n),h[e.EvaluateModule]=new ni(ls`Evaluate Module`,n),h[e.StreamingCompileScript]=new ni(ls`Streaming Compile Task`,o),h[e.StreamingCompileScriptWaiting]=new ni(ls`Waiting for Network`,l),h[e.StreamingCompileScriptParsing]=new ni(ls`Parse and Compile`,n),h[e.WasmStreamFromResponseCallback]=new ni(ls`Streaming Wasm Response`,n),h[e.WasmCompiledModule]=new ni(ls`Compiled Wasm Module`,n),h[e.WasmCachedModule]=new ni(ls`Cached Wasm Module`,n),h[e.WasmModuleCacheHit]=new ni(ls`Wasm Module Cache Hit`,n),h[e.WasmModuleCacheInvalid]=new ni(ls`Wasm Module Cache Invalid`,n),h[e.FrameStartedLoading]=new ni(ls`Frame Started Loading`,s,!0),h[e.MarkLoad]=new ni(ls`Onload Event`,n,!0),h[e.MarkDOMContent]=new ni(ls`DOMContentLoaded Event`,n,!0),h[e.MarkFirstPaint]=new ni(ls`First Paint`,r,!0),h[e.MarkFCP]=new ni(ls`First Contentful Paint`,i,!0),h[e.MarkLCPCandidate]=new ni(ls`Largest Contentful Paint`,i,!0),h[e.TimeStamp]=new ni(ls`Timestamp`,n),h[e.ConsoleTime]=new ni(ls`Console Time`,n),h[e.UserTiming]=new ni(ls`User Timing`,n),h[e.ResourceWillSendRequest]=new ni(ls`Will Send Request`,s),h[e.ResourceSendRequest]=new ni(ls`Send Request`,s),h[e.ResourceReceiveResponse]=new ni(ls`Receive Response`,s),h[e.ResourceFinish]=new ni(ls`Finish Loading`,s),h[e.ResourceReceivedData]=new ni(ls`Receive Data`,s),h[e.RunMicrotasks]=new ni(ls`Run Microtasks`,n),h[e.FunctionCall]=new ni(ls`Function Call`,n),h[e.GCEvent]=new ni(ls`GC Event`,n),h[e.MajorGC]=new ni(ls`Major GC`,n),h[e.MinorGC]=new ni(ls`Minor GC`,n),h[e.JSFrame]=new ni(ls`JS Frame`,n),h[e.RequestAnimationFrame]=new ni(ls`Request Animation Frame`,n),h[e.CancelAnimationFrame]=new ni(ls`Cancel Animation Frame`,n),h[e.FireAnimationFrame]=new ni(ls`Animation Frame Fired`,n),h[e.RequestIdleCallback]=new ni(ls`Request Idle Callback`,n),h[e.CancelIdleCallback]=new ni(ls`Cancel Idle Callback`,n),h[e.FireIdleCallback]=new ni(ls`Fire Idle Callback`,n),h[e.WebSocketCreate]=new ni(ls`Create WebSocket`,n),h[e.WebSocketSendHandshakeRequest]=new ni(ls`Send WebSocket Handshake`,n),h[e.WebSocketReceiveHandshakeResponse]=new ni(ls`Receive WebSocket Handshake`,n),h[e.WebSocketDestroy]=new ni(ls`Destroy WebSocket`,n),h[e.EmbedderCallback]=new ni(ls`Embedder Callback`,n),h[e.DecodeImage]=new ni(ls`Image Decode`,r),h[e.ResizeImage]=new ni(ls`Image Resize`,r),h[e.GPUTask]=new ni(ls`GPU`,t.gpu),h[e.LatencyInfo]=new ni(ls`Input Latency`,n),h[e.GCCollectGarbage]=new ni(ls`DOM GC`,n),h[e.CryptoDoEncrypt]=new ni(ls`Encrypt`,n),h[e.CryptoDoEncryptReply]=new ni(ls`Encrypt Reply`,n),h[e.CryptoDoDecrypt]=new ni(ls`Decrypt`,n),h[e.CryptoDoDecryptReply]=new ni(ls`Decrypt Reply`,n),h[e.CryptoDoDigest]=new ni(ls`Digest`,n),h[e.CryptoDoDigestReply]=new ni(ls`Digest Reply`,n),h[e.CryptoDoSign]=new ni(ls`Sign`,n),h[e.CryptoDoSignReply]=new ni(ls`Sign Reply`,n),h[e.CryptoDoVerify]=new ni(ls`Verify`,n),h[e.CryptoDoVerifyReply]=new ni(ls`Verify Reply`,n),h[e.AsyncTask]=new ni(ls`Async Task`,t.async),h[e.LayoutShift]=new ni(ls`Layout Shift`,a),ii._eventStylesMap=h,h}static setEventStylesMap(e){ii._eventStylesMap=e}static inputEventDisplayName(e){if(!ii._inputEventToDisplayName){const e=U.InputEvents;ii._inputEventToDisplayName=new Map([[e.Char,ls`Key Character`],[e.KeyDown,ls`Key Down`],[e.KeyDownRaw,ls`Key Down`],[e.KeyUp,ls`Key Up`],[e.Click,ls`Click`],[e.ContextMenu,ls`Context Menu`],[e.MouseDown,ls`Mouse Down`],[e.MouseMove,ls`Mouse Move`],[e.MouseUp,ls`Mouse Up`],[e.MouseWheel,ls`Mouse Wheel`],[e.ScrollBegin,ls`Scroll Begin`],[e.ScrollEnd,ls`Scroll End`],[e.ScrollUpdate,ls`Scroll Update`],[e.FlingStart,ls`Fling Start`],[e.FlingCancel,ls`Fling Halt`],[e.Tap,ls`Tap`],[e.TapCancel,ls`Tap Halt`],[e.ShowPress,ls`Tap Begin`],[e.TapDown,ls`Tap Down`],[e.TouchCancel,ls`Touch Cancel`],[e.TouchEnd,ls`Touch End`],[e.TouchMove,ls`Touch Move`],[e.TouchStart,ls`Touch Start`],[e.PinchBegin,ls`Pinch Begin`],[e.PinchEnd,ls`Pinch End`],[e.PinchUpdate,ls`Pinch Update`]])}return ii._inputEventToDisplayName.get(e)||null}static frameDisplayName(e){if(!L.TimelineJSProfileProcessor.isNativeRuntimeFrame(e))return B.beautifyFunctionName(e.functionName);const t=L.TimelineJSProfileProcessor.nativeGroup(e.functionName),i=L.TimelineJSProfileProcessor.NativeGroups;switch(t){case i.Compile:return ls`Compile`;case i.Parse:return ls`Parse`}return e.functionName}static testContentMatching(e,t){const i=[ii.eventStyle(e).title],n=I.TimelineData.forEvent(e).url;return n&&i.push(n),function e(t,n){if(!n)return;for(const s in t){const a=t[s],r=typeof a;"string"===r?i.push(a):"number"===r?i.push(String(a)):"object"===r&&e(a,n-1)}}(e.args,2),t.test(i.join("|"))}static eventURL(e){const t=e.args.data||e.args.beginData,i=t&&t.url;if(i)return i;const n=t&&t.stackTrace,s=n&&n.length&&n[0]||I.TimelineData.forEvent(e).topFrame();return s&&s.url||null}static eventStyle(e){const t=ii._initEventStyles();if(e.hasCategory(I.TimelineModelImpl.Category.Console)||e.hasCategory(I.TimelineModelImpl.Category.UserTiming))return new ni(e.name,ii.categories().scripting);if(e.hasCategory(I.TimelineModelImpl.Category.LatencyInfo)){const t="InputLatency::",i=e.name.startsWith(t)?e.name.substr(t.length):e.name,n=ii.inputEventDisplayName(i);return new ni(n||i,ii.categories().scripting)}let i=t[e.name];return i||(i=new ni(e.name,ii.categories().other,!0),t[e.name]=i),i}static eventColor(e){if(e.name===I.RecordType.JSFrame){const t=e.args.data;if(ii.isUserFrame(t))return ii.colorForId(t.url)}const t=ii.eventStyle(e).category.color;return e.name===I.RecordType.StreamingCompileScriptWaiting?f.Color.parse(ii.categories().scripting.color).setAlpha(.3).asString(null):t}static eventColorByProduct(e,t,i){const n=ii.eventURL(i)||"";let s=t.get(n);if(s)return s;const a=_.ParsedURL.fromString(n);if(!a)return"#f2ecdc";const r=a.host;return e.rootFrames().some(e=>new _.ParsedURL(e.url).host===r)&&(s="#f2ecdc"),s||(s="#f2ecdc"),t.set(n,s),s}static eventTitle(e){const t=I.RecordType,i=e.args.data;if(e.name===t.JSFrame)return ii.frameDisplayName(i);const n=ii.eventStyle(e).title;return e.hasCategory(I.TimelineModelImpl.Category.Console)?n:e.name===t.TimeStamp?ls`${n}: ${i.message}`:e.name===t.Animation&&i&&i.name?ls`${n}: ${i.name}`:e.name===t.EventDispatch&&i&&i.type?ls`${n}: ${i.type}`:n}static _interactionPhaseStyles(){let e=ii._interactionPhaseStylesMap;return e||(e=new Map([[U.Phases.Idle,{color:"white",label:"Idle"}],[U.Phases.Response,{color:"hsl(43, 83%, 64%)",label:ls`Response`}],[U.Phases.Scroll,{color:"hsl(256, 67%, 70%)",label:ls`Scroll`}],[U.Phases.Fling,{color:"hsl(256, 67%, 70%)",label:ls`Fling`}],[U.Phases.Drag,{color:"hsl(256, 67%, 70%)",label:ls`Drag`}],[U.Phases.Animation,{color:"hsl(256, 67%, 70%)",label:ls`Animation`}],[U.Phases.Uncategorized,{color:"hsl(0, 0%, 87%)",label:ls`Uncategorized`}]]),ii._interactionPhaseStylesMap=e),e}static interactionPhaseColor(e){return ii._interactionPhaseStyles().get(e).color}static interactionPhaseLabel(e){return ii._interactionPhaseStyles().get(e).label}static isUserFrame(e){return"0"!==e.scriptId&&!(e.url&&e.url.startsWith("native "))}static networkRequestCategory(e){const t=si;switch(e.mimeType){case"text/html":return t.HTML;case"application/javascript":case"application/x-javascript":case"text/javascript":return t.Script;case"text/css":return t.Style;case"audio/ogg":case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/webp":case"image/x-icon":case"font/opentype":case"font/woff2":case"application/font-woff":return t.Media;default:return t.Other}}static networkCategoryColor(e){const t=si;switch(e){case t.HTML:return"hsl(214, 67%, 66%)";case t.Script:return"hsl(43, 83%, 64%)";case t.Style:return"hsl(256, 67%, 70%)";case t.Media:return"hsl(109, 33%, 55%)";default:return"hsl(0, 0%, 70%)"}}static async buildDetailsTextForTraceEvent(e,t){const i=I.RecordType;let n;const s=e.args.data;switch(e.name){case i.GCEvent:case i.MajorGC:case i.MinorGC:{const t=e.args.usedHeapSizeBefore-e.args.usedHeapSizeAfter;n=m.UIString("%s collected",M.bytesToString(t));break}case i.FunctionCall:s&&(n=await a(s.scriptId,s.lineNumber,s.columnNumber));break;case i.JSFrame:n=ii.frameDisplayName(s);break;case i.EventDispatch:n=s?s.type:null;break;case i.Paint:{const e=ii.quadWidth(s.clip),t=ii.quadHeight(s.clip);e&&t&&(n=m.UIString("%d × %d",e,t));break}case i.ParseHTML:{const t=e.args.beginData.startLine,i=e.args.endData&&e.args.endData.endLine,s=de.displayNameForURL(e.args.beginData.url);n=i>=0?m.UIString("%s [%s…%s]",s,t+1,i+1):m.UIString("%s [%s…]",s,t+1);break}case i.CompileModule:n=de.displayNameForURL(e.args.fileName);break;case i.CompileScript:case i.EvaluateScript:{const e=s&&s.url;e&&(n=de.displayNameForURL(e)+":"+(s.lineNumber+1));break}case i.WasmCompiledModule:case i.WasmModuleCacheHit:{const t=e.args.url;t&&(n=de.displayNameForURL(t));break}case i.StreamingCompileScript:case i.XHRReadyStateChange:case i.XHRLoad:{const e=s.url;e&&(n=de.displayNameForURL(e));break}case i.TimeStamp:n=s.message;break;case i.WebSocketCreate:case i.WebSocketSendHandshakeRequest:case i.WebSocketReceiveHandshakeResponse:case i.WebSocketDestroy:case i.ResourceWillSendRequest:case i.ResourceSendRequest:case i.ResourceReceivedData:case i.ResourceReceiveResponse:case i.ResourceFinish:case i.PaintImage:case i.DecodeImage:case i.ResizeImage:case i.DecodeLazyPixelRef:{const t=I.TimelineData.forEvent(e).url;t&&(n=de.displayNameForURL(t));break}case i.EmbedderCallback:n=s.callbackName;break;case i.Animation:n=s&&s.name;break;case i.AsyncTask:n=s?s.name:null;break;default:n=e.hasCategory(I.TimelineModelImpl.Category.Console)?null:await async function(){const t=I.TimelineData.forEvent(e).topFrame();if(!t)return null;let i=await a(t.scriptId,t.lineNumber,t.columnNumber);i||(i=t.url,"number"==typeof t.lineNumber&&(i+=":"+(t.lineNumber+1)));return i}()}return n;async function a(e,i,n){const s=t?t.model(d.DebuggerModel):null;if(!t||t.isDisposed()||!e||!s)return null;const a=s.createRawLocationByScriptId(e,i,n);if(!a)return null;const r=await ce.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(a);return r?r.linkText():null}}static async buildDetailsNodeForTraceEvent(e,t,i){const n=I.RecordType;let s,a=null;const r=e.args.data;switch(e.name){case n.GCEvent:case n.MajorGC:case n.MinorGC:case n.EventDispatch:case n.Paint:case n.Animation:case n.EmbedderCallback:case n.ParseHTML:case n.WasmStreamFromResponseCallback:case n.WasmCompiledModule:case n.WasmModuleCacheHit:case n.WasmCachedModule:case n.WasmModuleCacheInvalid:case n.WebSocketCreate:case n.WebSocketSendHandshakeRequest:case n.WebSocketReceiveHandshakeResponse:case n.WebSocketDestroy:s=await ii.buildDetailsTextForTraceEvent(e,t);break;case n.PaintImage:case n.DecodeImage:case n.ResizeImage:case n.DecodeLazyPixelRef:case n.XHRReadyStateChange:case n.XHRLoad:case n.ResourceWillSendRequest:case n.ResourceSendRequest:case n.ResourceReceivedData:case n.ResourceReceiveResponse:case n.ResourceFinish:{const t=I.TimelineData.forEvent(e).url;t&&(a=me.Linkifier.linkifyURL(t,{tabStop:!0}));break}case n.FunctionCall:case n.JSFrame:{a=createElement("span"),a.createTextChild(ii.frameDisplayName(r));const e=o(r.scriptId,r.url,r.lineNumber,r.columnNumber);e&&(a.createTextChild(" @ "),a.appendChild(e));break}case n.CompileModule:a=o("",e.args.fileName,0,0);break;case n.CompileScript:case n.EvaluateScript:{const e=r.url;e&&(a=o("",e,r.lineNumber,0));break}case n.StreamingCompileScript:{const e=r.url;e&&(a=o("",e,0,0));break}default:e.hasCategory(I.TimelineModelImpl.Category.Console)?s=null:a=function(){const n=I.TimelineData.forEvent(e).topFrame();return n?i.maybeLinkifyConsoleCallFrame(t,n,{className:"timeline-details",tabStop:!0}):null}()}return!a&&s&&(a=createTextNode(s)),a;function o(e,n,s,a){const r={columnNumber:a,className:"timeline-details",tabStop:!0};return i.linkifyScriptLocation(t,e,n,s,r)}}static buildDetailsNodeForPerformanceEvent(e){let t="https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics#user-centric_performance_metrics",i="page performance metrics";const n=I.RecordType;switch(e.name){case n.MarkLCPCandidate:t="https://web.dev/largest-contentful-paint",i="largest contentful paint";break;case n.MarkFCP:t="https://web.dev/first-contentful-paint",i="first contentful paint"}return z.html`<div>${se.XLink.create(t,ls`Learn more`)} about ${i}.</div>`}static buildCompilationCacheDetails(e,t){"producedCacheSize"in e?(t.appendTextRow(ls`Compilation cache status`,ls`script saved to cache`),t.appendTextRow(ls`Compilation cache size`,M.bytesToString(e.producedCacheSize))):"consumedCacheSize"in e?(t.appendTextRow(ls`Compilation cache status`,ls`script loaded from cache`),t.appendTextRow(ls`Compilation cache size`,M.bytesToString(e.consumedCacheSize))):e&&e.cacheRejected?t.appendTextRow(ls`Compilation cache status`,ls`failed to load script from cache`):t.appendTextRow(ls`Compilation cache status`,ls`script not eligible`)}static async buildTraceEventDetails(e,i,n,s){const a=i.targetByEvent(e);let r=null;if(a){const t=a;if(void 0===e[oi]){let i=null;const n=I.TimelineData.forEvent(e).url;n?i=await ue.ImagePreview.build(t,n,!1,{imageAltText:ue.ImagePreview.defaultAltTextForImageURL(n)}):I.TimelineData.forEvent(e).picture&&(i=await ii.buildPicturePreviewContent(e,t)),e[oi]=i}const i=new Set,n=I.TimelineData.forEvent(e);n.backendNodeId&&i.add(n.backendNodeId);const s=I.InvalidationTracker.invalidationEventsFor(e);if(s&&ii._collectInvalidationNodeIds(i,s),i.size){const e=t.model(o.DOMModel);e&&(r=await e.pushNodesByBackendIdsToFrontend(i))}}const l=I.RecordType;let h;e.name===l.LayoutShift&&(s=!1);const d=new di(i.targetByEvent(e),n),c=i.isMarkerEvent(e)?ii.markerStyleForEvent(e).color:ii.eventStyle(e).category.color;d.addSection(ii.eventTitle(e),c);const m=e.args.data,u=I.TimelineData.forEvent(e),p=u.initiator();let _=null;if(u.warning&&d.appendWarningRow(e),e.name===l.JSFrame&&m.deoptReason&&d.appendWarningRow(e,I.TimelineModelImpl.WarningType.V8Deopt),s&&!Number.isNaN(e.duration+0)&&(d.appendTextRow(ls`Total Time`,Number.millisToString(e.duration,!0)),d.appendTextRow(ls`Self Time`,Number.millisToString(e.selfTime,!0))),i.isGenericTrace()){for(const t in e.args)try{d.appendTextRow(t,JSON.stringify(e.args[t]))}catch(i){d.appendTextRow(t,`<${typeof e.args[t]}>`)}return d.fragment}switch(e.name){case l.GCEvent:case l.MajorGC:case l.MinorGC:{const t=e.args.usedHeapSizeBefore-e.args.usedHeapSizeAfter;d.appendTextRow(ls`Collected`,M.bytesToString(t));break}case l.JSFrame:case l.FunctionCall:{const t=await ii.buildDetailsNodeForTraceEvent(e,i.targetByEvent(e),n);t&&d.appendElementRow(ls`Function`,t);break}case l.TimerFire:case l.TimerInstall:case l.TimerRemove:d.appendTextRow(ls`Timer ID`,m.timerId),e.name===l.TimerInstall&&(d.appendTextRow(ls`Timeout`,Number.millisToString(m.timeout)),d.appendTextRow(ls`Repeats`,!m.singleShot));break;case l.FireAnimationFrame:d.appendTextRow(ls`Callback ID`,m.id);break;case l.ResourceWillSendRequest:case l.ResourceSendRequest:case l.ResourceReceiveResponse:case l.ResourceReceivedData:case l.ResourceFinish:if(_=u.url,_&&d.appendElementRow(ls`Resource`,me.Linkifier.linkifyURL(_,{tabStop:!0})),m.requestMethod&&d.appendTextRow(ls`Request Method`,m.requestMethod),"number"==typeof m.statusCode&&d.appendTextRow(ls`Status Code`,m.statusCode),m.mimeType&&d.appendTextRow(ls`MIME Type`,m.mimeType),"priority"in m){const e=y.uiLabelForNetworkPriority(m.priority);d.appendTextRow(ls`Priority`,e)}m.encodedDataLength&&d.appendTextRow(ls`Encoded Data`,ls`${m.encodedDataLength} Bytes`),m.decodedBodyLength&&d.appendTextRow(ls`Decoded Body`,ls`${m.decodedBodyLength} Bytes`);break;case l.CompileModule:d.appendLocationRow(ls`Module`,e.args.fileName,0);break;case l.CompileScript:{_=m&&m.url,_&&d.appendLocationRow(ls`Script`,_,m.lineNumber,m.columnNumber);const e=m.streamed;d.appendTextRow(ls`Streamed`,e+(e?"":": "+m.notStreamedReason)),ii.buildCompilationCacheDetails(m,d);break}case l.EvaluateScript:_=m&&m.url,_&&d.appendLocationRow(ls`Script`,_,m.lineNumber,m.columnNumber);break;case l.WasmStreamFromResponseCallback:case l.WasmCompiledModule:case l.WasmCachedModule:case l.WasmModuleCacheHit:case l.WasmModuleCacheInvalid:if(m){_=e.args.url,_&&d.appendTextRow(ls`Url`,_);const t=e.args.producedCachedSize;t&&d.appendTextRow(ls`Produced Cache Size`,t);const i=e.args.consumedCachedSize;i&&d.appendTextRow(ls`Consumed Cache Size`,i)}break;case l.Paint:{const e=m.clip;d.appendTextRow(ls`Location`,ls`(${e[0]}, ${e[1]})`);const t=ii.quadWidth(e),i=ii.quadHeight(e);d.appendTextRow(ls`Dimensions`,ls`${t} × ${i}`)}case l.PaintSetup:case l.Rasterize:case l.ScrollLayer:h=ls`Layer Root`;break;case l.PaintImage:case l.DecodeLazyPixelRef:case l.DecodeImage:case l.ResizeImage:case l.DrawLazyPixelRef:h=ls`Owner Element`,_=u.url,_&&d.appendElementRow(ls`Image URL`,me.Linkifier.linkifyURL(_,{tabStop:!0}));break;case l.ParseAuthorStyleSheet:_=m.styleSheetUrl,_&&d.appendElementRow(ls`Stylesheet URL`,me.Linkifier.linkifyURL(_,{tabStop:!0}));break;case l.UpdateLayoutTree:case l.RecalculateStyles:d.appendTextRow(ls`Elements Affected`,e.args.elementCount);break;case l.Layout:{const t=e.args.beginData;d.appendTextRow(ls`Nodes That Need Layout`,ls`${t.dirtyObjects} of ${t.totalObjects}`),h=ls`Layout root`;break}case l.ConsoleTime:d.appendTextRow(ls`Message`,e.name);break;case l.WebSocketCreate:case l.WebSocketSendHandshakeRequest:case l.WebSocketReceiveHandshakeResponse:case l.WebSocketDestroy:{const e=p?p.args.data:m;void 0!==e.webSocketURL&&d.appendTextRow(ls`URL`,e.webSocketURL),void 0!==e.webSocketProtocol&&d.appendTextRow(ls`WebSocket Protocol`,e.webSocketProtocol),void 0!==m.message&&d.appendTextRow(ls`Message`,m.message);break}case l.EmbedderCallback:d.appendTextRow(ls`Callback Function`,m.callbackName);break;case l.Animation:e.phase===t.Phase.NestableAsyncInstant&&d.appendTextRow(ls`State`,m.state);break;case l.ParseHTML:{const t=e.args.beginData,i=t.startLine-1,n=e.args.endData?e.args.endData.endLine-1:void 0;_=t.url,_&&d.appendLocationRange(ls`Range`,_,i,n);break}case l.FireIdleCallback:d.appendTextRow(ls`Allotted Time`,Number.millisToString(m.allottedMilliseconds)),d.appendTextRow(ls`Invoked by Timeout`,m.timedOut);case l.RequestIdleCallback:case l.CancelIdleCallback:d.appendTextRow(ls`Callback ID`,m.id);break;case l.EventDispatch:d.appendTextRow(ls`Type`,m.type);break;case l.MarkLCPCandidate:d.appendTextRow(ls`Type`,String(m.type)),d.appendTextRow(ls`Size`,String(m.size));case l.MarkFirstPaint:case l.MarkFCP:case l.MarkLoad:case l.MarkDOMContent:{let t=e.startTime-i.minimumRecordTime();const{navigationId:n}=e.args.data;if(n){const s=i.navStartTimes().get(n);s&&(t=e.startTime-s.startTime)}d.appendTextRow(ls`Timestamp`,Number.preciseMillisToString(t,1)),d.appendElementRow(ls`Details`,ii.buildDetailsNodeForPerformanceEvent(e));break}case l.LayoutShift:{const e=createElement("span"),t=B.createWebDevLink("cls/",ls`Cumulative Layout Shifts`);e.appendChild(B.formatLocalized("%s can result in poor user experiences.",[t])),d.appendElementRow(ls`Warning`,e,!0),d.appendTextRow(ls`Score`,m.score.toPrecision(4)),d.appendTextRow(ls`Cumulative Score`,m.cumulative_score.toPrecision(4)),d.appendTextRow(ls`Had recent input`,m.had_recent_input?ls`Yes`:ls`No`);for(const e of m.impacted_nodes){const t=new De(e.old_rect),i=new De(e.new_rect),n=await T.Linkifier.linkify(t),s=await T.Linkifier.linkify(i);d.appendElementRow(ls`Moved from`,n),d.appendElementRow(ls`Moved to`,s)}break}default:{const t=await ii.buildDetailsNodeForTraceEvent(e,i.targetByEvent(e),n);t&&d.appendElementRow(ls`Details`,t);break}}u.timeWaitingForMainThread&&d.appendTextRow(ls`Time Waiting for Main Thread`,Number.millisToString(u.timeWaitingForMainThread,!0));const g=r&&r.get(u.backendNodeId);if(g){const e=await T.Linkifier.linkify(g);d.appendElementRow(h||ls`Related Node`,e)}e[oi]&&(d.addSection(ls`Preview`),d.appendElementRow("",e[oi])),(p||u.stackTraceForSelfOrInitiator()||I.InvalidationTracker.invalidationEventsFor(e))&&ii._generateCauses(e,i.targetByEvent(e),r,d);const f={};if(s&&ii._aggregatedStatsForTraceEvent(f,i,e)){d.addSection(ls`Aggregated Time`);const t=ii.generatePieChart(f,ii.eventStyle(e).category,e.selfTime);d.appendElementRow("",t)}return d.fragment}static statsForTimeRange(e,i,n){if(!e.length)return{idle:n-i};!function(e){if(e[ci])return;const i={},n=[];let s=0;function a(e,t){let n=i[e];if(n||(n={time:[],value:[]},i[e]=n),n.time.length&&n.time.peekLast()===t||s>t)return;const a=n.value.length?n.value.peekLast():0;n.value.push(a+t-s),n.time.push(t)}function r(e,t,i){e&&a(e,i),s=i,t&&a(t,i)}I.TimelineModelImpl.forEachEvent(e,(function(e){const t=ii.eventStyle(e).category.name,i=n.length?n.peekLast():null;t!==i&&r(i,t,e.startTime),n.push(t)}),(function(e){const t=n.pop(),i=n.length?n.peekLast():null;t!==i&&r(t,i,e.endTime)}),void 0,void 0,void 0,function(){const e=ii.visibleEventsFilter();return i=>e.accept(i)||t.TracingModel.isTopLevelEvent(i)}());e[ci]=i}(e);const s=function(e,t){const i=Object.assign({},e);for(const e in t)i[e]-=t[e];return i}(r(n),r(i)),a=Object.values(s).reduce((e,t)=>e+t,0);return s.idle=Math.max(0,n-i-a),s;function r(t){const i={},n=e[ci];for(const e in n){const s=n[e],a=s.time.upperBound(t);let r;if(0===a)r=0;else if(a===s.time.length)r=s.value.peekLast();else{const e=s.time[a-1],i=s.time[a],n=s.value[a-1];r=n+(s.value[a]-n)*(t-e)/(i-e)}i[e]=r}return i}}static async buildNetworkRequestDetails(e,t,i){const n=t.targetByEvent(e.children[0]),s=new di(n,i),a=ii.networkRequestCategory(e),r=ii.networkCategoryColor(a);s.addSection(ls`Network request`,r),e.url&&s.appendElementRow(ls`URL`,me.Linkifier.linkifyURL(e.url));const o=e.endTime-(e.getStartTime()||-1/0);if(isFinite(o)){let t=Number.millisToString(o,!0);const i=e.finishTime-e.getStartTime(),n=e.endTime-e.finishTime;if(isFinite(i)&&isFinite(n)){const s=Number.millisToString(i,!0),a=Number.millisToString(n,!0),r=e.cached()?ls`load from cache`:ls`network transfer`;t+=ls` (${s} ${r} + ${a} resource loading)`}s.appendTextRow(ls`Duration`,t)}if(e.requestMethod&&s.appendTextRow(ls`Request Method`,e.requestMethod),"string"==typeof e.priority){const t=y.uiLabelForNetworkPriority(e.priority);s.appendTextRow(ls`Priority`,t)}e.mimeType&&s.appendTextRow(ls`Mime Type`,e.mimeType);let l="";e.memoryCached()?l+=ls` (from memory cache)`:e.cached()?l+=ls` (from cache)`:e.timing&&e.timing.pushStart&&(l+=ls` (from push)`),e.fromServiceWorker&&(l+=ls` (from service worker)`),!e.encodedDataLength&&l||(l=`${M.bytesToString(e.encodedDataLength)}${l}`),s.appendTextRow(ls`Encoded Data`,l),e.decodedBodyLength&&s.appendTextRow(ls`Decoded Body`,M.bytesToString(e.decodedBodyLength));const h=ls`Initiator`,d=e.children[0],c=I.TimelineData.forEvent(d).topFrame();if(c){const e=i.maybeLinkifyConsoleCallFrame(n,c,{tabStop:!0});e&&s.appendElementRow(h,e)}else{const e=I.TimelineData.forEvent(d).initiator();if(e){const t=I.TimelineData.forEvent(e).url;if(t){const e=i.maybeLinkifyScriptLocation(n,null,t,0,{tabStop:!0});e&&s.appendElementRow(h,e)}}}return!e.previewElement&&e.url&&n&&(e.previewElement=await ue.ImagePreview.build(n,e.url,!1,{imageAltText:ue.ImagePreview.defaultAltTextForImageURL(e.url)})),e.previewElement&&s.appendElementRow(ls`Preview`,e.previewElement),s.fragment}static _stackTraceFromCallFrames(e){return{callFrames:e}}static _generateCauses(e,t,i,n){const s=I.RecordType;let a,r;switch(e.name){case s.TimerFire:a=ls`Timer Installed`;break;case s.FireAnimationFrame:a=ls`Animation Frame Requested`;break;case s.FireIdleCallback:a=ls`Idle Callback Requested`;break;case s.UpdateLayoutTree:case s.RecalculateStyles:r=ls`Recalculation Forced`;break;case s.Layout:a=ls`First Layout Invalidation`,r=ls`Layout Forced`}const o=I.TimelineData.forEvent(e);o.stackTrace&&o.stackTrace.length&&(n.addSection(ls`Call Stacks`),n.appendStackTrace(r||ls`Stack Trace`,ii._stackTraceFromCallFrames(o.stackTrace)));const l=I.TimelineData.forEvent(e).initiator();if(I.InvalidationTracker.invalidationEventsFor(e)&&t)n.addSection(ls`Invalidations`),ii._generateInvalidations(e,t,i,n);else if(l){const t=e.startTime-l.startTime;n.appendTextRow(ls`Pending for`,Number.preciseMillisToString(t,1));const i=document.createElement("span");i.classList.add("devtools-link"),G.markAsLink(i),i.tabIndex=0,i.textContent=ls`Reveal`,i.addEventListener("click",()=>{Xt.instance().select(Qt.fromTraceEvent(l))}),i.addEventListener("keydown",e=>{isEnterKey(e)&&(Xt.instance().select(Qt.fromTraceEvent(l)),e.consume(!0))}),n.appendElementRow(ls`Initiator`,i);const s=I.TimelineData.forEvent(l).stackTrace;s&&n.appendStackTrace(a||ls`First Invalidated`,ii._stackTraceFromCallFrames(s))}}static _generateInvalidations(e,t,i,n){const s=I.InvalidationTracker.invalidationEventsFor(e),a={};s.forEach((function(e){a[e.type]?a[e.type].push(e):a[e.type]=[e]})),Object.keys(a).forEach((function(e){ii._generateInvalidationsForType(e,t,a[e],i,n)}))}static _generateInvalidationsForType(e,t,i,n,s){let a;switch(e){case I.RecordType.StyleRecalcInvalidationTracking:a=ls`Style Invalidations`;break;case I.RecordType.LayoutInvalidationTracking:a=ls`Layout Invalidations`;break;default:a=ls`Other Invalidations`}const r=new re.TreeOutlineInShadow;r.registerRequiredCSS("timeline/invalidationsTree.css"),r.element.classList.add("invalidations-tree");(function(e){const t=new Map;for(let i=0;i<e.length;i++){const n=e[i];let s="";n.cause.reason&&(s+=n.cause.reason+"."),n.cause.stackTrace&&n.cause.stackTrace.forEach((function(e){s+=e.functionName+".",s+=e.scriptId+".",s+=e.url+".",s+=e.lineNumber+".",s+=e.columnNumber+"."})),t.has(s)?t.get(s).push(n):t.set(s,[n])}return[...t.values()]})(i).forEach((function(e){const i=new ri(t,n,s,e);r.appendChild(i)})),s.appendElementRow(a,r.element,!1,!0)}static _collectInvalidationNodeIds(e,t){P.addAll(e,t.map(e=>e.nodeId).filter(e=>e))}static _aggregatedStatsForTraceEvent(e,i,n){const s=i.inspectedTargetEvents();const a=s.binaryIndexOf(n.startTime,(function(e,t){return e-t.startTime}));if(a<0)return!1;let r=!1;const o=n.endTime;if(o)for(let t=a;t<s.length;t++){const i=s[t];if(i.startTime>=o)break;if(!i.selfTime)continue;if(i.thread!==n.thread)continue;t>a&&(r=!0);const l=ii.eventStyle(i).category.name;e[l]=(e[l]||0)+i.selfTime}if(t.TracingModel.isAsyncPhase(n.phase)){if(n.endTime){let t=0;for(const i in e)t+=e[i];e.idle=Math.max(0,n.endTime-n.startTime-t)}return!1}return r}static async buildPicturePreviewContent(e,t){const i=await new N.LayerPaintEvent(e,t).snapshotPromise();if(!i)return null;const n=i.snapshot.replay();i.snapshot.release();const s=await n;if(!s)return null;const a=createElement("div");j.appendStyle(a,"components/imagePreview.css"),a.classList.add("image-preview-container","vbox","link");const r=a.createChild("img");r.src=s,r.alt=ue.ImagePreview.defaultAltTextForImageURL(s);return a.createChild("a").textContent=ls`Paint Profiler`,G.markAsLink(a),a.tabIndex=0,a.addEventListener("click",()=>Xt.instance().select(Qt.fromTraceEvent(e)),!1),a.addEventListener("keydown",t=>{isEnterKey(t)&&(Xt.instance().select(Qt.fromTraceEvent(e)),t.consume(!0))}),a}static createEventDivider(e,t){const i=document.createElement("div");i.classList.add("resources-event-divider");const n=Number.millisToString(e.startTime-t);i.title=m.UIString("%s at %s",ii.eventTitle(e),n);const s=ii.markerStyleForEvent(e);return s.tall&&(i.style.backgroundColor=s.color),i}static _visibleTypes(){const e=ii._initEventStyles(),t=[];for(const i in e)e[i].hidden||t.push(i);return t}static visibleEventsFilter(){return new F.TimelineVisibleEventsFilter(ii._visibleTypes())}static categories(){return ii._categories||(ii._categories={loading:new hi("loading",ls`Loading`,!0,"hsl(214, 67%, 74%)","hsl(214, 67%, 66%)"),experience:new hi("experience",ls`Experience`,!1,"hsl(5, 80%, 74%)","hsl(5, 80%, 66%)"),scripting:new hi("scripting",ls`Scripting`,!0,"hsl(43, 83%, 72%)","hsl(43, 83%, 64%) "),rendering:new hi("rendering",ls`Rendering`,!0,"hsl(256, 67%, 76%)","hsl(256, 67%, 70%)"),painting:new hi("painting",ls`Painting`,!0,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),gpu:new hi("gpu",ls`GPU`,!1,"hsl(109, 33%, 64%)","hsl(109, 33%, 55%)"),async:new hi("async",ls`Async`,!1,"hsl(0, 100%, 50%)","hsl(0, 100%, 40%)"),other:new hi("other",ls`System`,!1,"hsl(0, 0%, 87%)","hsl(0, 0%, 79%)"),idle:new hi("idle",ls`Idle`,!1,"hsl(0, 0%, 98%)","hsl(0, 0%, 98%)")}),ii._categories}static setCategories(e){ii._categories=e}static getTimelineMainEventCategories(){return ii._eventCategories||(ii._eventCategories=["idle","loading","painting","rendering","scripting","other"]),ii._eventCategories}static setTimelineMainEventCategories(e){ii._eventCategories=e}static generatePieChart(e,t,i){let n=0;for(const t in e)n+=e[t];const s=document.createElement("div");s.classList.add("timeline-details-view-pie-chart-wrapper"),s.classList.add("hbox");const a=b.createPieChart(),r=[];function o(e,t,i,n){i&&r.push({value:i,color:n,title:t})}if(t){i&&o(t.name,m.UIString("%s (self)",t.title),i,t.color);const n=e[t.name]-i;n>0&&o(t.name,m.UIString("%s (children)",t.title),n,t.childColor)}for(const i in ii.categories()){const n=ii.categories()[i];n!==t&&o(n.name,n.title,e[n.name],n.childColor)}a.data={chartName:ls`Time spent in rendering`,size:110,formatter:e=>Number.preciseMillisToString(e),showLegend:!0,total:n,slices:r};return s.createChild("div","vbox").appendChild(a),s}static generateDetailsContentForFrame(e,t){const i=new di(null,null);i.addSection(ls`Frame`);const n=ii.frameDuration(e);i.appendElementRow(ls`Duration`,n,e.hasWarnings());const s=e.endTime-e.startTime;if(i.appendTextRow(ls`FPS`,Math.floor(1e3/s)),i.appendTextRow(ls`CPU time`,Number.millisToString(e.cpuTime,!0)),t){const e=document.createElement("div");e.classList.add("timeline-filmstrip-preview"),t.imageDataPromise().then(e=>B.loadImageFromData(e)).then(t=>t&&e.appendChild(t)),i.appendElementRow("",e),e.addEventListener("click",function(e){new k.Dialog(e,0)}.bind(null,t),!1)}return e.layerTree&&i.appendElementRow(ls`Layer tree`,me.Linkifier.linkifyRevealable(e.layerTree,ls`Show`)),i.fragment}static frameDuration(e){const t=m.UIString("%s (at %s)",Number.millisToString(e.endTime-e.startTime,!0),Number.millisToString(e.startTimeOffset,!0));if(!e.hasWarnings())return B.formatLocalized("%s",[t]);const i=se.XLink.create("https://developers.google.com/web/fundamentals/performance/rendering/",ls`jank`);return B.formatLocalized("%s. Long frame times are an indication of %s",[t,i])}static createFillStyle(e,t,i,n,s,a){const r=e.createLinearGradient(0,0,t,i);return r.addColorStop(0,n),r.addColorStop(.25,s),r.addColorStop(.75,s),r.addColorStop(1,a),r}static quadWidth(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[2],2)+Math.pow(e[1]-e[3],2)))}static quadHeight(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[6],2)+Math.pow(e[1]-e[7],2)))}static eventDispatchDesciptors(){if(ii._eventDispatchDesciptors)return ii._eventDispatchDesciptors;const e="hsl(40,100%,50%)";return ii._eventDispatchDesciptors=[new li(1,"hsl(40,100%,80%)",["mousemove","mouseenter","mouseleave","mouseout","mouseover"]),new li(1,"hsl(40,100%,80%)",["pointerover","pointerout","pointerenter","pointerleave","pointermove"]),new li(2,"hsl(90,100%,40%)",["wheel"]),new li(3,e,["click","mousedown","mouseup"]),new li(3,e,["touchstart","touchend","touchmove","touchcancel"]),new li(3,e,["pointerdown","pointerup","pointercancel","gotpointercapture","lostpointercapture"]),new li(3,"hsl(256,100%,75%)",["keydown","keyup","keypress"])],ii._eventDispatchDesciptors}static markerShortTitle(e){const t=I.RecordType;switch(e.name){case t.MarkDOMContent:return ls`DCL`;case t.MarkLoad:return ls`L`;case t.MarkFirstPaint:return ls`FP`;case t.MarkFCP:return ls`FCP`;case t.MarkLCPCandidate:return ls`LCP`}return null}static markerStyleForEvent(e){const t=[6,4],i=ii.eventTitle(e),n=I.RecordType;if(e.name!==n.NavigationStart&&(e.hasCategory(I.TimelineModelImpl.Category.Console)||e.hasCategory(I.TimelineModelImpl.Category.UserTiming)))return{title:i,dashStyle:t,lineWidth:.5,color:e.hasCategory(I.TimelineModelImpl.Category.UserTiming)?"purple":"orange",tall:!1,lowPriority:!1};let s=!1,a="grey";switch(e.name){case n.NavigationStart:a="#FF9800",s=!0;break;case n.FrameStartedLoading:a="green",s=!0;break;case n.MarkDOMContent:a="#0867CB",s=!0;break;case n.MarkLoad:a="#B31412",s=!0;break;case n.MarkFirstPaint:a="#228847",s=!0;break;case n.MarkFCP:a="#1A6937",s=!0;break;case n.MarkLCPCandidate:a="#1A3422",s=!0;break;case n.TimeStamp:a="orange"}return{title:i,dashStyle:t,lineWidth:.5,color:a,tall:s,lowPriority:!1}}static markerStyleForFrame(){return{title:ls`Frame`,color:"rgba(100, 100, 100, 0.4)",lineWidth:3,dashStyle:[3],tall:!0,lowPriority:!0}}static colorForId(e){return ii.colorForId._colorGenerator||(ii.colorForId._colorGenerator=new f.Generator({min:30,max:330},{min:50,max:80,count:3},85),ii.colorForId._colorGenerator.setColorForID("","#f2ecdc")),ii.colorForId._colorGenerator.colorForID(e)}static eventWarning(e,t){const i=I.TimelineData.forEvent(e),n=t||i.warning;if(!n)return null;const s=I.TimelineModelImpl.WarningType,a=createElement("span"),r=e.args.data;switch(n){case s.ForcedStyle:case s.ForcedLayout:{const e=B.createDocumentationLink("../../fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing#avoid-forced-synchronous-layouts",ls`Forced reflow`);a.appendChild(B.formatLocalized("%s is a likely performance bottleneck.",[e]));break}case s.IdleDeadlineExceeded:{const t=Number.millisToString(e.duration-r.allottedMilliseconds,!0);a.textContent=ls`Idle callback execution extended beyond deadline by ${t}`;break}case s.LongHandler:a.textContent=m.UIString("Handler took %s",Number.millisToString(e.duration,!0));break;case s.LongRecurringHandler:a.textContent=m.UIString("Recurring handler took %s",Number.millisToString(e.duration,!0));break;case s.LongTask:{const t=B.createDocumentationLink("../../fundamentals/performance/rail#goals-and-guidelines",ls`Long task`);a.appendChild(B.formatLocalized("%s took %s.",[t,Number.millisToString(e.duration,!0)]));break}case s.V8Deopt:a.appendChild(se.XLink.create("https://github.com/GoogleChrome/devtools-docs/issues/53",m.UIString("Not optimized"))),a.createTextChild(m.UIString(": %s",r.deoptReason));break;default:console.assert(!1,"Unhandled TimelineModel.WarningType")}return a}static displayNameForFrame(e,t){return t||(t=30),e.url.startsWith("about:")?`"${e.name.trimMiddle(t)}"`:e.url.trimEnd(t)}}class ni{constructor(e,t,i=!1){this.title=e,this.category=t,this.hidden=i}}const si={HTML:Symbol("HTML"),Script:Symbol("Script"),Style:Symbol("Style"),Media:Symbol("Media"),Other:Symbol("Other")},ai=Symbol("aggregatedStats");class ri extends re.TreeElement{constructor(e,t,i,n){super("",!0),this.listItemElement.classList.add("header"),this.selectable=!1,this.toggleOnClick=!0,this._relatedNodesMap=t,this._contentHelper=i,this._invalidations=n,this.title=this._createTitle(e)}_createTitle(e){const t=this._invalidations[0],i=t.cause.reason||ls`Unknown cause`,n=t.cause.stackTrace&&t.cause.stackTrace[0],s=this._getTruncatedNodesElement(this._invalidations);if(null===s)return B.formatLocalized(i,[]);const a=B.formatLocalized("%s for %s",[i,s]);if(n&&this._contentHelper.linkifier()){const t=document.createElement("span");t.classList.add("monospace");const i=B.formatLocalized("%s. %s",[a,t]);t.createChild("span").textContent=ii.frameDisplayName(n);const s=this._contentHelper.linkifier().maybeLinkifyConsoleCallFrame(e,n);return s&&(t.createChild("span").textContent=" @ ",t.createChild("span").appendChild(s)),i}return a}async onpopulate(){const e=document.createElement("div");e.classList.add("content");const t=this._invalidations[0];if(t.cause.stackTrace){const i=e.createChild("div");i.createTextChild(ls`Stack trace:`),this._contentHelper.createChildStackTraceElement(i,ii._stackTraceFromCallFrames(t.cause.stackTrace))}e.createTextChild(1!==this._invalidations.length?ls`Nodes:`:ls`Node:`);const i=e.createChild("div","node-list");let n=!0;for(let e=0;e<this._invalidations.length;e++){const t=this._invalidations[e],s=this._createInvalidationNode(t,!0);if(s){n||i.createTextChild(ls`, `),n=!1,i.appendChild(s);const e=t.extraData?", "+t.extraData:"";t.changedId?i.createTextChild(m.UIString('(changed id to "%s"%s)',t.changedId,e)):t.changedClass?i.createTextChild(m.UIString('(changed class to "%s"%s)',t.changedClass,e)):t.changedAttribute?i.createTextChild(m.UIString('(changed attribute to "%s"%s)',t.changedAttribute,e)):t.changedPseudo?i.createTextChild(m.UIString('(changed pesudo to "%s"%s)',t.changedPseudo,e)):t.selectorPart&&i.createTextChild(m.UIString('(changed "%s"%s)',t.selectorPart,e))}}const s=new re.TreeElement(e,!1);s.selectable=!1,this.appendChild(s)}_getTruncatedNodesElement(e){const t=[],i={};for(let n=0;n<e.length;n++){const s=e[n],a=this._createInvalidationNode(s,!1);a.addEventListener("click",e=>e.consume(),!1),a&&!i[s.nodeId]&&(t.push(a),i[s.nodeId]=!0)}return 1===t.length?t[0]:2===t.length?B.formatLocalized("%s and %s",t):3===t.length?B.formatLocalized("%s, %s, and 1 other",t.slice(0,2)):t.length>=4?B.formatLocalized("%s, %s, and %s others",[...t.slice(0,2),(t.length-2).toString()]):null}_createInvalidationNode(e,t){const i=e.nodeId&&this._relatedNodesMap?this._relatedNodesMap.get(e.nodeId):null;if(i){const e=createElement("span");return T.Linkifier.linkify(i).then(t=>e.appendChild(t)),e}if(e.nodeName){const t=createElement("span");return t.textContent=m.UIString("[ %s ]",e.nodeName),t}if(t){return createElement("span").createTextChild(m.UIString("[ unknown node ]"))}}}const oi=Symbol("previewElement");class li{constructor(e,t,i){this.priority=e,this.color=t,this.eventTypes=i}}class hi extends g.ObjectWrapper{constructor(e,t,i,n,s){super(),this.name=e,this.title=t,this.visible=i,this.childColor=n,this.color=s,this.hidden=!1}get hidden(){return this._hidden}set hidden(e){this._hidden=e,this.dispatchEventToListeners(hi.Events.VisibilityChanged,this)}}hi.Events={VisibilityChanged:Symbol("VisibilityChanged")};class di{constructor(e,t){this.fragment=createDocumentFragment(),this._linkifier=t,this._target=e,this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this._tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}addSection(e,t){if(this._tableElement.hasChildNodes()?(this.element=document.createElement("div"),this.element.classList.add("timeline-details-view-block"),this.fragment.appendChild(this.element)):this.element.removeChildren(),e){const i=this.element.createChild("div","timeline-details-chip-title");t&&(i.createChild("div").style.backgroundColor=t),i.createTextChild(e)}this._tableElement=this.element.createChild("div","vbox timeline-details-chip-body"),this.fragment.appendChild(this.element)}linkifier(){return this._linkifier}appendTextRow(e,t){const i=this._tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,i.createChild("div","timeline-details-view-row-value").textContent=t}appendElementRow(e,t,i,n){const s=this._tableElement.createChild("div","timeline-details-view-row");i&&s.classList.add("timeline-details-warning"),n&&s.classList.add("timeline-details-stack-values");s.createChild("div","timeline-details-view-row-title").textContent=e;const a=s.createChild("div","timeline-details-view-row-value");t instanceof Node?a.appendChild(t):a.createTextChild(t||"")}appendLocationRow(e,t,i,n){if(!this._linkifier||!this._target)return;const s=this._linkifier.maybeLinkifyScriptLocation(this._target,null,t,i,{columnNumber:n,tabStop:!0});s&&this.appendElementRow(e,s)}appendLocationRange(e,t,i,n){if(!this._linkifier||!this._target)return;const s=createElement("span"),a=this._linkifier.maybeLinkifyScriptLocation(this._target,null,t,i,{tabStop:!0});a&&(s.appendChild(a),s.createTextChild(x.sprintf(" [%s…%s]",i+1,n+1||"")),this.appendElementRow(e,s))}appendStackTrace(e,t){if(!this._linkifier||!this._target)return;const i=this._tableElement.createChild("div","timeline-details-view-row");i.createChild("div","timeline-details-view-row-title").textContent=e,this.createChildStackTraceElement(i,t)}createChildStackTraceElement(e,t){if(!this._linkifier||!this._target)return;e.classList.add("timeline-details-stack-values");const i=e.createChild("div","timeline-details-view-row-value timeline-details-view-row-stack-trace"),n=pe.buildStackTracePreviewContents(this._target,this._linkifier,{stackTrace:t,tabStops:!0});i.appendChild(n.element)}appendWarningRow(e,t){const i=ii.eventWarning(e,t);i&&this.appendElementRow(ls`Warning`,i,!0)}}const ci=Symbol("categoryBreakdownCache");var mi=Object.freeze({__proto__:null,TimelineUIUtils:ii,TimelineRecordStyle:ni,NetworkCategory:si,aggregatedStatsKey:ai,InvalidationsGroupElement:ri,previewElementSymbol:oi,EventDispatchTypeDescriptor:li,TimelineCategory:hi,TimelinePopupContentHelper:class{constructor(e){this._contentTable=createElement("table");const t=this._createCell(m.UIString("%s - Details",e),"timeline-details-title");t.colSpan=2;const i=createElement("tr");i.appendChild(t),this._contentTable.appendChild(i)}contentTable(){return this._contentTable}_createCell(e,t){createElement("label").createTextChild(String(e));const i=createElement("td");return i.className="timeline-details",t&&(i.className+=" "+t),i.textContent=e,i}appendTextRow(e,t){const i=createElement("tr");i.appendChild(this._createCell(e,"timeline-details-row-title")),i.appendChild(this._createCell(t,"timeline-details-row-data")),this._contentTable.appendChild(i)}appendElementRow(e,t){const i=createElement("tr"),n=this._createCell(e,"timeline-details-row-title");i.appendChild(n);const s=createElement("td");s.className="details",t instanceof Node?s.appendChild(t):s.createTextChild(t||""),i.appendChild(s),this._contentTable.appendChild(i)}},TimelineDetailsContentHelper:di,categoryBreakdownCacheSymbol:ci,TimelineMarkerStyle:void 0});class ui extends g.ObjectWrapper{constructor(){super(),this._mainTarget=null,this._tracingModel=null,this._filters=[],this._timelineModel=new I.TimelineModelImpl,this._frameModel=new N.TimelineFrameModel(e=>ii.eventStyle(e).category.name),this._filmStripModel=null,this._irModel=new U.TimelineIRModel,this._window={left:0,right:1/0},this._extensionTracingModels=[],this._recordStartTime=void 0}setMainTarget(e){this._mainTarget=e}mainTarget(){return this._mainTarget}setRecordStartTime(e){this._recordStartTime=e}recordStartTime(){return this._recordStartTime}setFilters(e){this._filters=e}filters(){return this._filters}isVisible(e){return this._filters.every(t=>t.accept(e))}setTracingModel(e){this._tracingModel=e,this._timelineModel.setEvents(e);let t=null,i=null;for(const e of this._timelineModel.tracks())e.type===I.TrackType.Input&&(t=e.asyncEvents),e.type===I.TrackType.Animation&&(i=e.asyncEvents);(t||i)&&this._irModel.populate(t||[],i||[]);const n=this._timelineModel.tracks().filter(e=>e.type===I.TrackType.MainThread&&e.forMainFrame&&e.events.length).map(e=>{const t=e.events[0];return{thread:t.thread,time:t.startTime}});this._frameModel.addTraceEvents(this._mainTarget,this._timelineModel.inspectedTargetEvents(),n);for(const e of this._extensionTracingModels)e.model.adjustTime(this._tracingModel.minimumRecordTime()+e.timeOffset/1e3-this._recordStartTime);this._autoWindowTimes()}addExtensionEvents(e,t,i){this._extensionTracingModels.push({model:t,title:e,timeOffset:i}),this._tracingModel&&(t.adjustTime(this._tracingModel.minimumRecordTime()+i/1e3-this._recordStartTime),this.dispatchEventToListeners(pi.ExtensionDataAdded))}tracingModel(){if(!this._tracingModel)throw"call setTracingModel before accessing PerformanceModel";return this._tracingModel}timelineModel(){return this._timelineModel}filmStripModel(){if(this._filmStripModel)return this._filmStripModel;if(!this._tracingModel)throw"call setTracingModel before accessing PerformanceModel";return this._filmStripModel=new c.FilmStripModel(this._tracingModel),this._filmStripModel}frames(){return this._frameModel.frames()}frameModel(){return this._frameModel}interactionRecords(){return this._irModel.interactionRecords()}extensionInfo(){return this._extensionTracingModels}dispose(){this._tracingModel&&this._tracingModel.dispose();for(const e of this._extensionTracingModels)e.model.dispose()}filmStripModelFrame(e){const t=e.idle?e.startTime:e.endTime,i=this._filmStripModel.frameByTimestamp(t);return i&&i.timestamp-e.endTime<10?i:null}save(e){return this._tracingModel.backingStorage().writeToStream(e)}setWindow(e,t){this._window=e,this.dispatchEventToListeners(pi.WindowChanged,{window:e,animate:t})}window(){return this._window}_autoWindowTimes(){const e=this._timelineModel;let t=[];for(const i of e.tracks())i.type===I.TrackType.MainThread&&i.forMainFrame&&(t=i.tasks);if(!t.length)return void this.setWindow({left:e.minimumRecordTime(),right:e.maximumRecordTime()});function i(e,i){let n=e,s=(t[n].startTime+t[n].endTime)/2,a=0;const r=Math.sign(i-e);for(let o=e;o!==i;o+=r){const e=t[o],i=(e.startTime+e.endTime)/2;a<.1*Math.abs(s-i)&&(n=o,s=i,a=0),a+=e.duration}return n}const n=i(t.length-1,0),s=i(0,n);let a=t[s].startTime,r=t[n].endTime;const o=r-a;o<.1*(e.maximumRecordTime()-e.minimumRecordTime())?(a=e.minimumRecordTime(),r=e.maximumRecordTime()):(a=Math.max(a-.05*o,e.minimumRecordTime()),r=Math.min(r+.05*o,e.maximumRecordTime())),this.setWindow({left:a,right:r})}}const pi={ExtensionDataAdded:Symbol("ExtensionDataAdded"),WindowChanged:Symbol("WindowChanged")};var _i=Object.freeze({__proto__:null,PerformanceModel:ui,Events:pi,Window:void 0});class gi extends W.VBox{constructor(e){super(),this.element.id="memory-graphs-container",this._delegate=e,this._calculator=new Ti,this._header=new W.HBox,this._header.element.classList.add("timeline-memory-header"),this._header.show(this.element),this._toolbar=new A.Toolbar("timeline-memory-toolbar"),this._header.element.appendChild(this._toolbar.element),this._graphsContainer=new W.VBox,this._graphsContainer.show(this.element);const t=new W.VBoxWithResizeCallback(this._resize.bind(this));t.show(this._graphsContainer.element),this._createCurrentValuesBar(),this._canvasContainer=t.element,this._canvasContainer.id="memory-graphs-canvas-container",this._canvas=this._canvasContainer.createChild("canvas"),this._canvas.id="memory-counters-graph",this._canvasContainer.addEventListener("mouseover",this._onMouseMove.bind(this),!0),this._canvasContainer.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this._canvasContainer.addEventListener("mouseleave",this._onMouseLeave.bind(this),!0),this._canvasContainer.addEventListener("click",this._onClick.bind(this),!0),this._timelineGrid=new E.TimelineGrid,this._canvasContainer.appendChild(this._timelineGrid.dividersElement),this._counters=[],this._counterUI=[],this._countersByName={},this._countersByName.jsHeapSizeUsed=this._createCounter(m.UIString("JS Heap"),m.UIString("JS Heap: %s"),"hsl(220, 90%, 43%)",M.bytesToString),this._countersByName.documents=this._createCounter(m.UIString("Documents"),m.UIString("Documents: %s"),"hsl(0, 90%, 43%)"),this._countersByName.nodes=this._createCounter(m.UIString("Nodes"),m.UIString("Nodes: %s"),"hsl(120, 90%, 43%)"),this._countersByName.jsEventListeners=this._createCounter(m.UIString("Listeners"),m.UIString("Listeners: %s"),"hsl(38, 90%, 43%)"),this._gpuMemoryCounter=this._createCounter(m.UIString("GPU Memory"),m.UIString("GPU Memory [KB]: %s"),"hsl(300, 90%, 43%)",M.bytesToString),this._countersByName.gpuMemoryUsedKB=this._gpuMemoryCounter}setModel(e,t){this._model!==e&&(this._model&&this._model.removeEventListener(pi.WindowChanged,this._onWindowChanged,this),this._model=e,this._model&&this._model.addEventListener(pi.WindowChanged,this._onWindowChanged,this)),this._calculator.setZeroTime(e?e.timelineModel().minimumRecordTime():0);for(let e=0;e<this._counters.length;++e)this._counters[e].reset(),this._counterUI[e].reset();if(this.scheduleRefresh(),this._track=t,!t)return;const i=t.syncEvents();for(let e=0;e<i.length;++e){const t=i[e];if(t.name!==I.RecordType.UpdateCounters)continue;const n=t.args.data;if(!n)return;for(const e in n){const i=this._countersByName[e];i&&i.appendSample(t.startTime,n[e])}const s="gpuMemoryLimitKB";s in n&&this._gpuMemoryCounter.setLimit(n[s])}}_createCurrentValuesBar(){this._currentValuesBar=this._graphsContainer.element.createChild("div"),this._currentValuesBar.id="counter-values-bar"}_createCounter(e,t,i,n){const s=new fi;return this._counters.push(s),this._counterUI.push(new vi(this,e,t,i,s,n)),s}resizerElement(){return this._header.element}_resize(){const e=this._canvas.parentElement;this._canvas.width=e.clientWidth*window.devicePixelRatio,this._canvas.height=e.clientHeight*window.devicePixelRatio,this._calculator.setDisplayWidth(this._canvas.width),this.refresh()}_onWindowChanged(e){const t=e.data.window;this._calculator.setWindow(t.left,t.right),this.scheduleRefresh()}scheduleRefresh(){B.invokeOnceAfterBatchUpdate(this,this.refresh)}draw(){this._clear();for(const e of this._counters)e._calculateVisibleIndexes(this._calculator),e._calculateXValues(this._canvas.width);for(const e of this._counterUI)e._drawGraph(this._canvas)}_onClick(e){const t=e.x-this._canvasContainer.totalOffsetLeft();let i,n=1/0;for(const e of this._counterUI){if(!e.counter.times.length)continue;const s=e._recordIndexAt(t),a=Math.abs(t*window.devicePixelRatio-e.counter.x[s]);a<n&&(n=a,i=e.counter.times[s])}void 0!==i&&this._delegate.selectEntryAtTime(this._track.events.length?this._track.events:this._track.asyncEvents,i)}_onMouseLeave(e){delete this._markerXPosition,this._clearCurrentValueAndMarker()}_clearCurrentValueAndMarker(){for(let e=0;e<this._counterUI.length;e++)this._counterUI[e]._clearCurrentValueAndMarker()}_onMouseMove(e){const t=e.x-this._canvasContainer.totalOffsetLeft();this._markerXPosition=t,this._refreshCurrentValues()}_refreshCurrentValues(){if(void 0!==this._markerXPosition)for(let e=0;e<this._counterUI.length;++e)this._counterUI[e].updateCurrentValue(this._markerXPosition)}refresh(){this._timelineGrid.updateDividers(this._calculator),this.draw(),this._refreshCurrentValues()}_clear(){const e=this._canvas.getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height)}}class fi{constructor(){this.times=[],this.values=[]}appendSample(e,t){this.values.length&&this.values.peekLast()===t||(this.times.push(e),this.values.push(t))}reset(){this.times=[],this.values=[]}setLimit(e){this._limitValue=e}_calculateBounds(){let e,t;for(let i=this._minimumIndex;i<=this._maximumIndex;i++){const n=this.values[i];(void 0===t||n<t)&&(t=n),(void 0===e||n>e)&&(e=n)}return t=t||0,e=e||1,this._limitValue&&(e>.5*this._limitValue&&(e=Math.max(e,this._limitValue)),t=Math.min(t,this._limitValue)),{min:t,max:e}}_calculateVisibleIndexes(e){const t=e.minimumBoundary(),i=e.maximumBoundary();this._minimumIndex=M.clamp(this.times.upperBound(t)-1,0,this.times.length-1),this._maximumIndex=M.clamp(this.times.lowerBound(i),0,this.times.length-1),this._minTime=t,this._maxTime=i}_calculateXValues(e){if(!this.values.length)return;const t=e/(this._maxTime-this._minTime);this.x=new Array(this.values.length);for(let e=this._minimumIndex+1;e<=this._maximumIndex;e++)this.x[e]=t*(this.times[e]-this._minTime)}}class vi{constructor(e,t,i,n,s,a){this._countersPane=e,this.counter=s,this._formatter=a||Number.withThousandsSeparator,this._setting=p.Settings.instance().createSetting("timelineCountersGraph-"+t,!0),this._setting.setTitle(t),this._filter=new A.ToolbarSettingCheckbox(this._setting,t),this._filter.inputElement.classList.add("-theme-preserve-input");const r=f.Color.parse(n).setAlpha(.5).asString(f.Format.RGBA);r&&(this._filter.element.backgroundColor=r,this._filter.element.borderColor="transparent"),this._filter.inputElement.addEventListener("click",this._toggleCounterGraph.bind(this)),e._toolbar.appendToolbarItem(this._filter),this._range=this._filter.element.createChild("span","range"),this._value=e._currentValuesBar.createChild("span","memory-counter-value"),this._value.style.color=n,this.graphColor=n,this.limitColor=f.Color.parse(n).setAlpha(.3).asString(f.Format.RGBA),this.graphYValues=[],this._verticalPadding=10,this._currentValueLabel=i,this._marker=e._canvasContainer.createChild("div","memory-counter-marker"),this._marker.style.backgroundColor=n,this._clearCurrentValueAndMarker()}reset(){this._range.textContent=""}setRange(e,t){const i=this._formatter(e),n=this._formatter(t);this._range.textContent=m.UIString("[%s – %s]",i,n)}_toggleCounterGraph(e){this._value.classList.toggle("hidden",!this._filter.checked()),this._countersPane.refresh()}_recordIndexAt(e){return this.counter.x.upperBound(e*window.devicePixelRatio,null,this.counter._minimumIndex+1,this.counter._maximumIndex+1)-1}updateCurrentValue(e){if(!this.visible()||!this.counter.values.length||!this.counter.x)return;const t=this._recordIndexAt(e),i=Number.withThousandsSeparator(this.counter.values[t]);this._value.textContent=m.UIString(this._currentValueLabel,i);const n=this.graphYValues[t]/window.devicePixelRatio;this._marker.style.left=e+"px",this._marker.style.top=n+"px",this._marker.classList.remove("hidden")}_clearCurrentValueAndMarker(){this._value.textContent="",this._marker.classList.add("hidden")}_drawGraph(e){const t=e.getContext("2d"),i=e.width,n=e.height-2*this._verticalPadding;if(n<=0)return void(this.graphYValues=[]);const s=this._verticalPadding,a=this.counter,r=a.values;if(!r.length)return;const o=a._calculateBounds(),l=o.min,h=o.max;if(this.setRange(l,h),!this.visible())return;const d=this.graphYValues,c=h-l,m=c?n/c:1;t.save(),t.lineWidth=window.devicePixelRatio,t.lineWidth%2&&t.translate(.5,.5),t.beginPath();let u=r[a._minimumIndex],p=Math.round(s+n-(u-l)*m);t.moveTo(0,p);let _=a._minimumIndex;for(;_<=a._maximumIndex;_++){const e=Math.round(a.x[_]);t.lineTo(e,p);const i=r[_];void 0!==i&&(u=i),p=Math.round(s+n-(u-l)*m),t.lineTo(e,p),d[_]=p}if(d.length=_,t.lineTo(i,p),t.strokeStyle=this.graphColor,t.stroke(),a._limitValue){const e=Math.round(s+n-(a._limitValue-l)*m);t.moveTo(0,e),t.lineTo(i,e),t.strokeStyle=this.limitColor,t.stroke()}t.closePath(),t.restore()}visible(){return this._filter.checked()}}class Ti{setZeroTime(e){this._zeroTime=e}computePosition(e){return(e-this._minimumBoundary)/this.boundarySpan()*this._workingArea}setWindow(e,t){this._minimumBoundary=e,this._maximumBoundary=t}setDisplayWidth(e){this._workingArea=e}formatValue(e,t){return Number.preciseMillisToString(e-this.zeroTime(),t)}maximumBoundary(){return this._maximumBoundary}minimumBoundary(){return this._minimumBoundary}zeroTime(){return this._zeroTime}boundarySpan(){return this._maximumBoundary-this._minimumBoundary}}var wi=Object.freeze({__proto__:null,CountersGraph:gi,Counter:fi,CounterUI:vi,Calculator:Ti});export{Ue as CLSLinkifier,wi as CountersGraph,_t as EventsTimelineTreeView,Ge as ExtensionTracingSession,_i as PerformanceModel,Oe as TimelineController,Ct as TimelineDetailsView,et as TimelineEventOverview,st as TimelineFilters,Pt as TimelineFlameChartDataProvider,Lt as TimelineFlameChartNetworkDataProvider,Nt as TimelineFlameChartView,Ot as TimelineHistoryManager,ft as TimelineLayersView,Ve as TimelineLoader,wt as TimelinePaintProfilerView,ti as TimelinePanel,mt as TimelineTreeView,mi as TimelineUIUtils,Jt as UIDevtoolsController,qt as UIDevtoolsUtils};
