import{Throttler as e}from"../common/common.js";import{FrameManager as t,OverlayModel as s,PageResourceLoader as i}from"../sdk/sdk.js";import{Widget as r,UIUtils as o,Toolbar as h}from"../ui/ui.js";import{DataGrid as l,SortableDataGrid as a}from"../data_grid/data_grid.js";import{ls as n}from"../platform/platform.js";import{TextRange as d}from"../text_utils/text_utils.js";class u extends r.VBox{constructor(e){super(!0),this._nodeForItem=new Map,this._isVisibleFilter=e,this._highlightRegExp=null,this.registerRequiredCSS("developer_resources/developerResourcesListView.css");const t=[{id:"status",title:n`Status`,width:"60px",fixedWidth:!0,sortable:!0},{id:"url",title:n`URL`,width:"250px",fixedWidth:!1,sortable:!0},{id:"frame",title:n`Frame`,width:"80px",fixedWidth:!1,sortable:!0},{id:"size",title:n`Total Bytes`,width:"80px",fixedWidth:!0,sortable:!0,align:l.Align.Right},{id:"errorMessage",title:n`Error`,width:"200px",fixedWidth:!1,sortable:!0}];this._dataGrid=new a.SortableDataGrid({displayName:n`Developer Resources`,columns:t}),this._dataGrid.setResizeMethod(l.ResizeMethod.Last),this._dataGrid.element.classList.add("flex-auto"),this._dataGrid.addEventListener(l.Events.SortingChanged,this._sortingChanged,this);const s=this._dataGrid.asWidget();s.show(this.contentElement),this.setDefaultFocusedChild(s)}update(e){let t=!1;const s=this._dataGrid.rootNode();for(const i of e){let e=this._nodeForItem.get(i);e?this._isVisibleFilter(e.item)&&(t=e._refreshIfNeeded()||t):(e=new c(i),this._nodeForItem.set(i,e),this._isVisibleFilter(e.item)&&(s.appendChild(e),t=!0))}t&&this._sortingChanged()}reset(){this._nodeForItem.clear(),this._dataGrid.rootNode().removeChildren()}updateFilterAndHighlight(e){this._highlightRegExp=e;let t=!1;for(const e of this._nodeForItem.values()){const s=this._isVisibleFilter(e.item),i=!!e.parent;s&&e._setHighlight(this._highlightRegExp),s!==i&&(t=!0,s?this._dataGrid.rootNode().appendChild(e):e.remove())}t&&this._sortingChanged()}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;const t=c.sortFunctionForColumn(e);t&&this._dataGrid.sortNodes(t,!this._dataGrid.isSortOrderAscending())}}class c extends a.SortableDataGridNode{constructor(e){super(),this.item=e,this._highlightRegExp=null}_setHighlight(e){this._highlightRegExp!==e&&(this._highlightRegExp=e,this.refresh())}_refreshIfNeeded(){return this.refresh(),!0}createCell(e){const i=this.createTD(e);switch(e){case"url":{i.title=this.item.url;const t=i.createChild("div","url-outer"),s=t.createChild("div","url-prefix"),r=t.createChild("div","url-suffix"),o=/^(.*)(\/[^/]*)$/.exec(this.item.url);s.textContent=o?o[1]:this.item.url,r.textContent=o?o[2]:"",this._highlightRegExp&&this._highlight(t,this.item.url),this.setCellAccessibleName(this.item.url,i,e);break}case"frame":{const e=t.FrameManager.instance().getFrame(this.item.frameId);i.textContent=e?e.displayName():this.item.frameId,i.onmouseenter=()=>{const e=t.FrameManager.instance().getFrame(this.item.frameId);e&&e.highlight()},i.onmouseleave=()=>s.OverlayModel.hideDOMNodeHighlight();break}case"status":null===this.item.success?i.textContent=n`pending`:i.textContent=this.item.success?n`success`:n`failure`;break;case"size":{const t=this.item.size;if(null!==t){i.createChild("span").textContent=Number.withThousandsSeparator(t);const s=1===t?n`1 byte`:n`${t} bytes`;this.setCellAccessibleName(s,i,e)}break}case"errorMessage":i.classList.add("error-message"),this.item.errorMessage&&(i.textContent=this.item.errorMessage,this._highlightRegExp&&this._highlight(i,this.item.errorMessage))}return i}_highlight(e,t){if(!this._highlightRegExp)return;const s=this._highlightRegExp.exec(t);if(!s||!s.length)return;const i=new d.SourceRange(s.index,s[0].length);o.highlightRangesWithStyleClass(e,[i],"filter-highlight")}static sortFunctionForColumn(e){const t=e=>null===e?-1:Number(e);switch(e){case"url":return(e,t)=>e.item.url.localeCompare(t.item.url);case"status":return(e,s)=>t(e.item.success)-t(s.item.success);case"size":return(e,s)=>t(e.item.size)-t(s.item.size);case"frame":return(e,t)=>e.item.frameId.localeCompare(t.item.frameId);case"errorMessage":return(e,t)=>(e.item.errorMessage||"").localeCompare(t.item.errorMessage||"");default:return console.assert(!1,"Unknown sort field: "+e),null}}}class g extends r.VBox{constructor(){super(!0),this.registerRequiredCSS("developer_resources/developerResourcesView.css");const t=this.contentElement.createChild("div","developer-resource-view-toolbar-container"),s=new h.Toolbar("developer-resource-view-toolbar",t);this._textFilterRegExp=null;this._filterInput=new h.ToolbarInput(ls`Enter text to search the URL and Error columns`,"",1),this._filterInput.addEventListener(h.ToolbarInput.Event.TextChanged,this._onFilterChanged,this),s.appendToolbarItem(this._filterInput),this._coverageResultsElement=this.contentElement.createChild("div","developer-resource-view-results"),this._listView=new u(this._isVisible.bind(this)),this._listView.show(this._coverageResultsElement),this._statusToolbarElement=this.contentElement.createChild("div","developer-resource-view-toolbar-summary"),this._statusMessageElement=this._statusToolbarElement.createChild("div","developer-resource-view-message"),this._throttler=new e.Throttler(100),this._loader=i.PageResourceLoader.instance(),this._loader.addEventListener(i.Events.Update,this._onUpdate,this),this._onUpdate()}_onUpdate(){this._throttler.schedule(this._update.bind(this))}async _update(){this._listView.reset(),this._listView.update(this._loader.getResourcesLoaded().values()),this._updateStats()}_updateStats(){const{loading:e,resources:t}=this._loader.getNumberOfResources();this._statusMessageElement.textContent=e>0?`${t} resources, ${e} currently loading`:t+" resources"}_isVisible(e){return!this._textFilterRegExp||this._textFilterRegExp.test(e.url)||this._textFilterRegExp.test(e.errorMessage||"")}_onFilterChanged(){if(!this._listView)return;const e=this._filterInput.value();this._textFilterRegExp=e?createPlainTextSearchRegex(e,"i"):null,this._listView.updateFilterAndHighlight(this._textFilterRegExp),this._updateStats()}}var m=Object.freeze({__proto__:null,DeveloperResourcesView:g});export{m as DeveloperResourcesView};
