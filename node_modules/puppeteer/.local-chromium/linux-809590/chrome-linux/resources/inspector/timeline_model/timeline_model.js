import{Settings as e,Console as t,SegmentedRange as s,UIString as a}from"../common/common.js";import{TracingModel as r,SDKModel as n,CPUProfileDataModel as i,LayerTreeBase as o,PaintProfiler as l}from"../sdk/sdk.js";class c{static generateTracingEventsFromCpuProfile(e,t){const s=e.idleNode,a=e.programNode,n=e.gcNode,i=e.samples,o=e.timestamps,l=[],c=new Map;c.set(a,[]);for(let a=0;a<i.length;++a){let d=e.nodeByIndex(a);if(!d){console.error(`Node with unknown id ${i[a]} at index ${a}`);continue}if(d===n||d===s)continue;let h=c.get(d);if(!h){h=new Array(d.depth+1),c.set(d,h);for(let e=0;d.parent;d=d.parent)h[e++]=d}const u=new r.Event(r.DevToolsTimelineEventCategory,m.JSSample,r.Phase.Instant,o[a],t);u.args.data={stackTrace:h},l.push(u)}return l}static generateJSFrameEvents(t){const s=[],a=[],n=[];let i=0;const o=Root.Runtime.experiments.isEnabled("timelineShowAllEvents"),l=Root.Runtime.experiments.isEnabled("timelineV8RuntimeCallStats"),d=e.Settings.instance().moduleSetting("showNativeFunctionsInJSProfile").get();function u(e,t){if(n.length){const s=n.peekLast();e<s&&(console.error(`Child stack is shallower (${e}) than the parent stack (${s}) at ${t}`),e=s)}a.length<e&&(console.error("Trying to truncate higher than the current stack size at "+t),e=a.length);for(let e=0;e<a.length;++e)a[e].setEndTime(t);a.length=e}function p(e){const t=m,i=e.name===t.JSSample?e.args.data.stackTrace.slice().reverse():a.map(e=>e.args.data);!function(e){if(o)return;let t=null,s=0;for(let r=0;r<e.length;++r){const n=e[r],i=n.url,o=i&&i.startsWith("native ");if(!d&&o)continue;const h=c.isNativeRuntimeFrame(n);if(h&&(a=n.functionName,!l||!c.nativeGroup(a)))continue;const m=h?c.nativeGroup(n.functionName):null;t&&t===m||(t=m,e[s++]=n)}var a;e.length=s}(i);const h=e.endTime||e.startTime,p=Math.min(i.length,a.length);let _;for(_=n.peekLast()||0;_<p;++_){const e=i[_],t=a[_].args.data;if(T=t,(g=e).scriptId!==T.scriptId||g.functionName!==T.functionName||g.lineNumber!==T.lineNumber)break;a[_].setEndTime(Math.max(a[_].endTime,h))}var g,T;for(u(_,e.startTime);_<i.length;++_){const n=i[_],o=new r.Event(r.DevToolsTimelineEventCategory,t.JSFrame,r.Phase.Complete,e.startTime,e.thread);o.ordinal=e.ordinal,o.addArgs({data:n}),o.setEndTime(h),a.push(o),s.push(o)}}const _=t.find(r.TracingModel.isTopLevelEvent),g=_?_.startTime:0;return h.forEachEvent(t,(function(e){e.ordinal=++i,p(e),n.push(a.length)}),(function(e){u(n.pop(),e.endTime)}),(function(e,t){e.ordinal=++i,t&&function(e){switch(e.name){case m.RunMicrotasks:case m.FunctionCall:case m.EvaluateScript:case m.EvaluateModule:case m.EventDispatch:case m.V8Execute:return!0}return!1}(t)&&p(e)}),g),s}static isNativeRuntimeFrame(e){return"native V8Runtime"===e.url}static nativeGroup(e){return e.startsWith("Parse")?c.NativeGroups.Parse:e.startsWith("Compile")||e.startsWith("Recompile")?c.NativeGroups.Compile:null}static buildTraceProfileFromCpuProfile(e,t,s,a){const n=[];if(s&&_("TracingStartedInPage",{data:{sessionId:"1"}},0,0,"M"),a||(a=ls`Thread ${t}`),_(r.MetadataEvent.ThreadName,{name:a},0,0,"M","__metadata"),!e)return n;const i=new Map,o=e.nodes;for(let e=0;e<o.length;++e)i.set(o[e].id,o[e]);let l,c=null,d=null,h=e.startTime;const m=e.samples,u=e.timeDeltas;for(let e=0;e<m.length;++e){l=h,h+=u[e];const t=i.get(m[e]).callFrame.functionName;"(idle)"!==t?(c||(c=_("MessageLoop::RunTask",{},l,0,"X","toplevel")),"(program)"===t?d&&(d.dur=l-d.ts,d=null):d||(d=_("FunctionCall",{data:{sessionId:"1"}},l))):p()}return p(),_("CpuProfile",{data:{cpuProfile:e}},e.endTime,0,"I"),n;function p(){c&&(c.dur=l-c.ts),d&&(d.dur=l-d.ts),c=null,d=null}function _(e,s,a,r,i,o){const l={cat:o||"disabled-by-default-devtools.timeline",name:e,ph:i||"X",pid:1,tid:t,ts:a,args:s};return r&&(l.dur=r),n.push(l),l}}}c.NativeGroups={Compile:"Compile",Parse:"Parse"};var d=Object.freeze({__proto__:null,TimelineJSProfileProcessor:c});class h{constructor(){this._estimatedTotalBlockingTime=0,this._reset()}static forEachEvent(e,t,s,a,n,i,o){n=n||0,i=i||1/0;const l=[];for(let c=h._topLevelEventEndingAfter(e,n);c<e.length;++c){const d=e[c];if(!((d.endTime||d.startTime)<n)){if(d.startTime>=i)break;if(!r.TracingModel.isAsyncPhase(d.phase)&&!r.TracingModel.isFlowPhase(d.phase)){for(;l.length&&l.peekLast().endTime<=d.startTime;)s(l.pop());o&&!o(d)||(d.duration?(t(d),l.push(d)):a&&a(d,l.peekLast()||null))}}}for(;l.length;)s(l.pop())}static _topLevelEventEndingAfter(e,t){let s=e.upperBound(t,(e,t)=>e-t.startTime)-1;for(;s>0&&!r.TracingModel.isTopLevelEvent(e[s]);)s--;return Math.max(s,0)}isMarkerEvent(e){const t=m;switch(e.name){case t.TimeStamp:return!0;case t.MarkFirstPaint:case t.MarkFCP:return this._mainFrame&&e.args.frame===this._mainFrame.frameId&&!!e.args.data;case t.MarkDOMContent:case t.MarkLoad:case t.MarkLCPCandidate:case t.MarkLCPInvalidate:return!!e.args.data.isMainFrame;default:return!1}}isInteractiveTimeEvent(e){return e.name===m.InteractiveTime}isLayoutShiftEvent(e){return e.name===m.LayoutShift}isUserTimingEvent(e){return e.categoriesString===h.Category.UserTiming}isParseHTMLEvent(e){return e.name===m.ParseHTML}isLCPCandidateEvent(e){return e.name===m.MarkLCPCandidate&&!!e.args.data.isMainFrame}isLCPInvalidateEvent(e){return e.name===m.MarkLCPInvalidate&&!!e.args.data.isMainFrame}static globalEventId(e,t){const s=e.args.data||e.args.beginData,a=s&&s[t];return a?`${e.thread.process().id()}.${a}`:""}static eventFrameId(e){const t=e.args.data||e.args.beginData;return t&&t.frame||""}cpuProfiles(){return this._cpuProfiles}totalBlockingTime(){return-1===this._totalBlockingTime?{time:this._estimatedTotalBlockingTime,estimated:!0}:{time:this._totalBlockingTime,estimated:!1}}targetByEvent(e){const t=this._workerIdByThread.get(e.thread),s=n.TargetManager.instance().mainTarget();return t?n.TargetManager.instance().targetById(t):s}navStartTimes(){return this._tracingModel?this._tracingModel.navStartTimes():new Map}setEvents(e){this._reset(),this._resetProcessingState(),this._tracingModel=e,this._minimumRecordTime=e.minimumRecordTime(),this._maximumRecordTime=e.maximumRecordTime();const t=[];for(const s of e.sortedProcesses())if("Renderer"===s.name())for(const e of s.sortedThreads()){const s=e.removeEventsByName(m.LayoutShift);t.push(...s)}if(this._processSyncBrowserEvents(e),this._browserFrameTracking)this._processThreadsForBrowserFrames(e);else{const t=this._processMetadataEvents(e);this._isGenericTrace=!t,t?this._processMetadataAndThreads(e,t):this._processGenericTrace(e)}this._inspectedTargetEvents.sort(r.Event.compareStartTime),this._processAsyncBrowserEvents(e),this._buildGPUEvents(e),this._buildLoadingEvents(e,t),this._resetProcessingState()}_processGenericTrace(e){let t=r.TracingModel.browserMainThread(e);!t&&e.sortedProcesses().length&&(t=e.sortedProcesses()[0].sortedThreads()[0]);for(const s of e.sortedProcesses())for(const a of s.sortedThreads())this._processThreadEvents(e,[{from:0,to:1/0}],a,a===t,!1,!0,null)}_processMetadataAndThreads(e,t){let s=0;for(let a=0,r=t.page.length;a<r;a++){const n=t.page[a],i=n.thread.process(),o=a+1<r?t.page[a+1].startTime:1/0;if(s!==o){this._legacyCurrentPage=n.args.data&&n.args.data.page;for(const a of i.sortedThreads()){let r=null;if(a.name()===h.WorkerThreadName||a.name()===h.WorkerThreadNameLegacy){const e=t.workers.find(e=>e.args.data.workerThreadId===a.id()&&(e.args.data.sessionId===this._sessionId||!!this._pageFrames.get(h.eventFrameId(e))));if(!e)continue;const s=e.args.data.workerId;s&&this._workerIdByThread.set(a,s),r=e.args.data.url||""}this._processThreadEvents(e,[{from:s,to:o}],a,a===n.thread,!!r,!0,r)}s=o}}}_processThreadsForBrowserFrames(e){const t=new Map;for(const e of this._pageFrames.values())for(let s=0;s<e.processes.length;s++){const a=e.processes[s].processId;let r=t.get(a);r||(r=[],t.set(a,r));const n=s===e.processes.length-1?e.deletedTime||1/0:e.processes[s+1].time;r.push({from:e.processes[s].time,to:n,main:!e.parent,url:e.processes[s].url})}const s=e.devToolsMetadataEvents();for(const a of e.sortedProcesses()){const r=t.get(a.id());if(!r)continue;r.sort((e,t)=>e.from-t.from||e.to-t.to);const n=[];let i=null,o=null,l=!1;for(const e of r)!n.length||e.from>n.peekLast().to?n.push({from:e.from,to:e.to}):n.peekLast().to=e.to,e.main&&(l=!0),e.url&&(e.main&&(o=e.url),i=e.url);for(const t of a.sortedThreads())if(t.name()===h.RendererMainThreadName)this._processThreadEvents(e,n,t,!0,!1,l,l?o:i);else if(t.name()===h.WorkerThreadName||t.name()===h.WorkerThreadNameLegacy){const r=s.find(e=>e.name===h.DevToolsMetadataEvent.TracingSessionIdForWorker&&(e.thread.process()===a&&(e.args.data.workerThreadId===t.id()&&!!this._pageFrames.get(h.eventFrameId(e)))));if(!r)continue;this._workerIdByThread.set(t,r.args.data.workerId||""),this._processThreadEvents(e,n,t,!1,!0,!1,r.args.data.url||"")}else this._processThreadEvents(e,n,t,!1,!1,!1,null)}}_processMetadataEvents(e){const s=e.devToolsMetadataEvents(),a=[],n=[];for(const e of s)if(e.name===h.DevToolsMetadataEvent.TracingStartedInPage){a.push(e),e.args.data&&e.args.data.persistentIds&&(this._persistentIds=!0);(e.args.data&&e.args.data.frames||[]).forEach(t=>this._addPageFrame(e,t)),this._mainFrame=this.rootFrames()[0]}else e.name===h.DevToolsMetadataEvent.TracingSessionIdForWorker?n.push(e):e.name===h.DevToolsMetadataEvent.TracingStartedInBrowser&&(console.assert(!this._mainFrameNodeId,"Multiple sessions in trace"),this._mainFrameNodeId=e.args.frameTreeNodeId);if(!a.length)return null;const i=a[0].args.sessionId||a[0].args.data.sessionId;this._sessionId=i;const o=new Set;const l={page:a.filter((function(e){let t=e.args;t.data&&(t=t.data);const s=t.sessionId;return s===i||(o.add(s),!1)})).sort(r.Event.compareStartTime),workers:n.sort(r.Event.compareStartTime)};return o.size&&t.Console.instance().error("Timeline recording was started in more than one page simultaneously. Session id mismatch: "+this._sessionId+" and "+[...o]+"."),l}_processSyncBrowserEvents(e){const t=r.TracingModel.browserMainThread(e);t&&t.events().forEach(this._processBrowserEvent,this)}_processAsyncBrowserEvents(e){const t=r.TracingModel.browserMainThread(e);t&&this._processAsyncEvents(t,[{from:0,to:1/0}])}_buildGPUEvents(e){const t=e.threadByName("GPU Process","CrGpuMain");if(!t)return;const s=m.GPUTask,a=this._ensureNamedTrack(p.GPU);a.thread=t,a.events=t.events().filter(e=>e.name===s)}_buildLoadingEvents(e,t){const s=e.threadByName("Renderer","CrRendererMain");if(!s)return;const a=this._ensureNamedTrack(p.Experience);a.thread=s,a.events=t;for(const e of a.events)if(e.categoriesString="experience",e.name===m.LayoutShift){const t=e.args.data||e.args.beginData||{};y.forEvent(e).backendNodeId=t.impacted_nodes[0].node_id}}_resetProcessingState(){this._asyncEventTracker=new f,this._invalidationTracker=new v,this._layoutInvalidate={},this._lastScheduleStyleRecalculation={},this._paintImageEventByPixelRefId={},this._lastPaintForLayer={},this._lastRecalculateStylesEvent=null,this._currentScriptEvent=null,this._eventStack=[],this._knownInputEvents=new Set,this._browserFrameTracking=!1,this._persistentIds=!1,this._legacyCurrentPage=null}_extractCpuProfile(e,s){const a=s.events();let r,n=null,o=a.peekLast();if(o&&o.name===m.CpuProfile){const e=o.args.data;r=e&&e.cpuProfile,n=this.targetByEvent(o)}if(!r){if(o=a.find(e=>e.name===m.Profile),!o)return null;n=this.targetByEvent(o);const s=e.profileGroup(o);if(!s)return t.Console.instance().error("Invalid CPU profile format."),null;r={startTime:1e3*o.startTime,endTime:0,nodes:[],samples:[],timeDeltas:[],lines:[]};for(const e of s.children){const s=e.args.data;"startTime"in s&&(r.startTime=1e3*e.startTime),"endTime"in s&&(r.endTime=1e3*e.startTime);const a=s.cpuProfile||{},n=a.samples||[],i=s.lines||Array(n.length).fill(0);if(r.nodes.push(...a.nodes||[]),r.lines.push(...i),r.samples.push(...n),r.timeDeltas.push(...s.timeDeltas||[]),r.samples.length!==r.timeDeltas.length)return t.Console.instance().error("Failed to parse CPU profile."),null}r.endTime||(r.endTime=r.timeDeltas.reduce((e,t)=>e+t,r.startTime))}try{const e=new i.CPUProfileDataModel(r,n);return this._cpuProfiles.push(e),e}catch(e){t.Console.instance().error("Failed to parse CPU profile.")}return null}_injectJSFrameEvents(e,t){const s=this._extractCpuProfile(e,t);let a=t.events();const n=s?c.generateTracingEventsFromCpuProfile(s,t):null;if(n&&n.length&&(a=a.mergeOrdered(n,r.Event.orderedCompareStartTime)),n||a.some(e=>e.name===m.JSSample)){const e=c.generateJSFrameEvents(a);e&&e.length&&(a=e.mergeOrdered(a,r.Event.orderedCompareStartTime))}return a}_processThreadEvents(e,t,s,a,n,i,o){const l=new u;l.name=s.name()||ls`Thread ${s.id()}`,l.type=p.Other,l.thread=s,a?(l.type=p.MainThread,l.url=o||null,l.forMainFrame=i):n?(l.type=p.Worker,l.url=o,l.name=l.url?ls`Worker — ${l.url}`:ls`Dedicated Worker`):s.name().startsWith("CompositorTileWorker")&&(l.type=p.Raster),this._tracks.push(l);const c=this._injectJSFrameEvents(e,s);this._eventStack=[];const d=this._eventStack;if(n){const e=c.find(e=>e.name===m.Profile);if(e){const t=this.targetByEvent(e);t&&(l.name=ls`Worker: ${t.name()} — ${l.url}`)}}for(const e of t){let t=c.lowerBound(e.from,(e,t)=>e-t.startTime);for(;t<c.length;t++){const s=c[t];if(s.startTime>=e.to)break;this.isInteractiveTimeEvent(s)&&-1===this._totalBlockingTime&&(this._totalBlockingTime=s.args.args.total_blocking_time_ms);const n=s.name===m.Task&&s.duration&&s.duration>50;for(a&&n&&s.duration&&(this._estimatedTotalBlockingTime+=s.duration-50);d.length&&d.peekLast().endTime<=s.startTime;)d.pop();if(this._processEvent(s)){if(!r.TracingModel.isAsyncPhase(s.phase)&&s.duration){if(d.length){const e=d.peekLast();e.selfTime-=s.duration,e.selfTime<0&&this._fixNegativeDuration(e,s)}s.selfTime=s.duration,d.length||l.tasks.push(s),d.push(s)}this.isMarkerEvent(s)&&this._timeMarkerEvents.push(s),l.events.push(s),this._inspectedTargetEvents.push(s)}}}this._processAsyncEvents(s,t)}_fixNegativeDuration(e,t){e.selfTime<-.001&&console.error(`Children are longer than parent at ${e.startTime} (${(t.startTime-this.minimumRecordTime()).toFixed(3)} by ${(-e.selfTime).toFixed(3)}`),e.selfTime=0}_processAsyncEvents(e,t){const s=e.asyncEvents(),a=new Map;function n(e){return a.has(e)||a.set(e,[]),a.get(e)}for(const e of t){let t=s.lowerBound(e.from,(function(e,t){return e-t.startTime}));for(;t<s.length;++t){const a=s[t];if(a.startTime>=e.to)break;if(a.hasCategory(h.Category.Console))n(p.Console).push(a);else if(a.hasCategory(h.Category.UserTiming))n(p.Timings).push(a);else if(a.name!==m.Animation)if(a.hasCategory(h.Category.LatencyInfo)||a.name===m.ImplSideFling){const e=a.steps.peekLast();if(e.phase!==r.Phase.AsyncEnd)continue;const t=e.args.data;if(a.causedFrame=!(!t||!t.INPUT_EVENT_LATENCY_RENDERER_SWAP_COMPONENT),a.hasCategory(h.Category.LatencyInfo)){if(!this._knownInputEvents.has(e.id))continue;if(a.name===m.InputLatencyMouseMove&&!a.causedFrame)continue;if(t.is_coalesced)continue;const s=t.INPUT_EVENT_LATENCY_RENDERER_MAIN_COMPONENT;if(s){const e=s.time/1e3;y.forEvent(a.steps[0]).timeWaitingForMainThread=e-a.steps[0].startTime}}n(p.Input).push(a)}else;else n(p.Animation).push(a)}}for(const[t,s]of a){const a=this._ensureNamedTrack(t);a.thread=e,a.asyncEvents=a.asyncEvents.mergeOrdered(s,r.Event.compareStartTime)}}_processEvent(e){const t=m,s=this._eventStack;if(!s.length){if(this._currentTaskLayoutAndRecalcEvents&&this._currentTaskLayoutAndRecalcEvents.length){if(this._currentTaskLayoutAndRecalcEvents.reduce((e,t)=>e+t.duration,0)>h.Thresholds.ForcedLayout)for(const e of this._currentTaskLayoutAndRecalcEvents){y.forEvent(e).warning=e.name===t.Layout?h.WarningType.ForcedLayout:h.WarningType.ForcedStyle}}this._currentTaskLayoutAndRecalcEvents=[]}this._currentScriptEvent&&e.startTime>this._currentScriptEvent.endTime&&(this._currentScriptEvent=null);const a=e.args.data||e.args.beginData||{},r=y.forEvent(e);if(a.stackTrace&&(r.stackTrace=a.stackTrace),r.stackTrace&&e.name!==t.JSSample)for(let e=0;e<r.stackTrace.length;++e)--r.stackTrace[e].lineNumber,--r.stackTrace[e].columnNumber;let n=h.eventFrameId(e);switch(!n&&s.length&&(n=y.forEvent(s.peekLast()).frameId),r.frameId=n||this._mainFrame&&this._mainFrame.frameId||"",this._asyncEventTracker.processEvent(e),this.isMarkerEvent(e)&&this._ensureNamedTrack(p.Timings),e.name){case t.ResourceSendRequest:case t.WebSocketCreate:r.setInitiator(s.peekLast()||null),r.url=a.url;break;case t.ScheduleStyleRecalculation:this._lastScheduleStyleRecalculation[a.frame]=e;break;case t.UpdateLayoutTree:case t.RecalculateStyles:this._invalidationTracker.didRecalcStyle(e),e.args.beginData&&r.setInitiator(this._lastScheduleStyleRecalculation[e.args.beginData.frame]),this._lastRecalculateStylesEvent=e,this._currentScriptEvent&&this._currentTaskLayoutAndRecalcEvents.push(e);break;case t.ScheduleStyleInvalidationTracking:case t.StyleRecalcInvalidationTracking:case t.StyleInvalidatorInvalidationTracking:case t.LayoutInvalidationTracking:this._invalidationTracker.addInvalidation(new T(e));break;case t.InvalidateLayout:{let t=e;const s=a.frame;!this._layoutInvalidate[s]&&this._lastRecalculateStylesEvent&&this._lastRecalculateStylesEvent.endTime>e.startTime&&(t=y.forEvent(this._lastRecalculateStylesEvent).initiator()),this._layoutInvalidate[s]=t;break}case t.Layout:{this._invalidationTracker.didLayout(e);const t=e.args.beginData.frame;r.setInitiator(this._layoutInvalidate[t]),e.args.endData&&(r.backendNodeId=e.args.endData.rootNode),this._layoutInvalidate[t]=null,this._currentScriptEvent&&this._currentTaskLayoutAndRecalcEvents.push(e);break}case t.Task:e.duration>h.Thresholds.LongTask&&(r.warning=h.WarningType.LongTask);break;case t.EventDispatch:e.duration>h.Thresholds.RecurringHandler&&(r.warning=h.WarningType.LongHandler);break;case t.TimerFire:case t.FireAnimationFrame:e.duration>h.Thresholds.RecurringHandler&&(r.warning=h.WarningType.LongRecurringHandler);break;case t.FunctionCall:"string"==typeof a.scriptName&&(a.url=a.scriptName),"number"==typeof a.scriptLine&&(a.lineNumber=a.scriptLine);case t.EvaluateScript:case t.CompileScript:"number"==typeof a.lineNumber&&--a.lineNumber,"number"==typeof a.columnNumber&&--a.columnNumber;case t.RunMicrotasks:this._currentScriptEvent||(this._currentScriptEvent=e);break;case t.SetLayerTreeId:{if(this._sessionId&&a.sessionId&&this._sessionId===a.sessionId){this._mainFrameLayerTreeId=a.layerTreeId;break}const t=h.eventFrameId(e),s=this._pageFrames.get(t);if(!s||s.parent)return!1;this._mainFrameLayerTreeId=a.layerTreeId;break}case t.Paint:{if(this._invalidationTracker.didPaint(e),r.backendNodeId=a.nodeId,!a.layerId)break;const t=a.layerId;this._lastPaintForLayer[t]=e;break}case t.DisplayItemListSnapshot:case t.PictureSnapshot:{const s=this._findAncestorEvent(t.UpdateLayer);if(!s||s.args.layerTreeId!==this._mainFrameLayerTreeId)break;const a=this._lastPaintForLayer[s.args.layerId];a&&(y.forEvent(a).picture=e);break}case t.ScrollLayer:r.backendNodeId=a.nodeId;break;case t.PaintImage:r.backendNodeId=a.nodeId,r.url=a.url;break;case t.DecodeImage:case t.ResizeImage:{let e=this._findAncestorEvent(t.PaintImage);if(!e){const s=this._findAncestorEvent(t.DecodeLazyPixelRef);e=s&&this._paintImageEventByPixelRefId[s.args.LazyPixelRef]}if(!e)break;const s=y.forEvent(e);r.backendNodeId=s.backendNodeId,r.url=s.url;break}case t.DrawLazyPixelRef:{const s=this._findAncestorEvent(t.PaintImage);if(!s)break;this._paintImageEventByPixelRefId[e.args.LazyPixelRef]=s;const a=y.forEvent(s);r.backendNodeId=a.backendNodeId,r.url=a.url;break}case t.FrameStartedLoading:if(r.frameId!==e.args.frame)return!1;break;case t.MarkLCPCandidate:r.backendNodeId=a.nodeId;break;case t.MarkDOMContent:case t.MarkLoad:{const t=h.eventFrameId(e);if(!this._pageFrames.has(t))return!1;break}case t.CommitLoad:{if(this._browserFrameTracking)break;const t=h.eventFrameId(e),s=!!a.isMainFrame,r=this._pageFrames.get(t);if(r)r.update(e.startTime,a);else if(this._persistentIds){if(s)return!1;if(!this._addPageFrame(e,a))return!1}else if(a.page&&a.page!==this._legacyCurrentPage)return!1;s&&(this._mainFrame=this._pageFrames.get(t));break}case t.FireIdleCallback:e.duration>a.allottedMilliseconds+h.Thresholds.IdleCallbackAddon&&(r.warning=h.WarningType.IdleDeadlineExceeded)}return!0}_processBrowserEvent(e){if(e.name!==m.LatencyInfoFlow)if(e.name!==m.ResourceWillSendRequest){if(e.hasCategory(r.DevToolsMetadataEventCategory)&&e.args.data){const t=e.args.data;if(e.name===h.DevToolsMetadataEvent.TracingStartedInBrowser){if(!t.persistentIds)return;this._browserFrameTracking=!0,this._mainFrameNodeId=t.frameTreeNodeId;return void(t.frames||[]).forEach(e=>{const t=e.parent&&this._pageFrames.get(e.parent);if(e.parent&&!t)return;let s=this._pageFrames.get(e.frame);s||(s=new _(e),this._pageFrames.set(s.frameId,s),t?t.addChild(s):this._mainFrame=s),s.update(this._minimumRecordTime,e)})}if(e.name===h.DevToolsMetadataEvent.FrameCommittedInBrowser&&this._browserFrameTracking){let s=this._pageFrames.get(t.frame);if(!s){const e=t.parent&&this._pageFrames.get(t.parent);if(!e)return;s=new _(t),this._pageFrames.set(s.frameId,s),e.addChild(s)}return void s.update(e.startTime,t)}if(e.name===h.DevToolsMetadataEvent.ProcessReadyInBrowser&&this._browserFrameTracking){const e=this._pageFrames.get(t.frame);return void(e&&e.processReady(t.processPseudoId,t.processId))}if(e.name===h.DevToolsMetadataEvent.FrameDeletedInBrowser&&this._browserFrameTracking){const s=this._pageFrames.get(t.frame);return void(s&&(s.deletedTime=e.startTime))}}}else{const t=e.args.data.requestId;"string"==typeof t&&this._requestsFromBrowser.set(t,e)}else{const t=e.args.frameTreeNodeId;"number"==typeof t&&t===this._mainFrameNodeId&&e.bind_id&&this._knownInputEvents.add(e.bind_id)}}_ensureNamedTrack(e){if(!this._namedTracks.has(e)){const t=new u;t.type=e,this._tracks.push(t),this._namedTracks.set(e,t)}return this._namedTracks.get(e)}_findAncestorEvent(e){for(let t=this._eventStack.length-1;t>=0;--t){const s=this._eventStack[t];if(s.name===e)return s}return null}_addPageFrame(e,t){const s=t.parent&&this._pageFrames.get(t.parent);if(t.parent&&!s)return!1;const a=new _(t);return this._pageFrames.set(a.frameId,a),a.update(e.startTime,t),s&&s.addChild(a),!0}_reset(){this._isGenericTrace=!1,this._tracks=[],this._namedTracks=new Map,this._inspectedTargetEvents=[],this._timeMarkerEvents=[],this._sessionId=null,this._mainFrameNodeId=null,this._cpuProfiles=[],this._workerIdByThread=new WeakMap,this._pageFrames=new Map,this._mainFrame=null,this._requestsFromBrowser=new Map,this._minimumRecordTime=0,this._maximumRecordTime=0,this._totalBlockingTime=-1,this._estimatedTotalBlockingTime=0}isGenericTrace(){return this._isGenericTrace}tracingModel(){return this._tracingModel}minimumRecordTime(){return this._minimumRecordTime}maximumRecordTime(){return this._maximumRecordTime}inspectedTargetEvents(){return this._inspectedTargetEvents}tracks(){return this._tracks}isEmpty(){return 0===this.minimumRecordTime()&&0===this.maximumRecordTime()}timeMarkerEvents(){return this._timeMarkerEvents}rootFrames(){return Array.from(this._pageFrames.values()).filter(e=>!e.parent)}pageURL(){return this._mainFrame&&this._mainFrame.url||""}pageFrameById(e){return e&&this._pageFrames.get(e)||null}networkRequests(){if(this.isGenericTrace())return[];const e=new Map,t=[],s=[],a=m,r=new Set([a.ResourceWillSendRequest,a.ResourceSendRequest,a.ResourceReceiveResponse,a.ResourceReceivedData,a.ResourceFinish,a.ResourceMarkAsCached]),n=this.inspectedTargetEvents();for(let e=0;e<n.length;++e){const t=n[e];if(!r.has(t.name))continue;const s=h.globalEventId(t,"requestId");t.name===a.ResourceSendRequest&&this._requestsFromBrowser.has(t.args.data.requestId)&&i(this._requestsFromBrowser.get(t.args.data.requestId),s),i(t,s)}function i(a,r){let n=e.get(r);n?n.addEvent(a):(n=new g(a),e.set(r,n),n.startTime?t.push(n):s.push(n))}return s.concat(t)}}const m={Task:"RunTask",Program:"Program",EventDispatch:"EventDispatch",GPUTask:"GPUTask",Animation:"Animation",RequestMainThreadFrame:"RequestMainThreadFrame",BeginFrame:"BeginFrame",NeedsBeginFrameChanged:"NeedsBeginFrameChanged",BeginMainThreadFrame:"BeginMainThreadFrame",ActivateLayerTree:"ActivateLayerTree",DrawFrame:"DrawFrame",HitTest:"HitTest",ScheduleStyleRecalculation:"ScheduleStyleRecalculation",RecalculateStyles:"RecalculateStyles",UpdateLayoutTree:"UpdateLayoutTree",InvalidateLayout:"InvalidateLayout",Layout:"Layout",LayoutShift:"LayoutShift",UpdateLayer:"UpdateLayer",UpdateLayerTree:"UpdateLayerTree",PaintSetup:"PaintSetup",Paint:"Paint",PaintImage:"PaintImage",Rasterize:"Rasterize",RasterTask:"RasterTask",ScrollLayer:"ScrollLayer",CompositeLayers:"CompositeLayers",InteractiveTime:"InteractiveTime",ScheduleStyleInvalidationTracking:"ScheduleStyleInvalidationTracking",StyleRecalcInvalidationTracking:"StyleRecalcInvalidationTracking",StyleInvalidatorInvalidationTracking:"StyleInvalidatorInvalidationTracking",LayoutInvalidationTracking:"LayoutInvalidationTracking",ParseHTML:"ParseHTML",ParseAuthorStyleSheet:"ParseAuthorStyleSheet",TimerInstall:"TimerInstall",TimerRemove:"TimerRemove",TimerFire:"TimerFire",XHRReadyStateChange:"XHRReadyStateChange",XHRLoad:"XHRLoad",CompileScript:"v8.compile",EvaluateScript:"EvaluateScript",CompileModule:"v8.compileModule",EvaluateModule:"v8.evaluateModule",WasmStreamFromResponseCallback:"v8.wasm.streamFromResponseCallback",WasmCompiledModule:"v8.wasm.compiledModule",WasmCachedModule:"v8.wasm.cachedModule",WasmModuleCacheHit:"v8.wasm.moduleCacheHit",WasmModuleCacheInvalid:"v8.wasm.moduleCacheInvalid",FrameStartedLoading:"FrameStartedLoading",CommitLoad:"CommitLoad",MarkLoad:"MarkLoad",MarkDOMContent:"MarkDOMContent",MarkFirstPaint:"firstPaint",MarkFCP:"firstContentfulPaint",MarkLCPCandidate:"largestContentfulPaint::Candidate",MarkLCPInvalidate:"largestContentfulPaint::Invalidate",NavigationStart:"navigationStart",TimeStamp:"TimeStamp",ConsoleTime:"ConsoleTime",UserTiming:"UserTiming",ResourceWillSendRequest:"ResourceWillSendRequest",ResourceSendRequest:"ResourceSendRequest",ResourceReceiveResponse:"ResourceReceiveResponse",ResourceReceivedData:"ResourceReceivedData",ResourceFinish:"ResourceFinish",ResourceMarkAsCached:"ResourceMarkAsCached",RunMicrotasks:"RunMicrotasks",FunctionCall:"FunctionCall",GCEvent:"GCEvent",MajorGC:"MajorGC",MinorGC:"MinorGC",JSFrame:"JSFrame",JSSample:"JSSample",V8Sample:"V8Sample",JitCodeAdded:"JitCodeAdded",JitCodeMoved:"JitCodeMoved",StreamingCompileScript:"v8.parseOnBackground",StreamingCompileScriptWaiting:"v8.parseOnBackgroundWaiting",StreamingCompileScriptParsing:"v8.parseOnBackgroundParsing",V8Execute:"V8.Execute",UpdateCounters:"UpdateCounters",RequestAnimationFrame:"RequestAnimationFrame",CancelAnimationFrame:"CancelAnimationFrame",FireAnimationFrame:"FireAnimationFrame",RequestIdleCallback:"RequestIdleCallback",CancelIdleCallback:"CancelIdleCallback",FireIdleCallback:"FireIdleCallback",WebSocketCreate:"WebSocketCreate",WebSocketSendHandshakeRequest:"WebSocketSendHandshakeRequest",WebSocketReceiveHandshakeResponse:"WebSocketReceiveHandshakeResponse",WebSocketDestroy:"WebSocketDestroy",EmbedderCallback:"EmbedderCallback",SetLayerTreeId:"SetLayerTreeId",TracingStartedInPage:"TracingStartedInPage",TracingSessionIdForWorker:"TracingSessionIdForWorker",DecodeImage:"Decode Image",ResizeImage:"Resize Image",DrawLazyPixelRef:"Draw LazyPixelRef",DecodeLazyPixelRef:"Decode LazyPixelRef",LazyPixelRef:"LazyPixelRef",LayerTreeHostImplSnapshot:"cc::LayerTreeHostImpl",PictureSnapshot:"cc::Picture",DisplayItemListSnapshot:"cc::DisplayItemList",LatencyInfo:"LatencyInfo",LatencyInfoFlow:"LatencyInfo.Flow",InputLatencyMouseMove:"InputLatency::MouseMove",InputLatencyMouseWheel:"InputLatency::MouseWheel",ImplSideFling:"InputHandlerProxy::HandleGestureFling::started",GCCollectGarbage:"BlinkGC.AtomicPhase",CryptoDoEncrypt:"DoEncrypt",CryptoDoEncryptReply:"DoEncryptReply",CryptoDoDecrypt:"DoDecrypt",CryptoDoDecryptReply:"DoDecryptReply",CryptoDoDigest:"DoDigest",CryptoDoDigestReply:"DoDigestReply",CryptoDoSign:"DoSign",CryptoDoSignReply:"DoSignReply",CryptoDoVerify:"DoVerify",CryptoDoVerifyReply:"DoVerifyReply",CpuProfile:"CpuProfile",Profile:"Profile",AsyncTask:"AsyncTask"};h.Category={Console:"blink.console",UserTiming:"blink.user_timing",LatencyInfo:"latencyInfo",Loading:"loading"},h.WarningType={LongTask:"LongTask",ForcedStyle:"ForcedStyle",ForcedLayout:"ForcedLayout",IdleDeadlineExceeded:"IdleDeadlineExceeded",LongHandler:"LongHandler",LongRecurringHandler:"LongRecurringHandler",V8Deopt:"V8Deopt"},h.WorkerThreadName="DedicatedWorker thread",h.WorkerThreadNameLegacy="DedicatedWorker Thread",h.RendererMainThreadName="CrRendererMain",h.BrowserMainThreadName="CrBrowserMain",h.DevToolsMetadataEvent={TracingStartedInBrowser:"TracingStartedInBrowser",TracingStartedInPage:"TracingStartedInPage",TracingSessionIdForWorker:"TracingSessionIdForWorker",FrameCommittedInBrowser:"FrameCommittedInBrowser",ProcessReadyInBrowser:"ProcessReadyInBrowser",FrameDeletedInBrowser:"FrameDeletedInBrowser"},h.Thresholds={LongTask:50,Handler:150,RecurringHandler:50,ForcedLayout:30,IdleCallbackAddon:5};class u{constructor(){this.name="",this.type=p.Other,this.forMainFrame=!1,this.url="",this.events=[],this.asyncEvents=[],this.tasks=[],this._syncEvents=null,this.thread=null}syncEvents(){if(this.events.length)return this.events;if(this._syncEvents)return this._syncEvents;const e=[];this._syncEvents=[];for(const t of this.asyncEvents){const s=t.startTime,a=t.endTime;for(;e.length&&s>=e.peekLast().endTime;)e.pop();if(e.length&&a>e.peekLast().endTime){this._syncEvents=[];break}const n=new r.Event(t.categoriesString,t.name,r.Phase.Complete,s,t.thread);n.setEndTime(a),n.addArgs(t.args),this._syncEvents.push(n),e.push(n)}return this._syncEvents}}const p={MainThread:Symbol("MainThread"),Worker:Symbol("Worker"),Input:Symbol("Input"),Animation:Symbol("Animation"),Timings:Symbol("Timings"),Console:Symbol("Console"),Raster:Symbol("Raster"),GPU:Symbol("GPU"),Experience:Symbol("Experience"),Other:Symbol("Other")};class _{constructor(e){this.frameId=e.frame,this.url=e.url||"",this.name=e.name,this.children=[],this.parent=null,this.processes=[],this.deletedTime=null,this.ownerNode=null}update(e,t){this.url=t.url||"",this.name=t.name,t.processId?this.processes.push({time:e,processId:t.processId,processPseudoId:"",url:t.url||""}):this.processes.push({time:e,processId:-1,processPseudoId:t.processPseudoId,url:t.url||""})}processReady(e,t){for(const s of this.processes)s.processPseudoId===e&&(s.processPseudoId="",s.processId=t)}addChild(e){this.children.push(e),e.parent=this}}class g{constructor(e){const t=m,s=e.name===t.ResourceSendRequest||e.name===t.ResourceWillSendRequest;this.startTime=s?e.startTime:0,this.endTime=1/0,this.encodedDataLength=0,this.decodedBodyLength=0,this.children=[],this.timing,this.mimeType,this.url,this.requestMethod,this._transferSize=0,this._maybeDiskCached=!1,this._memoryCached=!1,this.addEvent(e)}addEvent(e){this.children.push(e);const t=m;this.startTime=Math.min(this.startTime,e.startTime);const s=e.args.data;s.mimeType&&(this.mimeType=s.mimeType),"priority"in s&&(this.priority=s.priority),e.name===t.ResourceFinish&&(this.endTime=e.startTime),s.finishTime&&(this.finishTime=1e3*s.finishTime),this.responseTime||e.name!==t.ResourceReceiveResponse&&e.name!==t.ResourceReceivedData||(this.responseTime=e.startTime);const a=s.encodedDataLength||0;e.name===t.ResourceMarkAsCached&&(this._memoryCached=!0),e.name===t.ResourceReceiveResponse&&(s.fromCache&&(this._maybeDiskCached=!0),s.fromServiceWorker&&(this.fromServiceWorker=!0),s.hasCachedResource&&(this.hasCachedResource=!0),this.encodedDataLength=a),e.name===t.ResourceReceivedData&&(this.encodedDataLength+=a),e.name===t.ResourceFinish&&a&&(this.encodedDataLength=a,this._transferSize=a);const r=s.decodedBodyLength;e.name===t.ResourceFinish&&r&&(this.decodedBodyLength=r),this.url||(this.url=s.url),this.requestMethod||(this.requestMethod=s.requestMethod),this.timing||(this.timing=s.timing),s.fromServiceWorker&&(this.fromServiceWorker=!0)}cached(){return!!this._memoryCached||!!this._maybeDiskCached&&!this._transferSize&&!this.fromServiceWorker}memoryCached(){return this._memoryCached}getSendReceiveTiming(){if(this.cached()||!this.timing)return{sendStartTime:this.startTime,headersEndTime:this.startTime};const e=1e3*this.timing.requestTime;return{sendStartTime:e+this.timing.sendStart,headersEndTime:e+this.timing.receiveHeadersEnd}}getStartTime(){return Math.min(this.startTime,!this.cached()&&this.timing&&1e3*this.timing.requestTime||1/0)}beginTime(){return Math.min(this.getStartTime(),!this.cached()&&this.timing&&1e3*this.timing.pushStart||1/0)}}class T{constructor(e){this.type=e.name,this.startTime=e.startTime,this._tracingEvent=e;const t=e.args.data;this.frame=t.frame,this.nodeId=t.nodeId,this.nodeName=t.nodeName,this.invalidationSet=t.invalidationSet,this.invalidatedSelectorId=t.invalidatedSelectorId,this.changedId=t.changedId,this.changedClass=t.changedClass,this.changedAttribute=t.changedAttribute,this.changedPseudo=t.changedPseudo,this.selectorPart=t.selectorPart,this.extraData=t.extraData,this.invalidationList=t.invalidationList,this.cause={reason:t.reason,stackTrace:t.stackTrace},!this.cause.reason&&this.cause.stackTrace&&this.type===m.LayoutInvalidationTracking&&(this.cause.reason="Layout forced")}}class v{constructor(){this._lastRecalcStyle=null,this._lastPaintWithLayer=null,this._didPaint=!1,this._initializePerFrameState()}static invalidationEventsFor(e){return e[v._invalidationTrackingEventsSymbol]||null}addInvalidation(e){if(this._startNewFrameIfNeeded(),!e.nodeId)return console.error("Invalidation lacks node information."),void console.error(e);const t=m;if(e.type===t.StyleRecalcInvalidationTracking&&"StyleInvalidator"===e.cause.reason)return;if(e.type===t.ScheduleStyleInvalidationTracking||e.type===t.StyleInvalidatorInvalidationTracking||e.type===t.StyleRecalcInvalidationTracking){e.startTime&&this._lastRecalcStyle&&e.startTime>=this._lastRecalcStyle.startTime&&e.startTime<=this._lastRecalcStyle.endTime&&this._associateWithLastRecalcStyleEvent(e)}this._invalidations[e.type]?this._invalidations[e.type].push(e):this._invalidations[e.type]=[e],e.nodeId&&(this._invalidationsByNodeId[e.nodeId]?this._invalidationsByNodeId[e.nodeId].push(e):this._invalidationsByNodeId[e.nodeId]=[e])}didRecalcStyle(e){this._lastRecalcStyle=e;const t=[m.ScheduleStyleInvalidationTracking,m.StyleInvalidatorInvalidationTracking,m.StyleRecalcInvalidationTracking];for(const e of this._invalidationsOfTypes(t))this._associateWithLastRecalcStyleEvent(e)}_associateWithLastRecalcStyleEvent(e){if(e.linkedRecalcStyleEvent)return;const t=m,s=this._lastRecalcStyle.args.beginData.frame;e.type===t.StyleInvalidatorInvalidationTracking?this._addSyntheticStyleRecalcInvalidations(this._lastRecalcStyle,s,e):e.type===t.ScheduleStyleInvalidationTracking||this._addInvalidationToEvent(this._lastRecalcStyle,s,e),e.linkedRecalcStyleEvent=!0}_addSyntheticStyleRecalcInvalidations(e,t,s){if(s.invalidationList){if(!s.nodeId)return console.error("Invalidation lacks node information."),void console.error(s);for(let e=0;e<s.invalidationList.length;e++){const a=s.invalidationList[e].id;let r;const n=this._invalidationsByNodeId[s.nodeId]||[];for(let e=0;e<n.length;e++){const s=n[e];s.frame===t&&s.invalidationSet===a&&s.type===m.ScheduleStyleInvalidationTracking&&(r=s)}r?this._addSyntheticStyleRecalcInvalidation(r._tracingEvent,s):console.error("Failed to lookup the event that scheduled a style invalidator invalidation.")}}else this._addSyntheticStyleRecalcInvalidation(s._tracingEvent,s)}_addSyntheticStyleRecalcInvalidation(e,t){const s=new T(e);s.type=m.StyleRecalcInvalidationTracking,t.cause.reason&&(s.cause.reason=t.cause.reason),t.selectorPart&&(s.selectorPart=t.selectorPart),this.addInvalidation(s),s.linkedRecalcStyleEvent||this._associateWithLastRecalcStyleEvent(s)}didLayout(e){const t=e.args.beginData.frame;for(const s of this._invalidationsOfTypes([m.LayoutInvalidationTracking]))s.linkedLayoutEvent||(this._addInvalidationToEvent(e,t,s),s.linkedLayoutEvent=!0)}didPaint(e){this._didPaint=!0}_addInvalidationToEvent(e,t,s){t===s.frame&&(e[v._invalidationTrackingEventsSymbol]?e[v._invalidationTrackingEventsSymbol].push(s):e[v._invalidationTrackingEventsSymbol]=[s])}_invalidationsOfTypes(e){const t=this._invalidations;return e||(e=Object.keys(t)),function*(){for(let s=0;s<e.length;++s){const a=t[e[s]]||[];for(let e=0;e<a.length;++e)yield a[e]}}()}_startNewFrameIfNeeded(){this._didPaint&&this._initializePerFrameState()}_initializePerFrameState(){this._invalidations={},this._invalidationsByNodeId={},this._lastRecalcStyle=null,this._lastPaintWithLayer=null,this._didPaint=!1}}v._invalidationTrackingEventsSymbol=Symbol("invalidationTrackingEvents");class f{constructor(){f._initialize(),this._initiatorByType=new Map;for(const e of f._asyncEvents.keys())this._initiatorByType.set(e,new Map)}static _initialize(){if(f._asyncEvents)return;const e=new Map;let t=m;e.set(t.TimerInstall,{causes:[t.TimerFire],joinBy:"timerId"}),e.set(t.ResourceSendRequest,{causes:[t.ResourceMarkAsCached,t.ResourceReceiveResponse,t.ResourceReceivedData,t.ResourceFinish],joinBy:"requestId"}),e.set(t.RequestAnimationFrame,{causes:[t.FireAnimationFrame],joinBy:"id"}),e.set(t.RequestIdleCallback,{causes:[t.FireIdleCallback],joinBy:"id"}),e.set(t.WebSocketCreate,{causes:[t.WebSocketSendHandshakeRequest,t.WebSocketReceiveHandshakeResponse,t.WebSocketDestroy],joinBy:"identifier"}),f._asyncEvents=e,f._typeToInitiator=new Map;for(const s of e){const e=s[1].causes;for(t of e)f._typeToInitiator.set(t,s[0])}}processEvent(e){let t=f._typeToInitiator.get(e.name);const s=!t;t||(t=e.name);const a=f._asyncEvents.get(t);if(!a)return;const r=h.globalEventId(e,a.joinBy);if(!r)return;const n=this._initiatorByType.get(t);if(s)return void n.set(r,e);const i=n.get(r)||null,o=y.forEvent(e);o.setInitiator(i),!o.frameId&&i&&(o.frameId=h.eventFrameId(i))}}class y{constructor(){this.warning=null,this.previewElement=null,this.url=null,this.backendNodeId=0,this.stackTrace=null,this.picture=null,this._initiator=null,this.frameId="",this.timeWaitingForMainThread}setInitiator(e){if(this._initiator=e,!e||this.url)return;const t=y.forEvent(e).url;t&&(this.url=t)}initiator(){return this._initiator}topFrame(){const e=this.stackTraceForSelfOrInitiator();return e&&e[0]||null}stackTraceForSelfOrInitiator(){return this.stackTrace||this._initiator&&y.forEvent(this._initiator).stackTrace}static forEvent(e){let t=e[y._symbol];return t||(t=new y,e[y._symbol]=t),t}}y._symbol=Symbol("timelineData");var I=Object.freeze({__proto__:null,TimelineModelImpl:h,RecordType:m,Track:u,TrackType:p,PageFrame:_,NetworkRequest:g,InvalidationTrackingEvent:T,InvalidationTracker:v,TimelineAsyncEventTracker:f,TimelineData:y,InvalidationCause:void 0,MetadataEvents:void 0});class k{accept(e){return!0}}class S extends k{constructor(e){super(),this._visibleTypes=new Set(e)}accept(e){return this._visibleTypes.has(S._eventType(e))}static _eventType(e){return e.hasCategory(h.Category.Console)?m.ConsoleTime:e.hasCategory(h.Category.UserTiming)?m.UserTiming:e.hasCategory(h.Category.LatencyInfo)?m.LatencyInfo:e.name}}var F=Object.freeze({__proto__:null,TimelineModelFilter:k,TimelineVisibleEventsFilter:S,TimelineInvisibleEventsFilter:class extends k{constructor(e){super(),this._invisibleTypes=new Set(e)}accept(e){return!this._invisibleTypes.has(S._eventType(e))}},ExclusiveNameFilter:class extends k{constructor(e){super(),this._excludeNames=new Set(e)}accept(e){return!this._excludeNames.has(e.name)}}});class R extends o.LayerTreeBase{constructor(e){super(e),this._tileById=new Map,this._paintProfilerModel=e&&e.model(l.PaintProfilerModel)}async setLayers(e,t,s){const a=new Set;if(e)this._extractNodeIdsToResolve(a,{},e);else for(let e=0;e<t.length;++e)this._extractNodeIdsToResolve(a,{},t[e]);await this.resolveBackendNodeIds(a);const r=this.layersById;if(this.layersById=new Map,this.setContentRoot(null),e){const t=this._innerSetLayers(r,e);this.setRoot(t)}else{const e=t.map(this._innerSetLayers.bind(this,r)),s=this.contentRoot();this.setRoot(s);for(let t=0;t<e.length;++t)e[t].id()!==s.id()&&s.addChild(e[t])}this._setPaints(s)}setTiles(e){this._tileById=new Map;for(const t of e)this._tileById.set(t.id,t)}pictureForRasterTile(e){const s=this._tileById.get("cc::Tile/"+e);if(!s)return t.Console.instance().error(`Tile ${e} is missing`),Promise.resolve(null);const a=this.layerById(s.layer_id);return a?a._pictureForRect(s.content_rect):(t.Console.instance().error(`Layer ${s.layer_id} for tile ${e} is not found`),Promise.resolve(null))}_setPaints(e){for(let t=0;t<e.length;++t){const s=this.layersById.get(e[t].layerId());s&&s._addPaintEvent(e[t])}}_innerSetLayers(e,t){let s=e.get(t.layer_id);s?s._reset(t):s=new E(this._paintProfilerModel,t),this.layersById.set(t.layer_id,s),t.owner_node&&s._setNode(this.backendNodeIdToNode().get(t.owner_node)||null),!this.contentRoot()&&s.drawsContent()&&this.setContentRoot(s);for(let a=0;t.children&&a<t.children.length;++a)s.addChild(this._innerSetLayers(e,t.children[a]));return s}_extractNodeIdsToResolve(e,t,s){const a=s.owner_node;a&&!this.backendNodeIdToNode().has(a)&&e.add(a);for(let a=0;s.children&&a<s.children.length;++a)this._extractNodeIdsToResolve(e,t,s.children[a])}}class E{constructor(e,t){this._paintProfilerModel=e,this._reset(t)}_reset(e){this._node=null,this._layerId=String(e.layer_id),this._offsetX=e.position[0],this._offsetY=e.position[1],this._width=e.bounds.width,this._height=e.bounds.height,this._children=[],this._parentLayerId=null,this._parent=null,this._quad=e.layer_quad||[],this._createScrollRects(e),this._compositingReasonIds=e.compositing_reason_ids||e.debug_info&&e.debug_info.compositing_reason_ids||[],this._drawsContent=!!e.draws_content,this._gpuMemoryUsage=e.gpu_memory_usage,this._paints=[]}id(){return this._layerId}parentId(){return this._parentLayerId}parent(){return this._parent}isRoot(){return!this.parentId()}children(){return this._children}addChild(e){const t=e;t._parent&&console.assert(!1,"Child already has a parent"),this._children.push(t),t._parent=this,t._parentLayerId=this._layerId}_setNode(e){this._node=e}node(){return this._node}nodeForSelfOrAncestor(){for(let e=this;e;e=e._parent)if(e._node)return e._node;return null}offsetX(){return this._offsetX}offsetY(){return this._offsetY}width(){return this._width}height(){return this._height}transform(){return null}quad(){return this._quad}anchorPoint(){return[.5,.5,0]}invisible(){return!1}paintCount(){return 0}lastPaintRect(){return null}scrollRects(){return this._scrollRects}stickyPositionConstraint(){return null}gpuMemoryUsage(){return this._gpuMemoryUsage}snapshots(){return this._paints.map(e=>e.snapshotPromise().then(e=>{if(!e)return null;return{rect:{x:e.rect[0],y:e.rect[1],width:e.rect[2],height:e.rect[3]},snapshot:e.snapshot}}))}_pictureForRect(e){return Promise.all(this._paints.map(e=>e.picturePromise())).then(s=>{const a=s.filter(s=>{return s&&(a=s.rect,r=e,t(a[0],a[0]+a[2],r[0],r[0]+r[2])&&t(a[1],a[1]+a[3],r[1],r[1]+r[3]));var a,r}).map(e=>({x:e.rect[0],y:e.rect[1],picture:e.serializedPicture}));if(!a.length||!this._paintProfilerModel)return null;const r=a.reduce((e,t)=>Math.min(e,t.x),1/0),n=a.reduce((e,t)=>Math.min(e,t.y),1/0),i={x:e[0]-r,y:e[1]-n,width:e[2],height:e[3]};return this._paintProfilerModel.loadSnapshotFromFragments(a).then(e=>e?{rect:i,snapshot:e}:null)});function t(e,t,s,a){return console.assert(e<=t&&s<=a,"segments should be specified as ordered pairs"),t>s&&e<a}}_scrollRectsFromParams(e,t){return{rect:{x:e[0],y:e[1],width:e[2],height:e[3]},type:t}}_createScrollRects(e){this._scrollRects=[],e.non_fast_scrollable_region&&this._scrollRects.push(this._scrollRectsFromParams(e.non_fast_scrollable_region,o.Layer.ScrollRectType.NonFastScrollable.name)),e.touch_event_handler_region&&this._scrollRects.push(this._scrollRectsFromParams(e.touch_event_handler_region,o.Layer.ScrollRectType.TouchEventHandler.name)),e.wheel_event_handler_region&&this._scrollRects.push(this._scrollRectsFromParams(e.wheel_event_handler_region,o.Layer.ScrollRectType.WheelEventHandler.name)),e.scroll_event_handler_region&&this._scrollRects.push(this._scrollRectsFromParams(e.scroll_event_handler_region,o.Layer.ScrollRectType.RepaintsOnScroll.name))}_addPaintEvent(e){this._paints.push(e)}requestCompositingReasonIds(){return Promise.resolve(this._compositingReasonIds)}drawsContent(){return this._drawsContent}}var C=Object.freeze({__proto__:null,TracingLayerTree:R,TracingLayer:E,TracingLayerPayload:void 0,TracingLayerTile:void 0});class P{constructor(){this.reset()}static phaseForEvent(e){return e[P._eventIRPhase]}populate(e,t){if(this.reset(),!e)return;this._processInputLatencies(e),t&&this._processAnimations(t);const a=new s.SegmentedRange;a.appendRange(this._drags),a.appendRange(this._cssAnimations),a.appendRange(this._scrolls),a.appendRange(this._responses),this._segments=a.segments()}_processInputLatencies(e){const s=L,r=M,n=P._mergeThresholdsMs;let i,o,l,c,d,h,m;for(let g=0;g<e.length;++g){const T=e[g];g>0&&e[g].startTime<e[g-1].startTime&&console.assert(!1,"Unordered input events");switch(this._inputEventType(T.name)){case s.ScrollBegin:this._scrolls.append(this._segmentForEvent(T,r.Scroll)),i=T;break;case s.ScrollEnd:i?this._scrolls.append(this._segmentForEventRange(i,T,r.Scroll)):this._scrolls.append(this._segmentForEvent(T,r.Scroll)),i=null;break;case s.ScrollUpdate:l=null,this._scrolls.append(this._segmentForEvent(T,r.Scroll));break;case s.FlingStart:if(o){t.Console.instance().error(a.UIString("Two flings at the same time? %s vs %s",o.startTime,T.startTime));break}o=T;break;case s.FlingCancel:if(!o)break;this._scrolls.append(this._segmentForEventRange(o,T,r.Fling)),o=null;break;case s.ImplSideFling:this._scrolls.append(this._segmentForEvent(T,r.Fling));break;case s.ShowPress:case s.Tap:case s.KeyDown:case s.KeyDownRaw:case s.KeyUp:case s.Char:case s.Click:case s.ContextMenu:this._responses.append(this._segmentForEvent(T,r.Response));break;case s.TouchStart:if(l){t.Console.instance().error(a.UIString("Two touches at the same time? %s vs %s",l.startTime,T.startTime));break}l=T,T.steps[0][P._eventIRPhase]=r.Response,c=null;break;case s.TouchCancel:l=null;break;case s.TouchMove:c?this._drags.append(this._segmentForEvent(T,r.Drag)):l&&(c=T,this._responses.append(this._segmentForEventRange(l,T,r.Response)));break;case s.TouchEnd:l=null;break;case s.MouseDown:h=T,m=null;break;case s.MouseMove:h&&!m&&h.startTime+n.mouse>T.startTime?(this._responses.append(this._segmentForEvent(h,r.Response)),this._responses.append(this._segmentForEvent(T,r.Response))):h&&this._drags.append(this._segmentForEvent(T,r.Drag)),m=T;break;case s.MouseUp:this._responses.append(this._segmentForEvent(T,r.Response)),h=null;break;case s.MouseWheel:d&&(u=n.mouse,_=T,(p=d).endTime<_.startTime&&_.startTime<p.endTime+u)?this._scrolls.append(this._segmentForEventRange(d,T,r.Scroll)):this._scrolls.append(this._segmentForEvent(T,r.Scroll)),d=T}}var u,p,_}_processAnimations(e){for(let t=0;t<e.length;++t)this._cssAnimations.append(this._segmentForEvent(e[t],M.Animation))}_segmentForEvent(e,t){return this._setPhaseForEvent(e,t),new s.Segment(e.startTime,e.endTime,t)}_segmentForEventRange(e,t,a){return this._setPhaseForEvent(e,a),this._setPhaseForEvent(t,a),new s.Segment(e.startTime,t.endTime,a)}_setPhaseForEvent(e,t){e.steps[0][P._eventIRPhase]=t}interactionRecords(){return this._segments}reset(){const e=P._mergeThresholdsMs;function t(e,t,s){return t.end+e>=s.begin&&t.data===s.data?t:null}this._segments=[],this._drags=new s.SegmentedRange(t.bind(null,e.mouse)),this._cssAnimations=new s.SegmentedRange(t.bind(null,e.animation)),this._responses=new s.SegmentedRange(t.bind(null,0)),this._scrolls=new s.SegmentedRange(t.bind(null,e.animation))}_inputEventType(e){return e.startsWith("InputLatency::")?e.substr("InputLatency::".length):e===L.ImplSideFling?e:(console.error("Unrecognized input latency event: "+e),null)}}const M={Idle:"Idle",Response:"Response",Scroll:"Scroll",Fling:"Fling",Drag:"Drag",Animation:"Animation",Uncategorized:"Uncategorized"},L={Char:"Char",Click:"GestureClick",ContextMenu:"ContextMenu",FlingCancel:"GestureFlingCancel",FlingStart:"GestureFlingStart",ImplSideFling:m.ImplSideFling,KeyDown:"KeyDown",KeyDownRaw:"RawKeyDown",KeyUp:"KeyUp",LatencyScrollUpdate:"ScrollUpdate",MouseDown:"MouseDown",MouseMove:"MouseMove",MouseUp:"MouseUp",MouseWheel:"MouseWheel",PinchBegin:"GesturePinchBegin",PinchEnd:"GesturePinchEnd",PinchUpdate:"GesturePinchUpdate",ScrollBegin:"GestureScrollBegin",ScrollEnd:"GestureScrollEnd",ScrollUpdate:"GestureScrollUpdate",ScrollUpdateRenderer:"ScrollUpdate",ShowPress:"GestureShowPress",Tap:"GestureTap",TapCancel:"GestureTapCancel",TapDown:"GestureTapDown",TouchCancel:"TouchCancel",TouchEnd:"TouchEnd",TouchMove:"TouchMove",TouchStart:"TouchStart"};P._mergeThresholdsMs={animation:1,mouse:40},P._eventIRPhase=Symbol("eventIRPhase");var b=Object.freeze({__proto__:null,TimelineIRModel:P,Phases:M,InputEvents:L});class w{constructor(e){this._categoryMapper=e,this.reset()}frames(e,t){if(!e&&!t)return this._frames;const s=this._frames.lowerBound(e||0,(e,t)=>e-t.endTime),a=this._frames.lowerBound(t||1/0,(e,t)=>e-t.startTime);return this._frames.slice(s,a)}hasRasterTile(e){const t=e.args.tileData;if(!t)return!1;const s=t.sourceFrameNumber,a=s&&this._frameById[s];return!(!a||!a.layerTree)}rasterTilePromise(e){if(!this._target)return Promise.resolve(null);const t=e.args.tileData,s=t.sourceFrameNumber,a=t.tileId&&t.tileId.id_ref,r=s&&this._frameById[s];return r&&r.layerTree&&a?r.layerTree.layerTreePromise().then(e=>e&&e.pictureForRasterTile(a)):Promise.resolve(null)}reset(){this._minimumRecordTime=1/0,this._frames=[],this._frameById={},this._lastFrame=null,this._lastLayerTree=null,this._mainFrameCommitted=!1,this._mainFrameRequested=!1,this._framePendingCommit=null,this._lastBeginFrame=null,this._lastNeedsBeginFrame=null,this._framePendingActivation=null,this._lastTaskBeginTime=null,this._target=null,this._layerTreeId=null,this._currentTaskTimeByCategory={}}handleBeginFrame(e){this._lastFrame||this._startFrame(e),this._lastBeginFrame=e}handleDrawFrame(e){if(this._lastFrame){if(this._mainFrameCommitted||!this._mainFrameRequested){if(this._lastNeedsBeginFrame){const e=this._framePendingActivation?this._framePendingActivation.triggerTime:this._lastBeginFrame||this._lastNeedsBeginFrame;e>this._lastFrame.startTime&&(this._lastFrame.idle=!0,this._startFrame(e),this._framePendingActivation&&this._commitPendingFrame(),this._lastBeginFrame=null),this._lastNeedsBeginFrame=null}this._startFrame(e)}this._mainFrameCommitted=!1}else this._startFrame(e)}handleActivateLayerTree(){this._lastFrame&&this._framePendingActivation&&!this._lastNeedsBeginFrame&&this._commitPendingFrame()}handleRequestMainThreadFrame(){this._lastFrame&&(this._mainFrameRequested=!0)}handleCompositeLayers(){this._framePendingCommit&&(this._framePendingActivation=this._framePendingCommit,this._framePendingCommit=null,this._mainFrameRequested=!1,this._mainFrameCommitted=!0)}handleLayerTreeSnapshot(e){this._lastLayerTree=e}handleNeedFrameChanged(e,t){t&&(this._lastNeedsBeginFrame=e)}_startFrame(e){this._lastFrame&&this._flushFrame(this._lastFrame,e),this._lastFrame=new D(e,e-this._minimumRecordTime)}_flushFrame(e,t){e._setLayerTree(this._lastLayerTree),e._setEndTime(t),this._lastLayerTree&&this._lastLayerTree._setPaints(e._paints),this._frames.length&&(e.startTime!==this._frames.peekLast().endTime||e.startTime>e.endTime)&&console.assert(!1,`Inconsistent frame time for frame ${this._frames.length} (${e.startTime} - ${e.endTime})`),this._frames.push(e),"number"==typeof e._mainFrameId&&(this._frameById[e._mainFrameId]=e)}_commitPendingFrame(){this._lastFrame._addTimeForCategories(this._framePendingActivation.timeByCategory),this._lastFrame._paints=this._framePendingActivation.paints,this._lastFrame._mainFrameId=this._framePendingActivation.mainFrameId,this._framePendingActivation=null}addTraceEvents(e,t,s){this._target=e;let a=0;this._currentProcessMainThread=s.length&&s[0].thread||null;for(let e=0;e<t.length;++e){for(;a+1<s.length&&s[a+1].time<=t[e].startTime;)this._currentProcessMainThread=s[++a].thread;this._addTraceEvent(t[e])}this._currentProcessMainThread=null}_addTraceEvent(e){const t=m;if(e.startTime&&e.startTime<this._minimumRecordTime&&(this._minimumRecordTime=e.startTime),e.name===t.SetLayerTreeId)this._layerTreeId=e.args.layerTreeId||e.args.data.layerTreeId;else if(e.phase===r.Phase.SnapshotObject&&e.name===t.LayerTreeHostImplSnapshot&&parseInt(e.id,0)===this._layerTreeId){const t=e;this.handleLayerTreeSnapshot(new N(this._target,t))}else this._processCompositorEvents(e),e.thread===this._currentProcessMainThread?this._addMainThreadTraceEvent(e):this._lastFrame&&e.selfTime&&!r.TracingModel.isTopLevelEvent(e)&&this._lastFrame._addTimeForCategory(this._categoryMapper(e),e.selfTime)}_processCompositorEvents(e){const t=m;if(e.args.layerTreeId!==this._layerTreeId)return;const s=e.startTime;e.name===t.BeginFrame?this.handleBeginFrame(s):e.name===t.DrawFrame?this.handleDrawFrame(s):e.name===t.ActivateLayerTree?this.handleActivateLayerTree():e.name===t.RequestMainThreadFrame?this.handleRequestMainThreadFrame():e.name===t.NeedsBeginFrameChanged&&this.handleNeedFrameChanged(s,e.args.data&&e.args.data.needsBeginFrame)}_addMainThreadTraceEvent(e){const t=m;r.TracingModel.isTopLevelEvent(e)&&(this._currentTaskTimeByCategory={},this._lastTaskBeginTime=e.startTime),!this._framePendingCommit&&w._mainFrameMarkers.indexOf(e.name)>=0&&(this._framePendingCommit=new A(this._lastTaskBeginTime||e.startTime,this._currentTaskTimeByCategory)),this._framePendingCommit?(this._addTimeForCategory(this._framePendingCommit.timeByCategory,e),e.name===t.BeginMainThreadFrame&&e.args.data&&e.args.data.frameId&&(this._framePendingCommit.mainFrameId=e.args.data.frameId),e.name===t.Paint&&e.args.data.layerId&&y.forEvent(e).picture&&this._target&&this._framePendingCommit.paints.push(new B(e,this._target)),e.name===t.CompositeLayers&&e.args.layerTreeId===this._layerTreeId&&this.handleCompositeLayers()):this._addTimeForCategory(this._currentTaskTimeByCategory,e)}_addTimeForCategory(e,t){if(!t.selfTime)return;const s=this._categoryMapper(t);e[s]=(e[s]||0)+t.selfTime}}w._mainFrameMarkers=[m.ScheduleStyleRecalculation,m.InvalidateLayout,m.BeginMainThreadFrame,m.ScrollLayer];class N{constructor(e,t){this._target=e,this._snapshot=t,this._paints}async layerTreePromise(){const e=await this._snapshot.objectPromise();if(!e)return null;const t=e.device_viewport_size,s=e.active_tiles,a=e.active_tree.root_layer,r=e.active_tree.layers,n=new R(this._target);return n.setViewportSize(t),n.setTiles(s),await n.setLayers(a,r,this._paints||[]),n}paints(){return this._paints||[]}_setPaints(e){this._paints=e}}class D{constructor(e,t){this.startTime=e,this.startTimeOffset=t,this.endTime=this.startTime,this.duration=0,this.timeByCategory={},this.cpuTime=0,this.idle=!1,this.layerTree=null,this._paints=[],this._mainFrameId=void 0}hasWarnings(){return!1}_setEndTime(e){this.endTime=e,this.duration=this.endTime-this.startTime}_setLayerTree(e){this.layerTree=e}_addTimeForCategories(e){for(const t in e)this._addTimeForCategory(t,e[t])}_addTimeForCategory(e,t){this.timeByCategory[e]=(this.timeByCategory[e]||0)+t,this.cpuTime+=t}}class B{constructor(e,t){this._event=e,this._target=t}layerId(){return this._event.args.data.layerId}event(){return this._event}picturePromise(){return y.forEvent(this._event).picture.objectPromise().then(e=>{if(!e)return null;const t=e.params&&e.params.layer_rect,s=e.skp64;return t&&s?{rect:t,serializedPicture:s}:null})}snapshotPromise(){const e=this._target&&this._target.model(l.PaintProfilerModel);return this.picturePromise().then(t=>t&&e?e.loadSnapshot(t.serializedPicture).then(e=>e?{rect:t.rect,snapshot:e}:null):null)}}class A{constructor(e,t){this.timeByCategory=t,this.paints=[],this.mainFrameId=void 0,this.triggerTime=e}}var W=Object.freeze({__proto__:null,TimelineFrameModel:w,TracingFrameLayerTree:N,TimelineFrame:D,LayerPaintEvent:B,PendingFrame:A});class x{constructor(e,t){this.totalTime=0,this.selfTime=0,this.id=e,this.event=t,this.parent,this._groupId="",this._isGroupNode=!1}isGroupNode(){return this._isGroupNode}hasChildren(){throw"Not implemented"}children(){throw"Not implemented"}searchTree(e,t){t=t||[],this.event&&e(this.event)&&t.push(this);for(const s of this.children().values())s.searchTree(e,t);return t}}class G extends x{constructor(e,t,s){super(e,t),this._root=s&&s._root,this._hasChildren=!1,this._children=null,this.parent=s}hasChildren(){return this._hasChildren}children(){return this._children||this._buildChildren()}_buildChildren(){const e=[];for(let t=this;t.parent&&!t._isGroupNode;t=t.parent)e.push(t);e.reverse();const t=new Map,s=this,a=this._root,r=a._startTime,n=a._endTime,i=a._doNotAggregate?function(t){++c,d===e.length&&c<=e.length+2&&u(t,0);--c}:void 0,o=a._doNotAggregate?void 0:H,l=a._eventGroupIdCallback;let c=0,d=0,m=null;function u(a,r){if(c===e.length+2)return m._hasChildren=!0,void(m.selfTime-=r);let n,i="";o?(n=o(a),i=l?l(a):"",i&&(n+="/"+i)):n=Symbol("uniqueId");let d=t.get(n);d||(d=new G(n,a,s),d._groupId=i,t.set(n,d)),d.selfTime+=r,d.totalTime+=r,m=d}return h.forEachEvent(a._events,(function(t){if(++c,c>e.length+2)return;if(!function(t){if(d===e.length)return!0;if(d!==c-1)return!1;if(!t.endTime)return!1;if(!o)return t===e[d].event&&++d,!1;let s=o(t);const a=l?l(t):"";a&&(s+="/"+a);s===e[d].id&&++d;return!1}(t))return;const s=Math.min(n,t.endTime)-Math.max(r,t.startTime);s<0&&console.error("Negative event duration");u(t,s)}),(function(e){--c,d>c&&(d=c)}),i,r,n,a._filter),this._children=t,t}}class U extends x{constructor(e,t,s){super(e,s),this._children=new Map,this.parent=t,this._isGroupNode=!0}addChild(e,t,s){this._children.set(e.id,e),this.selfTime+=t,this.totalTime+=s,e.parent=this}hasChildren(){return!0}children(){return this._children}}class q extends x{constructor(e,t,s,a,r){super(t,s),this.parent=r,this._root=e,this._depth=(r._depth||0)+1,this._cachedChildren=null,this._hasChildren=a}setHasChildren(){this._hasChildren=!0}hasChildren(){return this._hasChildren}children(){if(this._cachedChildren)return this._cachedChildren;const e=[0],t=[],s=[],a=new Map,r=this._root._startTime,n=this._root._endTime;let i=r;const o=this;return h.forEachEvent(this._root._events,(function(a){const i=Math.min(a.endTime,n)-Math.max(a.startTime,r);i<0&&console.assert(!1,"Negative duration of an event");e[e.length-1]-=i,e.push(i);const o=H(a);t.push(o),s.push(a)}),(function(r){const l=e.pop(),c=t.pop();let d;for(s.pop(),d=o;d._depth>1;d=d.parent)if(d.id!==t[t.length+1-d._depth])return;if(d.id!==c||t.length<o._depth)return;const h=t[t.length-o._depth];if(d=a.get(h),!d){const e=s[s.length-o._depth],t=s.length>o._depth;d=new q(o._root,h,e,t,o),a.set(h,d)}const m=Math.min(r.endTime,n)-Math.max(r.startTime,i);d.selfTime+=l,d.totalTime+=m,i=Math.min(r.endTime,n)}),void 0,r,n,this._root._filter),this._cachedChildren=this._root._filterChildren(a),this._cachedChildren}searchTree(e,t){return t=t||[],this.event&&e(this.event)&&t.push(this),t}}function z(e){return e.name===m.JSFrame?e.args.data||null:y.forEvent(e).topFrame()}function H(e){if(e.name===m.TimeStamp)return`${e.name}:${e.args.data.message}`;if(e.name!==m.JSFrame)return e.name;const t=e.args.data,s=t.scriptId||t.url||"",a=t.functionName;return`f:${c.isNativeRuntimeFrame(t)?c.nativeGroup(a)||a:`${a}:${t.lineNumber}:${t.columnNumber}`}@${s}`}var O=Object.freeze({__proto__:null,Node:x,TopDownNode:G,TopDownRootNode:class extends G{constructor(e,t,s,a,r,n){super("",null,null),this._root=this,this._events=e,this._filter=e=>t.every(t=>t.accept(e)),this._startTime=s,this._endTime=a,this._eventGroupIdCallback=n,this._doNotAggregate=r,this.totalTime=a-s,this.selfTime=this.totalTime}children(){return this._children||this._grouppedTopNodes()}_grouppedTopNodes(){const e=super.children();for(const t of e.values())this.selfTime-=t.totalTime;if(!this._eventGroupIdCallback)return e;const t=new Map;for(const s of e.values()){const e=this._eventGroupIdCallback(s.event);let a=t.get(e);a||(a=new U(e,this,s.event),t.set(e,a)),a.addChild(s,s.selfTime,s.totalTime)}return this._children=t,t}},BottomUpRootNode:class extends x{constructor(e,t,s,a,r,n){super("",null),this._children=null,this._events=e,this._textFilter=t,this._filter=e=>s.every(t=>t.accept(e)),this._startTime=a,this._endTime=r,this._eventGroupIdCallback=n,this.totalTime=r-a}hasChildren(){return!0}_filterChildren(e){for(const[t,s]of e)s.event&&!this._textFilter.accept(s.event)&&e.delete(t);return e}children(){return this._children||(this._children=this._filterChildren(this._grouppedTopNodes())),this._children}_ungrouppedTopNodes(){const e=this,t=this._startTime,s=this._endTime,a=new Map,r=[s-t],n=[],i=new Map;h.forEachEvent(this._events,(function(e){const a=Math.min(e.endTime,s)-Math.max(e.startTime,t);r[r.length-1]-=a,r.push(a);const o=H(e),l=!i.has(o);l&&i.set(o,a);n.push(l)}),(function(t){const s=H(t);let o=a.get(s);o||(o=new q(e,s,t,!1,e),a.set(s,o));o.selfTime+=r.pop(),n.pop()&&(o.totalTime+=i.get(s),i.delete(s));n.length&&o.setHasChildren()}),void 0,t,s,this._filter),this.selfTime=r.pop();for(const e of a)e[1].selfTime<=0&&a.delete(e[0]);return a}_grouppedTopNodes(){const e=this._ungrouppedTopNodes();if(!this._eventGroupIdCallback)return e;const t=new Map;for(const s of e.values()){const e=this._eventGroupIdCallback(s.event);let a=t.get(e);a||(a=new U(e,this,s.event),t.set(e,a)),a.addChild(s,s.selfTime,s.selfTime)}return t}},GroupNode:U,BottomUpNode:q,eventURL:function(e){const t=e.args.data||e.args.beginData;if(t&&t.url)return t.url;let s=z(e);for(;s;){const e=s.url;if(e)return e;s=s.parent}return null},eventStackFrame:z,_eventId:H,ChildrenCache:void 0});export{W as TimelineFrameModel,b as TimelineIRModel,d as TimelineJSProfile,I as TimelineModel,F as TimelineModelFilter,O as TimelineProfileTree,C as TracingLayerTree};
